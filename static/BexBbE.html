<!DOCTYPE html>
<!-- saved from url=(0156)https://codepen.io/MillerTime/embed/BexBbE?height=420&theme-id=dark&default-tab=js%2Cresult&user=MillerTime&slug-hash=BexBbE&pen-title=Menja&name=cp_embed_1 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width">
<title>CodePen Embed - Menja</title>
<meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="q+dneAzGehfz4Myy1e3NhP7mQb8dimBd4lbZ64o8ECAm5/jZup8uRgxFDb8cgCQMBXMFFFY2FXWnjhrzixrjRQ==">
<link rel="stylesheet" media="all" href="./embed-1381bc37a8f96675cd4d5f734c40ac9d8efa7503e39ad83730639e30848e7ae9.css">
<style>
    .hide {
      display: none !important;
    }

    .embed-footer,
    .embed-nav {
      background: #111111;
      
    }
    .embed-nav .code-types a,
    .embed-nav .result-button-list a,
    .action-button {
      color: #eeeeee;
      background-color: #333333;
    }
    .embed-nav .code-types a.active,
    .embed-nav .result-button-list a.active,
    .action-button.active {
      background: #555555;
      color: #eeeeee;
      box-shadow: inset 0px 3px #797979;
    }
    .embed-nav .logo-wrap a {
      color: #eeeeee;
    }

    .embed-nav svg {
      stroke: #eeeeee !important;
    }
  </style>
<link rel="stylesheet" media="all" href="./twilight-86b2d8d64ce08f901b8946aeefde8b37185c1b1699748e443c7040ab6fc223e4.css">
</head>
<body id="the-body" style="border: 1px solid #666666; --borderWidth: 1px;" class="codepen-embed-body split-output static results-active">
<nav class="embed-nav group" id="embed-nav">
<ul class="code-types">
<li class="code-type">
<a id="html-link" href="https://codepen.io/MillerTime/embed/BexBbE?height=420&amp;theme-id=dark&amp;default-tab=js%2Cresult&amp;user=MillerTime&amp;slug-hash=BexBbE&amp;pen-title=Menja&amp;name=cp_embed_1#html-box" aria-pressed="false" role="button">
HTML
</a>
</li>
<li class="code-type">
<a id="css-link" href="https://codepen.io/MillerTime/embed/BexBbE?height=420&amp;theme-id=dark&amp;default-tab=js%2Cresult&amp;user=MillerTime&amp;slug-hash=BexBbE&amp;pen-title=Menja&amp;name=cp_embed_1#css-box" aria-pressed="false" role="button">
CSS
</a>
</li>
<li class="code-type">
<a id="js-link" href="https://codepen.io/MillerTime/embed/BexBbE?height=420&amp;theme-id=dark&amp;default-tab=js%2Cresult&amp;user=MillerTime&amp;slug-hash=BexBbE&amp;pen-title=Menja&amp;name=cp_embed_1#js-box" class="active" aria-pressed="true" role="button">
JS
</a>
</li>
</ul>
<ul class="result-button-list">
<li class="results results-type">
<a id="result-link" href="https://codepen.io/MillerTime/embed/BexBbE?height=420&amp;theme-id=dark&amp;default-tab=js%2Cresult&amp;user=MillerTime&amp;slug-hash=BexBbE&amp;pen-title=Menja&amp;name=cp_embed_1#result-box" class="active" aria-pressed="true" role="button">
Result
</a>
</li>
</ul>
<div class="logo-wrap" id="edit-area">
<a class="large-logo edit-on-codepen" target="_blank" rel="noopener" href="https://codepen.io/MillerTime/pen/BexBbE" title="Edit on CodePen">
<span id="edit-on-text" class="open-on">EDIT ON</span>
<svg id="embed-codepen-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 138 26" fill="none" stroke="#000" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round">
<path d="M80 6h-9v14h9 M114 6h-9 v14h9 M111 13h-6 M77 13h-6 M122 20V6l11 14V6 M22 16.7L33 24l11-7.3V9.3L33 2L22 9.3V16.7z M44 16.7L33 9.3l-11 7.4 M22 9.3l11 7.3 l11-7.3 M33 2v7.3 M33 16.7V24 M88 14h6c2.2 0 4-1.8 4-4s-1.8-4-4-4h-6v14 M15 8c-1.3-1.3-3-2-5-2c-4 0-7 3-7 7s3 7 7 7 c2 0 3.7-0.8 5-2 M64 13c0 4-3 7-7 7h-5V6h5C61 6 64 9 64 13z"></path>
</svg>
</a>
<a class="box-logo edit-on-codepen" target="_blank" rel="noopener" href="https://codepen.io/MillerTime/pen/BexBbE" title="Edit on CodePen">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="20 0 26 26" fill="none" stroke="#000" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round">
<path id="icon-codepen-box" d="M22 16.7L33 24l11-7.3V9.3L33 2L22 9.3V16.7z M44 16.7L33 9.3l-11 7.4 M22 9.3l11 7.3 l11-7.3 M33 2v7.3 M33 16.7V24"></path>
</svg>
</a>
</div>
</nav>
<div id="output" data-border-style="thin" data-header="true">
<div id="html-box" class="code-wrap code-box box " role="region" aria-label="HTML">
<pre><code data-lang="htmlmixed" id="actual-html-code" data-og-lang="htmlmixed" data-alt-lang="xml" class=" cm-s-default"><span class="cm-comment">&lt;!-- Game canvas --&gt;</span><br><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">canvas</span> <span class="cm-attribute">id</span>=<span class="cm-string">"c"</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">canvas</span><span class="cm-tag cm-bracket">&gt;</span><br><br><span class="cm-comment">&lt;!-- Gameplay HUD --&gt;</span><br><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"hud"</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"hud__score"</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"score-lbl"</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"cube-count-lbl"</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"pause-btn"</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"slowmo"</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"slowmo__bar"</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br><br><span class="cm-comment">&lt;!-- Menu System --&gt;</span><br><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"menus"</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"menu menu--main"</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">h1</span><span class="cm-tag cm-bracket">&gt;</span>MENJA<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">h1</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">type</span>=<span class="cm-string">"button"</span> <span class="cm-attribute">class</span>=<span class="cm-string">"play-normal-btn"</span><span class="cm-tag cm-bracket">&gt;</span>PLAY GAME<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">type</span>=<span class="cm-string">"button"</span> <span class="cm-attribute">class</span>=<span class="cm-string">"play-casual-btn"</span><span class="cm-tag cm-bracket">&gt;</span>CASUAL MODE<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"credits"</span><span class="cm-tag cm-bracket">&gt;</span>An 8kB game by <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">a</span> <span class="cm-attribute">href</span>=<span class="cm-string">"https://cmiller.tech"</span><span class="cm-tag cm-bracket">&gt;</span>Caleb Miller<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">a</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"menu menu--pause"</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">h1</span><span class="cm-tag cm-bracket">&gt;</span>Paused<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">h1</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">type</span>=<span class="cm-string">"button"</span> <span class="cm-attribute">class</span>=<span class="cm-string">"resume-btn"</span><span class="cm-tag cm-bracket">&gt;</span>RESUME GAME<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">type</span>=<span class="cm-string">"button"</span> <span class="cm-attribute">class</span>=<span class="cm-string">"menu-btn--pause"</span><span class="cm-tag cm-bracket">&gt;</span>MAIN MENU<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"menu menu--score"</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">h1</span><span class="cm-tag cm-bracket">&gt;</span>Game Over<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">h1</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">h2</span><span class="cm-tag cm-bracket">&gt;</span>Your Score:<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">h2</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"final-score-lbl"</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">class</span>=<span class="cm-string">"high-score-lbl"</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">type</span>=<span class="cm-string">"button"</span> <span class="cm-attribute">class</span>=<span class="cm-string">"play-again-btn"</span><span class="cm-tag cm-bracket">&gt;</span>PLAY AGAIN<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span><br>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">type</span>=<span class="cm-string">"button"</span> <span class="cm-attribute">class</span>=<span class="cm-string">"menu-btn--score"</span><span class="cm-tag cm-bracket">&gt;</span>MAIN MENU<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span><br>    <span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br></code></pre>
</div>
<div id="css-box" class="code-wrap code-box box " role="region" aria-label="CSS">
<pre><code data-lang="css" id="actual-css-code" data-og-lang="css" data-alt-lang="css" class=" cm-s-default"><span class="cm-tag">body</span> {<br>    <span class="cm-property">margin</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">background-color</span>: <span class="cm-atom">#000</span>;<br>    <span class="cm-property">background-image</span>: <span class="cm-variable cm-callee">radial-gradient</span>(<span class="cm-atom">ellipse</span> <span class="cm-variable">at</span> <span class="cm-atom">top</span>, <span class="cm-atom">#335476</span> <span class="cm-number">0.0%</span>, <span class="cm-atom">#31506e</span> <span class="cm-number">11.1%</span>, <span class="cm-atom">#304b67</span> <span class="cm-number">22.2%</span>, <span class="cm-atom">#2f4760</span> <span class="cm-number">33.3%</span>, <span class="cm-atom">#2d4359</span> <span class="cm-number">44.4%</span>, <span class="cm-atom">#2c3f51</span> <span class="cm-number">55.6%</span>, <span class="cm-atom">#2a3a4a</span> <span class="cm-number">66.7%</span>, <span class="cm-atom">#293643</span> <span class="cm-number">77.8%</span>, <span class="cm-atom">#28323d</span> <span class="cm-number">88.9%</span>, <span class="cm-atom">#262e36</span> <span class="cm-number">100.0%</span>);<br>    <span class="cm-property">height</span>: <span class="cm-number">100vh</span>;<br>    <span class="cm-property">overflow</span>: <span class="cm-atom">hidden</span>;<br><br>    <span class="cm-property">font-family</span>: <span class="cm-atom">monospace</span>;<br>    <span class="cm-property">font-weight</span>: <span class="cm-atom">bold</span>;<br>    <span class="cm-property">letter-spacing</span>: <span class="cm-number">0.06em</span>;<br>    <span class="cm-property">color</span>: <span class="cm-variable cm-callee">rgba</span>(<span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">0.75</span>);<br>}<br><br><span class="cm-builtin">#c</span> {<br>    <span class="cm-property">display</span>: <span class="cm-atom">block</span>;<br>    <span class="cm-property cm-error">touch-action</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">transform</span>: <span class="cm-variable cm-callee">translateZ</span>(<span class="cm-number">0</span>);<br>}<br><br><br><span class="cm-comment">/*/////////////////////</span><br><span class="cm-comment">//        HUD        //</span><br><span class="cm-comment">/////////////////////*/</span><br><br><br><span class="cm-qualifier">.hud__score</span>,<br><span class="cm-qualifier">.pause-btn</span> {<br>    <span class="cm-property">position</span>: <span class="cm-atom">fixed</span>;<br>    <span class="cm-property">font-size</span>: <span class="cm-variable cm-callee">calc</span>(<span class="cm-number">14px</span> + <span class="cm-number">2vw</span> + <span class="cm-number">1vh</span>);<br>}<br><br><span class="cm-qualifier">.hud__score</span> {<br>    <span class="cm-property">top</span>: <span class="cm-number">0.65em</span>;<br>    <span class="cm-property">left</span>: <span class="cm-number">0.65em</span>;<br>    <span class="cm-property">pointer-events</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">user-select</span>: <span class="cm-atom">none</span>;<br>}<br><br><span class="cm-qualifier">.cube-count-lbl</span> {<br>    <span class="cm-property">font-size</span>: <span class="cm-number">0.46em</span>;<br>}<br><br><span class="cm-qualifier">.pause-btn</span> {<br>    <span class="cm-property">position</span>: <span class="cm-atom">fixed</span>;<br>    <span class="cm-property">top</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">right</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">padding</span>: <span class="cm-number">0.8em</span> <span class="cm-number">0.65em</span>;<br>}<br><br><span class="cm-qualifier">.pause-btn</span> &gt; <span class="cm-tag">div</span> {<br>    <span class="cm-property">position</span>: <span class="cm-atom">relative</span>;<br>    <span class="cm-property">width</span>: <span class="cm-number">0.8em</span>;<br>    <span class="cm-property">height</span>: <span class="cm-number">0.8em</span>;<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0.75</span>;<br>}<br><br><span class="cm-qualifier">.pause-btn</span> &gt; <span class="cm-tag">div</span>::<span class="cm-variable-3">before</span>,<br><span class="cm-qualifier">.pause-btn</span> &gt; <span class="cm-tag">div</span>::<span class="cm-variable-3">after</span> {<br>    <span class="cm-property">content</span>: <span class="cm-string">''</span>;<br>    <span class="cm-property">display</span>: <span class="cm-atom">block</span>;<br>    <span class="cm-property">width</span>: <span class="cm-number">34%</span>;<br>    <span class="cm-property">height</span>: <span class="cm-number">100%</span>;<br>    <span class="cm-property">position</span>: <span class="cm-atom">absolute</span>;<br>    <span class="cm-property">background-color</span>: <span class="cm-atom">#fff</span>;<br>}<br><br><span class="cm-qualifier">.pause-btn</span> &gt; <span class="cm-tag">div</span>::<span class="cm-variable-3">after</span> {<br>    <span class="cm-property">right</span>: <span class="cm-number">0</span>;<br>}<br><br><span class="cm-qualifier">.slowmo</span> {<br>    <span class="cm-property">position</span>: <span class="cm-atom">fixed</span>;<br>    <span class="cm-property">bottom</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">width</span>: <span class="cm-number">100%</span>;<br>    <span class="cm-property">pointer-events</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">transition</span>: <span class="cm-atom">opacity</span> <span class="cm-number">0.4s</span>;<br>    <span class="cm-property">will-change</span>: <span class="cm-atom">opacity</span>;<br>}<br><br><span class="cm-qualifier">.slowmo</span>::<span class="cm-variable-3">before</span> {<br>    <span class="cm-property">content</span>: <span class="cm-string">'SLOW-MO'</span>;<br>    <span class="cm-property">display</span>: <span class="cm-atom">block</span>;<br>    <span class="cm-property">font-size</span>: <span class="cm-variable cm-callee">calc</span>(<span class="cm-number">8px</span> + <span class="cm-number">1vw</span> + <span class="cm-number">0.5vh</span>);<br>    <span class="cm-property">margin-left</span>: <span class="cm-number">0.5em</span>;<br>    <span class="cm-property">margin-bottom</span>: <span class="cm-number">8px</span>;<br>}<br><br><span class="cm-qualifier">.slowmo</span>::<span class="cm-variable-3">after</span> {<br>    <span class="cm-property">content</span>: <span class="cm-string">''</span>;<br>    <span class="cm-property">display</span>: <span class="cm-atom">block</span>;<br>    <span class="cm-property">position</span>: <span class="cm-atom">fixed</span>;<br>    <span class="cm-property">bottom</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">width</span>: <span class="cm-number">100%</span>;<br>    <span class="cm-property">height</span>: <span class="cm-number">1.5vh</span>;<br>    <span class="cm-property">background-color</span>: <span class="cm-variable cm-callee">rgba</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0.25</span>);<br>    <span class="cm-property">z-index</span>: <span class="cm-number">-1</span>;<br>}<br><br><span class="cm-qualifier">.slowmo__bar</span> {<br>    <span class="cm-property">height</span>: <span class="cm-number">1.5vh</span>;<br>    <span class="cm-property">background-color</span>: <span class="cm-variable cm-callee">rgba</span>(<span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">0.75</span>);<br>    <span class="cm-property">transform-origin</span>: <span class="cm-number">0</span> <span class="cm-number">0</span>;<br>}<br><br><br><br><span class="cm-comment">/*/////////////////////</span><br><span class="cm-comment">//       MENUS       //</span><br><span class="cm-comment">/////////////////////*/</span><br><br><span class="cm-qualifier">.menus</span>::<span class="cm-variable-3">before</span> {<br>    <span class="cm-property">content</span>: <span class="cm-string">''</span>;<br>    <span class="cm-property">pointer-events</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">position</span>: <span class="cm-atom">fixed</span>;<br>    <span class="cm-property">top</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">right</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">bottom</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">left</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">background-color</span>: <span class="cm-atom">#000</span>;<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">transition</span>: <span class="cm-atom">opacity</span> <span class="cm-number">0.2s</span>;<br>    <span class="cm-property">transition-timing-function</span>: <span class="cm-atom">ease-in</span>;<br>}<br><br><span class="cm-qualifier">.menus</span><span class="cm-qualifier">.has-active</span>::<span class="cm-variable-3">before</span> {<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0.08</span>;<br>    <span class="cm-property">transition-duration</span>: <span class="cm-number">0.4s</span>;<br>    <span class="cm-property">transition-timing-function</span>: <span class="cm-atom">ease-out</span>;<br>}<br><br><span class="cm-qualifier">.menus</span><span class="cm-qualifier">.interactive-mode</span>::<span class="cm-variable-3">before</span> {<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0.02</span>;<br>}<br><br><br><br><span class="cm-comment">/* Menu containers */</span><br><span class="cm-qualifier">.menu</span> {<br>    <span class="cm-property">pointer-events</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">position</span>: <span class="cm-atom">fixed</span>;<br>    <span class="cm-property">top</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">right</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">bottom</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">left</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">display</span>: <span class="cm-atom">flex</span>;<br>    <span class="cm-property">flex-direction</span>: <span class="cm-atom">column</span>;<br>    <span class="cm-property">justify-content</span>: <span class="cm-atom">center</span>;<br>    <span class="cm-property">align-items</span>: <span class="cm-atom">center</span>;<br>    <span class="cm-property">user-select</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">text-align</span>: <span class="cm-atom">center</span>;<br>    <span class="cm-property">color</span>: <span class="cm-variable cm-callee">rgba</span>(<span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">0.9</span>);<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">visibility</span>: <span class="cm-atom">hidden</span>;<br>    <span class="cm-property">transform</span>: <span class="cm-variable cm-callee">translateY</span>(<span class="cm-number">30px</span>);<br>    <span class="cm-property">transition-property</span>: <span class="cm-atom">opacity</span>, <span class="cm-variable">visibility</span>, <span class="cm-atom">transform</span>;<br>    <span class="cm-property">transition-duration</span>: <span class="cm-number">0.2s</span>;<br>    <span class="cm-property">transition-timing-function</span>: <span class="cm-atom">ease-in</span>;<br>}<br><br><span class="cm-qualifier">.menu</span><span class="cm-qualifier">.active</span> {<br>    <span class="cm-property">opacity</span>: <span class="cm-number">1</span>;<br>    <span class="cm-property">visibility</span>: <span class="cm-atom">visible</span>;<br>    <span class="cm-property">transform</span>: <span class="cm-variable cm-callee">translateY</span>(<span class="cm-number">0</span>);<br>    <span class="cm-property">transition-duration</span>: <span class="cm-number">0.4s</span>;<br>    <span class="cm-property">transition-timing-function</span>: <span class="cm-atom">ease-out</span>;<br>}<br><br><span class="cm-qualifier">.menus</span><span class="cm-qualifier">.interactive-mode</span> <span class="cm-qualifier">.menu</span><span class="cm-qualifier">.active</span> {<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0.6</span>;<br>}<br><br><span class="cm-qualifier">.menus</span>:<span class="cm-variable cm-callee">not</span>(<span class="cm-qualifier">.interactive-mode</span>) <span class="cm-qualifier">.menu</span><span class="cm-qualifier">.active</span> &gt; * {<br>    <span class="cm-property">pointer-events</span>: <span class="cm-atom">auto</span>;<br>}<br><br><br><span class="cm-comment">/* Common menu elements */</span><br><br><span class="cm-tag">h1</span> {<br>    <span class="cm-property">font-size</span>: <span class="cm-number">4rem</span>;<br>    <span class="cm-property">line-height</span>: <span class="cm-number">0.95</span>;<br>    <span class="cm-property">text-align</span>: <span class="cm-atom">center</span>;<br>    <span class="cm-property">font-weight</span>: <span class="cm-atom">bold</span>;<br>    <span class="cm-property">margin</span>: <span class="cm-number">0</span> <span class="cm-number">0.65em</span> <span class="cm-number">1em</span>;<br>}<br><br><span class="cm-tag">h2</span> {<br>    <span class="cm-property">font-size</span>: <span class="cm-number">1.2rem</span>;<br>    <span class="cm-property">line-height</span>: <span class="cm-number">1</span>;<br>    <span class="cm-property">text-align</span>: <span class="cm-atom">center</span>;<br>    <span class="cm-property">font-weight</span>: <span class="cm-atom">bold</span>;<br>    <span class="cm-property">margin</span>: <span class="cm-number">-1em</span> <span class="cm-number">0.65em</span> <span class="cm-number">1em</span>;<br>}<br><br><span class="cm-qualifier">.final-score-lbl</span> {<br>    <span class="cm-property">font-size</span>: <span class="cm-number">5rem</span>;<br>    <span class="cm-property">margin</span>: <span class="cm-number">-0.2em</span> <span class="cm-number">0</span> <span class="cm-number">0</span>;<br>}<br><br><span class="cm-qualifier">.high-score-lbl</span> {<br>    <span class="cm-property">font-size</span>: <span class="cm-number">1.2rem</span>;<br>    <span class="cm-property">margin</span>: <span class="cm-number">0</span> <span class="cm-number">0</span> <span class="cm-number">2.5em</span>;<br>}<br><br><span class="cm-tag">button</span> {<br>    <span class="cm-property">display</span>: <span class="cm-atom">block</span>;<br>    <span class="cm-property">position</span>: <span class="cm-atom">relative</span>;<br>    <span class="cm-property">width</span>: <span class="cm-number">200px</span>;<br>    <span class="cm-property">padding</span>: <span class="cm-number">12px</span> <span class="cm-number">20px</span>;<br>    <span class="cm-property">background</span>: <span class="cm-atom">transparent</span>;<br>    <span class="cm-property">border</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">outline</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">user-select</span>: <span class="cm-atom">none</span>;<br>    <span class="cm-property">font-family</span>: <span class="cm-atom">monospace</span>;<br>    <span class="cm-property">font-weight</span>: <span class="cm-atom">bold</span>;<br>    <span class="cm-property">font-size</span>: <span class="cm-number">1.4rem</span>;<br>    <span class="cm-property">color</span>: <span class="cm-atom">#fff</span>;<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0.75</span>;<br>    <span class="cm-property">transition</span>: <span class="cm-atom">opacity</span> <span class="cm-number">0.3s</span>;<br>}<br><br><span class="cm-tag">button</span>::<span class="cm-variable-3">before</span> {<br>    <span class="cm-property">content</span>: <span class="cm-string">''</span>;<br>    <span class="cm-property">position</span>: <span class="cm-atom">absolute</span>;<br>    <span class="cm-property">top</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">right</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">bottom</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">left</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">background-color</span>: <span class="cm-variable cm-callee">rgba</span>(<span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">255</span>, <span class="cm-number">0.15</span>);<br>    <span class="cm-property">transform</span>: <span class="cm-variable cm-callee">scale</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>);<br>    <span class="cm-property">opacity</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">transition</span>: <span class="cm-atom">opacity</span> <span class="cm-number">0.3s</span>, <span class="cm-atom">transform</span> <span class="cm-number">0.3s</span>;<br>}<br><br><span class="cm-comment">/* No `:focus` styles because this is a mouse/touch game! */</span><br><span class="cm-tag">button</span>:<span class="cm-variable-3">active</span> {<br>    <span class="cm-property">opacity</span>: <span class="cm-number">1</span>;<br>}<br><br><span class="cm-tag">button</span>:<span class="cm-variable-3">active</span>::<span class="cm-variable-3">before</span> {<br>    <span class="cm-property">transform</span>: <span class="cm-variable cm-callee">scale</span>(<span class="cm-number">1</span>, <span class="cm-number">1</span>);<br>    <span class="cm-property">opacity</span>: <span class="cm-number">1</span>;<br>}<br><br><span class="cm-qualifier">.credits</span> {<br>    <span class="cm-property">position</span>: <span class="cm-atom">fixed</span>;<br>    <span class="cm-property">width</span>: <span class="cm-number">100%</span>;<br>    <span class="cm-property">left</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">bottom</span>: <span class="cm-number">20px</span>;<br>}<br><br><span class="cm-tag">a</span> {<br>    <span class="cm-property">color</span>: <span class="cm-keyword">white</span>;<br>}<br><br><span class="cm-comment">/* Only enable hover state on large screens */</span><br><span class="cm-def">@media</span> (<span class="cm-property">min-width</span>: <span class="cm-number">1025px</span>) {<br>    <span class="cm-tag">button</span>:<span class="cm-variable-3">hover</span> {<br>        <span class="cm-property">opacity</span>: <span class="cm-number">1</span>;<br>    }<br><br>    <span class="cm-tag">button</span>:<span class="cm-variable-3">hover</span>::<span class="cm-variable-3">before</span> {<br>        <span class="cm-property">transform</span>: <span class="cm-variable cm-callee">scale</span>(<span class="cm-number">1</span>, <span class="cm-number">1</span>);<br>        <span class="cm-property">opacity</span>: <span class="cm-number">1</span>;<br>    }<br>}<br></code></pre>
</div>
<div id="js-box" class="code-wrap code-box box active" role="region" aria-label="JS">
<pre><code data-lang="javascript" id="actual-js-code" data-og-lang="javascript" data-alt-lang="javascript" class=" cm-s-default"><span class="cm-comment">// globalConfig.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">// Provides global variables used by the entire program.</span><br><span class="cm-comment">// Most of this should be configuration.</span><br><br><span class="cm-comment">// Timing multiplier for entire game engine.</span><br><span class="cm-keyword">let</span> <span class="cm-def">gameSpeed</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br><br><span class="cm-comment">// Colors</span><br><span class="cm-keyword">const</span> <span class="cm-def">BLUE</span> <span class="cm-operator">=</span>   { <span class="cm-property">r</span>: <span class="cm-number">0x67</span>, <span class="cm-property">g</span>: <span class="cm-number">0xd7</span>, <span class="cm-property">b</span>: <span class="cm-number">0xf0</span> };<br><span class="cm-keyword">const</span> <span class="cm-def">GREEN</span> <span class="cm-operator">=</span>  { <span class="cm-property">r</span>: <span class="cm-number">0xa6</span>, <span class="cm-property">g</span>: <span class="cm-number">0xe0</span>, <span class="cm-property">b</span>: <span class="cm-number">0x2c</span> };<br><span class="cm-keyword">const</span> <span class="cm-def">PINK</span> <span class="cm-operator">=</span>   { <span class="cm-property">r</span>: <span class="cm-number">0xfa</span>, <span class="cm-property">g</span>: <span class="cm-number">0x24</span>, <span class="cm-property">b</span>: <span class="cm-number">0x73</span> };<br><span class="cm-keyword">const</span> <span class="cm-def">ORANGE</span> <span class="cm-operator">=</span> { <span class="cm-property">r</span>: <span class="cm-number">0xfe</span>, <span class="cm-property">g</span>: <span class="cm-number">0x95</span>, <span class="cm-property">b</span>: <span class="cm-number">0x22</span> };<br><span class="cm-keyword">const</span> <span class="cm-def">allColors</span> <span class="cm-operator">=</span> [<span class="cm-variable">BLUE</span>, <span class="cm-variable">GREEN</span>, <span class="cm-variable">PINK</span>, <span class="cm-variable">ORANGE</span>];<br><br><span class="cm-comment">// Gameplay</span><br><span class="cm-keyword">const</span> <span class="cm-def">getSpawnDelay</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">const</span> <span class="cm-def">spawnDelayMax</span> <span class="cm-operator">=</span> <span class="cm-number">1400</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">spawnDelayMin</span> <span class="cm-operator">=</span> <span class="cm-number">550</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">spawnDelay</span> <span class="cm-operator">=</span> <span class="cm-variable-2">spawnDelayMax</span> <span class="cm-operator">-</span> <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">cubeCount</span> <span class="cm-operator">*</span> <span class="cm-number">3.1</span>;<br>    <span class="cm-keyword">return</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>(<span class="cm-variable-2">spawnDelay</span>, <span class="cm-variable-2">spawnDelayMin</span>);<br>}<br><span class="cm-keyword">const</span> <span class="cm-def">doubleStrongEnableScore</span> <span class="cm-operator">=</span> <span class="cm-number">2000</span>;<br><span class="cm-comment">// Number of cubes that must be smashed before activating a feature.</span><br><span class="cm-keyword">const</span> <span class="cm-def">slowmoThreshold</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">strongThreshold</span> <span class="cm-operator">=</span> <span class="cm-number">25</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">spinnerThreshold</span> <span class="cm-operator">=</span> <span class="cm-number">25</span>;<br><br><span class="cm-comment">// Interaction state</span><br><span class="cm-keyword">let</span> <span class="cm-def">pointerIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br><span class="cm-comment">// The last known position of the primary pointer in screen coordinates.`</span><br><span class="cm-keyword">let</span> <span class="cm-def">pointerScreen</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> };<br><span class="cm-comment">// Same as `pointerScreen`, but converted to scene coordinates in rAF.</span><br><span class="cm-keyword">let</span> <span class="cm-def">pointerScene</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> };<br><span class="cm-comment">// Minimum speed of pointer before "hits" are counted.</span><br><span class="cm-keyword">const</span> <span class="cm-def">minPointerSpeed</span> <span class="cm-operator">=</span> <span class="cm-number">60</span>;<br><span class="cm-comment">// The hit speed affects the direction the target post-hit. This number dampens that force.</span><br><span class="cm-keyword">const</span> <span class="cm-def">hitDampening</span> <span class="cm-operator">=</span> <span class="cm-number">0.1</span>;<br><span class="cm-comment">// Backboard receives shadows and is the farthest negative Z position of entities.</span><br><span class="cm-keyword">const</span> <span class="cm-def">backboardZ</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">400</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">shadowColor</span> <span class="cm-operator">=</span> <span class="cm-string">'#262e36'</span>;<br><span class="cm-comment">// How much air drag is applied to standard objects</span><br><span class="cm-keyword">const</span> <span class="cm-def">airDrag</span> <span class="cm-operator">=</span> <span class="cm-number">0.022</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">gravity</span> <span class="cm-operator">=</span> <span class="cm-number">0.3</span>;<br><span class="cm-comment">// Spark config</span><br><span class="cm-keyword">const</span> <span class="cm-def">sparkColor</span> <span class="cm-operator">=</span> <span class="cm-string">'rgba(170,221,255,.9)'</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">sparkThickness</span> <span class="cm-operator">=</span> <span class="cm-number">2.2</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">airDragSpark</span> <span class="cm-operator">=</span> <span class="cm-number">0.1</span>;<br><span class="cm-comment">// Track pointer positions to show trail</span><br><span class="cm-keyword">const</span> <span class="cm-def">touchTrailColor</span> <span class="cm-operator">=</span> <span class="cm-string">'rgba(170,221,255,.62)'</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">touchTrailThickness</span> <span class="cm-operator">=</span> <span class="cm-number">7</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">touchPointLife</span> <span class="cm-operator">=</span> <span class="cm-number">120</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">touchPoints</span> <span class="cm-operator">=</span> [];<br><span class="cm-comment">// Size of in-game targets. This affects rendered size and hit area.</span><br><span class="cm-keyword">const</span> <span class="cm-def">targetRadius</span> <span class="cm-operator">=</span> <span class="cm-number">40</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">targetHitRadius</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">makeTargetGlueColor</span> <span class="cm-operator">=</span> <span class="cm-def">target</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-comment">// const alpha = (target.health - 1) / (target.maxHealth - 1);</span><br>    <span class="cm-comment">// return `rgba(170,221,255,${alpha.toFixed(3)})`;</span><br>    <span class="cm-keyword">return</span> <span class="cm-string">'rgb(170,221,255)'</span>;<br>};<br><span class="cm-comment">// Size of target fragments</span><br><span class="cm-keyword">const</span> <span class="cm-def">fragRadius</span> <span class="cm-operator">=</span> <span class="cm-variable">targetRadius</span> <span class="cm-operator">/</span> <span class="cm-number">3</span>;<br><br><br><br><span class="cm-comment">// Game canvas element needed in setup.js and interaction.js</span><br><span class="cm-keyword">const</span> <span class="cm-def">canvas</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">querySelector</span>(<span class="cm-string">'#c'</span>);<br><br><span class="cm-comment">// 3D camera config</span><br><span class="cm-comment">// Affects perspective</span><br><span class="cm-keyword">const</span> <span class="cm-def">cameraDistance</span> <span class="cm-operator">=</span> <span class="cm-number">900</span>;<br><span class="cm-comment">// Does not affect perspective</span><br><span class="cm-keyword">const</span> <span class="cm-def">sceneScale</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br><span class="cm-comment">// Objects that get too close to the camera will be faded out to transparent over this range.</span><br><span class="cm-comment">// const cameraFadeStartZ = 0.8*cameraDistance - 6*targetRadius;</span><br><span class="cm-keyword">const</span> <span class="cm-def">cameraFadeStartZ</span> <span class="cm-operator">=</span> <span class="cm-number">0.45</span><span class="cm-operator">*</span><span class="cm-variable">cameraDistance</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">cameraFadeEndZ</span> <span class="cm-operator">=</span> <span class="cm-number">0.65</span><span class="cm-operator">*</span><span class="cm-variable">cameraDistance</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">cameraFadeRange</span> <span class="cm-operator">=</span> <span class="cm-variable">cameraFadeEndZ</span> <span class="cm-operator">-</span> <span class="cm-variable">cameraFadeStartZ</span>;<br><br><span class="cm-comment">// Globals used to accumlate all vertices/polygons in each frame</span><br><span class="cm-keyword">const</span> <span class="cm-def">allVertices</span> <span class="cm-operator">=</span> [];<br><span class="cm-keyword">const</span> <span class="cm-def">allPolys</span> <span class="cm-operator">=</span> [];<br><span class="cm-keyword">const</span> <span class="cm-def">allShadowVertices</span> <span class="cm-operator">=</span> [];<br><span class="cm-keyword">const</span> <span class="cm-def">allShadowPolys</span> <span class="cm-operator">=</span> [];<br><br><br><br><br><span class="cm-comment">// state.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">///////////</span><br><span class="cm-comment">// Enums //</span><br><span class="cm-comment">///////////</span><br><br><span class="cm-comment">// Game Modes</span><br><span class="cm-keyword">const</span> <span class="cm-def">GAME_MODE_RANKED</span> <span class="cm-operator">=</span> <span class="cm-variable">Symbol</span>(<span class="cm-string">'GAME_MODE_RANKED'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">GAME_MODE_CASUAL</span> <span class="cm-operator">=</span> <span class="cm-variable">Symbol</span>(<span class="cm-string">'GAME_MODE_CASUAL'</span>);<br><br><span class="cm-comment">// Available Menus</span><br><span class="cm-keyword">const</span> <span class="cm-def">MENU_MAIN</span> <span class="cm-operator">=</span> <span class="cm-variable">Symbol</span>(<span class="cm-string">'MENU_MAIN'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">MENU_PAUSE</span> <span class="cm-operator">=</span> <span class="cm-variable">Symbol</span>(<span class="cm-string">'MENU_PAUSE'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">MENU_SCORE</span> <span class="cm-operator">=</span> <span class="cm-variable">Symbol</span>(<span class="cm-string">'MENU_SCORE'</span>);<br><br><br><br><span class="cm-comment">//////////////////</span><br><span class="cm-comment">// Global State //</span><br><span class="cm-comment">//////////////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">state</span> <span class="cm-operator">=</span> {<br>    <span class="cm-property">game</span>: {<br>        <span class="cm-property">mode</span>: <span class="cm-variable">GAME_MODE_RANKED</span>,<br>        <span class="cm-comment">// Run time of current game.</span><br>        <span class="cm-property">time</span>: <span class="cm-number">0</span>,<br>        <span class="cm-comment">// Player score.</span><br>        <span class="cm-property">score</span>: <span class="cm-number">0</span>,<br>        <span class="cm-comment">// Total number of cubes smashed in game.</span><br>        <span class="cm-property">cubeCount</span>: <span class="cm-number">0</span><br>    },<br>    <span class="cm-property">menus</span>: {<br>        <span class="cm-comment">// Set to `null` to hide all menus</span><br>        <span class="cm-property">active</span>: <span class="cm-variable">MENU_MAIN</span><br>    }<br>};<br><br><br><span class="cm-comment">////////////////////////////</span><br><span class="cm-comment">// Global State Selectors //</span><br><span class="cm-comment">////////////////////////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">isInGame</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> <span class="cm-operator">!</span><span class="cm-variable">state</span>.<span class="cm-property">menus</span>.<span class="cm-property">active</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">isMenuVisible</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> <span class="cm-operator">!</span><span class="cm-operator">!</span><span class="cm-variable">state</span>.<span class="cm-property">menus</span>.<span class="cm-property">active</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">isCasualGame</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">mode</span> <span class="cm-operator">===</span> <span class="cm-variable">GAME_MODE_CASUAL</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">isPaused</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> <span class="cm-variable">state</span>.<span class="cm-property">menus</span>.<span class="cm-property">active</span> <span class="cm-operator">===</span> <span class="cm-variable">MENU_PAUSE</span>;<br><br><br><span class="cm-comment">///////////////////</span><br><span class="cm-comment">// Local Storage //</span><br><span class="cm-comment">///////////////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">highScoreKey</span> <span class="cm-operator">=</span> <span class="cm-string">'__menja__highScore'</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">getHighScore</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">const</span> <span class="cm-def">raw</span> <span class="cm-operator">=</span> <span class="cm-variable">localStorage</span>.<span class="cm-property">getItem</span>(<span class="cm-variable">highScoreKey</span>);<br>    <span class="cm-keyword">return</span> <span class="cm-variable-2">raw</span> <span class="cm-operator">?</span> <span class="cm-variable">parseInt</span>(<span class="cm-variable-2">raw</span>, <span class="cm-number">10</span>) : <span class="cm-number">0</span>;<br>};<br><br><span class="cm-keyword">let</span> <span class="cm-def">_lastHighscore</span> <span class="cm-operator">=</span> <span class="cm-variable">getHighScore</span>();<br><span class="cm-keyword">const</span> <span class="cm-def">setHighScore</span> <span class="cm-operator">=</span> <span class="cm-def">score</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable">_lastHighscore</span> <span class="cm-operator">=</span> <span class="cm-variable">getHighScore</span>();<br>    <span class="cm-variable">localStorage</span>.<span class="cm-property">setItem</span>(<span class="cm-variable">highScoreKey</span>, <span class="cm-variable">String</span>(<span class="cm-variable-2">score</span>));<br>};<br><br><span class="cm-keyword">const</span> <span class="cm-def">isNewHighScore</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">_lastHighscore</span>;<br><br><br><br><br><span class="cm-comment">// utils.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><br><span class="cm-keyword">const</span> <span class="cm-def">invariant</span> <span class="cm-operator">=</span> (<span class="cm-def">condition</span>, <span class="cm-def">message</span>) <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">condition</span>) <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">Error</span>(<span class="cm-variable-2">message</span>);<br>};<br><br><br><span class="cm-comment">/////////</span><br><span class="cm-comment">// DOM //</span><br><span class="cm-comment">/////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">$</span> <span class="cm-operator">=</span> <span class="cm-def">selector</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">document</span>.<span class="cm-property">querySelector</span>(<span class="cm-variable-2">selector</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">handleClick</span> <span class="cm-operator">=</span> (<span class="cm-def">element</span>, <span class="cm-def">handler</span>) <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">element</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'click'</span>, <span class="cm-variable-2">handler</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">handlePointerDown</span> <span class="cm-operator">=</span> (<span class="cm-def">element</span>, <span class="cm-def">handler</span>) <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable-2">element</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'touchstart'</span>, <span class="cm-variable-2">handler</span>);<br>    <span class="cm-variable-2">element</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'mousedown'</span>, <span class="cm-variable-2">handler</span>);<br>};<br><br><br><br><span class="cm-comment">////////////////////////</span><br><span class="cm-comment">// Formatting Helpers //</span><br><span class="cm-comment">////////////////////////</span><br><br><span class="cm-comment">// Converts a number into a formatted string with thousand separators.</span><br><span class="cm-keyword">const</span> <span class="cm-def">formatNumber</span> <span class="cm-operator">=</span> <span class="cm-def">num</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">num</span>.<span class="cm-property">toLocaleString</span>();<br><br><br><br><span class="cm-comment">////////////////////</span><br><span class="cm-comment">// Math Constants //</span><br><span class="cm-comment">////////////////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">PI</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">PI</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">TAU</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">PI</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">ETA</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">PI</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span>;<br><br><br><br><span class="cm-comment">//////////////////</span><br><span class="cm-comment">// Math Helpers //</span><br><span class="cm-comment">//////////////////</span><br><br><span class="cm-comment">// Clamps a number between min and max values (inclusive)</span><br><span class="cm-keyword">const</span> <span class="cm-def">clamp</span> <span class="cm-operator">=</span> (<span class="cm-def">num</span>, <span class="cm-def">min</span>, <span class="cm-def">max</span>) <span class="cm-operator">=&gt;</span> <span class="cm-variable">Math</span>.<span class="cm-property">min</span>(<span class="cm-variable">Math</span>.<span class="cm-property">max</span>(<span class="cm-variable-2">num</span>, <span class="cm-variable-2">min</span>), <span class="cm-variable-2">max</span>);<br><br><span class="cm-comment">// Linearly interpolate between numbers a and b by a specific amount.</span><br><span class="cm-comment">// mix &gt;= 0 &amp;&amp; mix &lt;= 1</span><br><span class="cm-keyword">const</span> <span class="cm-def">lerp</span> <span class="cm-operator">=</span> (<span class="cm-def">a</span>, <span class="cm-def">b</span>, <span class="cm-def">mix</span>) <span class="cm-operator">=&gt;</span> (<span class="cm-variable-2">b</span> <span class="cm-operator">-</span> <span class="cm-variable-2">a</span>) <span class="cm-operator">*</span> <span class="cm-variable-2">mix</span> <span class="cm-operator">+</span> <span class="cm-variable-2">a</span>;<br><br><br><br><br><span class="cm-comment">////////////////////</span><br><span class="cm-comment">// Random Helpers //</span><br><span class="cm-comment">////////////////////</span><br><br><span class="cm-comment">// Generates a random number between min (inclusive) and max (exclusive)</span><br><span class="cm-keyword">const</span> <span class="cm-def">random</span> <span class="cm-operator">=</span> (<span class="cm-def">min</span>, <span class="cm-def">max</span>) <span class="cm-operator">=&gt;</span> <span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> (<span class="cm-variable-2">max</span> <span class="cm-operator">-</span> <span class="cm-variable-2">min</span>) <span class="cm-operator">+</span> <span class="cm-variable-2">min</span>;<br><br><span class="cm-comment">// Generates a random integer between and possibly including min and max values</span><br><span class="cm-keyword">const</span> <span class="cm-def">randomInt</span> <span class="cm-operator">=</span> (<span class="cm-def">min</span>, <span class="cm-def">max</span>) <span class="cm-operator">=&gt;</span> ((<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> (<span class="cm-variable-2">max</span> <span class="cm-operator">-</span> <span class="cm-variable-2">min</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>)) <span class="cm-operator">|</span> <span class="cm-number">0</span>) <span class="cm-operator">+</span> <span class="cm-variable-2">min</span>;<br><br><span class="cm-comment">// Returns a random element from an array</span><br><span class="cm-keyword">const</span> <span class="cm-def">pickOne</span> <span class="cm-operator">=</span> <span class="cm-def">arr</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">arr</span>[<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-variable-2">arr</span>.<span class="cm-property">length</span> <span class="cm-operator">|</span> <span class="cm-number">0</span>];<br><br><br><br><br><span class="cm-comment">///////////////////</span><br><span class="cm-comment">// Color Helpers //</span><br><span class="cm-comment">///////////////////</span><br><br><span class="cm-comment">// Converts an { r, g, b } color object to a 6-digit hex code.</span><br><span class="cm-keyword">const</span> <span class="cm-def">colorToHex</span> <span class="cm-operator">=</span> <span class="cm-def">color</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">return</span> <span class="cm-string">'#'</span> <span class="cm-operator">+</span><br>        (<span class="cm-variable-2">color</span>.<span class="cm-property">r</span> <span class="cm-operator">|</span> <span class="cm-number">0</span>).<span class="cm-property">toString</span>(<span class="cm-number">16</span>).<span class="cm-property">padStart</span>(<span class="cm-number">2</span>, <span class="cm-string">'0'</span>) <span class="cm-operator">+</span><br>        (<span class="cm-variable-2">color</span>.<span class="cm-property">g</span> <span class="cm-operator">|</span> <span class="cm-number">0</span>).<span class="cm-property">toString</span>(<span class="cm-number">16</span>).<span class="cm-property">padStart</span>(<span class="cm-number">2</span>, <span class="cm-string">'0'</span>) <span class="cm-operator">+</span><br>        (<span class="cm-variable-2">color</span>.<span class="cm-property">b</span> <span class="cm-operator">|</span> <span class="cm-number">0</span>).<span class="cm-property">toString</span>(<span class="cm-number">16</span>).<span class="cm-property">padStart</span>(<span class="cm-number">2</span>, <span class="cm-string">'0'</span>);<br>};<br><br><span class="cm-comment">// Operates on an { r, g, b } color object.</span><br><span class="cm-comment">// Returns string hex code.</span><br><span class="cm-comment">// `lightness` must range from 0 to 1. 0 is pure black, 1 is pure white.</span><br><span class="cm-keyword">const</span> <span class="cm-def">shadeColor</span> <span class="cm-operator">=</span> (<span class="cm-def">color</span>, <span class="cm-def">lightness</span>) <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">let</span> <span class="cm-def">other</span>, <span class="cm-def">mix</span>;<br>    <span class="cm-keyword">if</span> (<span class="cm-variable-2">lightness</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0.5</span>) {<br>        <span class="cm-variable-2">other</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-variable-2">mix</span> <span class="cm-operator">=</span> <span class="cm-number">1</span> <span class="cm-operator">-</span> (<span class="cm-variable-2">lightness</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>);<br>    } <span class="cm-keyword">else</span> {<br>        <span class="cm-variable-2">other</span> <span class="cm-operator">=</span> <span class="cm-number">255</span>;<br>        <span class="cm-variable-2">mix</span> <span class="cm-operator">=</span> <span class="cm-variable-2">lightness</span> <span class="cm-operator">*</span> <span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;<br>    }<br>    <span class="cm-keyword">return</span> <span class="cm-string">'#'</span> <span class="cm-operator">+</span><br>        (<span class="cm-variable">lerp</span>(<span class="cm-variable-2">color</span>.<span class="cm-property">r</span>, <span class="cm-variable-2">other</span>, <span class="cm-variable-2">mix</span>) <span class="cm-operator">|</span> <span class="cm-number">0</span>).<span class="cm-property">toString</span>(<span class="cm-number">16</span>).<span class="cm-property">padStart</span>(<span class="cm-number">2</span>, <span class="cm-string">'0'</span>) <span class="cm-operator">+</span><br>        (<span class="cm-variable">lerp</span>(<span class="cm-variable-2">color</span>.<span class="cm-property">g</span>, <span class="cm-variable-2">other</span>, <span class="cm-variable-2">mix</span>) <span class="cm-operator">|</span> <span class="cm-number">0</span>).<span class="cm-property">toString</span>(<span class="cm-number">16</span>).<span class="cm-property">padStart</span>(<span class="cm-number">2</span>, <span class="cm-string">'0'</span>) <span class="cm-operator">+</span><br>        (<span class="cm-variable">lerp</span>(<span class="cm-variable-2">color</span>.<span class="cm-property">b</span>, <span class="cm-variable-2">other</span>, <span class="cm-variable-2">mix</span>) <span class="cm-operator">|</span> <span class="cm-number">0</span>).<span class="cm-property">toString</span>(<span class="cm-number">16</span>).<span class="cm-property">padStart</span>(<span class="cm-number">2</span>, <span class="cm-string">'0'</span>);<br>};<br><br><br><br><br><br><span class="cm-comment">////////////////////</span><br><span class="cm-comment">// Timing Helpers //</span><br><span class="cm-comment">////////////////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">_allCooldowns</span> <span class="cm-operator">=</span> [];<br><br><span class="cm-keyword">const</span> <span class="cm-def">makeCooldown</span> <span class="cm-operator">=</span> (<span class="cm-def">rechargeTime</span>, <span class="cm-def">units</span><span class="cm-operator">=</span><span class="cm-number">1</span>) <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">let</span> <span class="cm-def">timeRemaining</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-keyword">let</span> <span class="cm-def">lastTime</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">initialOptions</span> <span class="cm-operator">=</span> { <span class="cm-property">rechargeTime</span>, <span class="cm-property">units</span> };<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">updateTime</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">const</span> <span class="cm-def">now</span> <span class="cm-operator">=</span> <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">time</span>;<br>        <span class="cm-comment">// Reset time remaining if time goes backwards.</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">now</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">lastTime</span>) {<br>            <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        } <span class="cm-keyword">else</span> {<br>            <span class="cm-comment">// update...</span><br>            <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">now</span><span class="cm-operator">-</span><span class="cm-variable-2">lastTime</span>;<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        }<br>        <span class="cm-variable-2">lastTime</span> <span class="cm-operator">=</span> <span class="cm-variable-2">now</span>;<br>    };<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">canUse</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable-2">updateTime</span>();<br>        <span class="cm-keyword">return</span> <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">&lt;=</span> (<span class="cm-variable-2">rechargeTime</span> <span class="cm-operator">*</span> (<span class="cm-variable-2">units</span><span class="cm-operator">-</span><span class="cm-number">1</span>));<br>    };<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">cooldown</span> <span class="cm-operator">=</span> {<br>        <span class="cm-property">canUse</span>,<br>        <span class="cm-property">useIfAble</span>() {<br>            <span class="cm-keyword">const</span> <span class="cm-def">usable</span> <span class="cm-operator">=</span> <span class="cm-variable-2">canUse</span>();<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">usable</span>) <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">rechargeTime</span>;<br>            <span class="cm-keyword">return</span> <span class="cm-variable-2">usable</span>;<br>        },<br>        <span class="cm-property">mutate</span>(<span class="cm-def">options</span>) {<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">options</span>.<span class="cm-property">rechargeTime</span>) {<br>                <span class="cm-comment">// Apply recharge time delta so change takes effect immediately.</span><br>                <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">rechargeTime</span><span class="cm-operator">-</span><span class="cm-variable-2">options</span>.<span class="cm-property">rechargeTime</span>;<br>                <span class="cm-keyword">if</span> (<span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>                <span class="cm-variable-2">rechargeTime</span> <span class="cm-operator">=</span> <span class="cm-variable-2">options</span>.<span class="cm-property">rechargeTime</span>;<br>            }<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">options</span>.<span class="cm-property">units</span>) <span class="cm-variable-2">units</span> <span class="cm-operator">=</span> <span class="cm-variable-2">options</span>.<span class="cm-property">units</span>;<br>        },<br>        <span class="cm-property">reset</span>() {<br>            <span class="cm-variable-2">timeRemaining</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>            <span class="cm-variable-2">lastTime</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>            <span class="cm-keyword">this</span>.<span class="cm-property">mutate</span>(<span class="cm-variable-2">initialOptions</span>);<br>        }<br>    };<br><br>    <span class="cm-variable">_allCooldowns</span>.<span class="cm-property">push</span>(<span class="cm-variable-2">cooldown</span>);<br><br>    <span class="cm-keyword">return</span> <span class="cm-variable-2">cooldown</span>;<br>};<br><br><span class="cm-keyword">const</span> <span class="cm-def">resetAllCooldowns</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> <span class="cm-variable">_allCooldowns</span>.<span class="cm-property">forEach</span>(<span class="cm-def">cooldown</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">cooldown</span>.<span class="cm-property">reset</span>());<br><br><span class="cm-keyword">const</span> <span class="cm-def">makeSpawner</span> <span class="cm-operator">=</span> ({ <span class="cm-def">chance</span>, <span class="cm-def">cooldownPerSpawn</span>, <span class="cm-def">maxSpawns</span> }) <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">const</span> <span class="cm-def">cooldown</span> <span class="cm-operator">=</span> <span class="cm-variable">makeCooldown</span>(<span class="cm-variable-2">cooldownPerSpawn</span>, <span class="cm-variable-2">maxSpawns</span>);<br>    <span class="cm-keyword">return</span> {<br>        <span class="cm-property">shouldSpawn</span>() {<br>            <span class="cm-keyword">return</span> <span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">&lt;=</span> <span class="cm-variable-2">chance</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable-2">cooldown</span>.<span class="cm-property">useIfAble</span>();<br>        },<br>        <span class="cm-property">mutate</span>(<span class="cm-def">options</span>) {<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">options</span>.<span class="cm-property">chance</span>) <span class="cm-variable-2">chance</span> <span class="cm-operator">=</span> <span class="cm-variable-2">options</span>.<span class="cm-property">chance</span>;<br>            <span class="cm-variable-2">cooldown</span>.<span class="cm-property">mutate</span>({<br>                <span class="cm-property">rechargeTime</span>: <span class="cm-variable-2">options</span>.<span class="cm-property">cooldownPerSpawn</span>,<br>                <span class="cm-property">units</span>: <span class="cm-variable-2">options</span>.<span class="cm-property">maxSpawns</span><br>            });<br>        }<br>    };<br>};<br><br><br><br><br><span class="cm-comment">////////////////////</span><br><span class="cm-comment">// Vector Helpers //</span><br><span class="cm-comment">////////////////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">normalize</span> <span class="cm-operator">=</span> <span class="cm-def">v</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">const</span> <span class="cm-def">mag</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">hypot</span>(<span class="cm-variable-2">v</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">v</span>.<span class="cm-property">y</span>, <span class="cm-variable-2">v</span>.<span class="cm-property">z</span>);<br>    <span class="cm-keyword">return</span> {<br>        <span class="cm-property">x</span>: <span class="cm-variable-2">v</span>.<span class="cm-property">x</span> <span class="cm-operator">/</span> <span class="cm-variable-2">mag</span>,<br>        <span class="cm-property">y</span>: <span class="cm-variable-2">v</span>.<span class="cm-property">y</span> <span class="cm-operator">/</span> <span class="cm-variable-2">mag</span>,<br>        <span class="cm-property">z</span>: <span class="cm-variable-2">v</span>.<span class="cm-property">z</span> <span class="cm-operator">/</span> <span class="cm-variable-2">mag</span><br>    };<br>}<br><br><span class="cm-comment">// Curried math helpers</span><br><span class="cm-keyword">const</span> <span class="cm-def">add</span> <span class="cm-operator">=</span> <span class="cm-def">a</span> <span class="cm-operator">=&gt;</span> <span class="cm-def">b</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">a</span> <span class="cm-operator">+</span> <span class="cm-variable-2">b</span>;<br><span class="cm-comment">// Curried vector helpers</span><br><span class="cm-keyword">const</span> <span class="cm-def">scaleVector</span> <span class="cm-operator">=</span> <span class="cm-def">scale</span> <span class="cm-operator">=&gt;</span> <span class="cm-def">vector</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable-2">vector</span>.<span class="cm-property">x</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">scale</span>;<br>    <span class="cm-variable-2">vector</span>.<span class="cm-property">y</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">scale</span>;<br>    <span class="cm-variable-2">vector</span>.<span class="cm-property">z</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">scale</span>;<br>};<br><br><br><br><br><br><br><br><br><span class="cm-comment">////////////////</span><br><span class="cm-comment">// 3D Helpers //</span><br><span class="cm-comment">////////////////</span><br><br><span class="cm-comment">// Clone array and all vertices.</span><br><span class="cm-keyword">function</span> <span class="cm-def">cloneVertices</span>(<span class="cm-def">vertices</span>) {<br>    <span class="cm-keyword">return</span> <span class="cm-variable-2">vertices</span>.<span class="cm-property">map</span>(<span class="cm-def">v</span> <span class="cm-operator">=&gt;</span> ({ <span class="cm-property">x</span>: <span class="cm-variable-2">v</span>.<span class="cm-property">x</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">v</span>.<span class="cm-property">y</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">v</span>.<span class="cm-property">z</span> }));<br>}<br><br><span class="cm-comment">// Copy vertex data from one array into another.</span><br><span class="cm-comment">// Arrays must be the same length.</span><br><span class="cm-keyword">function</span> <span class="cm-def">copyVerticesTo</span>(<span class="cm-def">arr1</span>, <span class="cm-def">arr2</span>) {<br>    <span class="cm-keyword">const</span> <span class="cm-def">len</span> <span class="cm-operator">=</span> <span class="cm-variable-2">arr1</span>.<span class="cm-property">length</span>;<br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">len</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">v1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">arr1</span>[<span class="cm-variable-2">i</span>];<br>        <span class="cm-keyword">const</span> <span class="cm-def">v2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">arr2</span>[<span class="cm-variable-2">i</span>];<br>        <span class="cm-variable-2">v2</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">x</span>;<br>        <span class="cm-variable-2">v2</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">y</span>;<br>        <span class="cm-variable-2">v2</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">z</span>;<br>    }<br>}<br><br><span class="cm-comment">// Compute triangle midpoint.</span><br><span class="cm-comment">// Mutates `middle` property of given `poly`.</span><br><span class="cm-keyword">function</span> <span class="cm-def">computeTriMiddle</span>(<span class="cm-def">poly</span>) {<br>    <span class="cm-keyword">const</span> <span class="cm-def">v</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">vertices</span>;<br>    <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">v</span>[<span class="cm-number">0</span>].<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">1</span>].<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">2</span>].<span class="cm-property">x</span>) <span class="cm-operator">/</span> <span class="cm-number">3</span>;<br>    <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">v</span>[<span class="cm-number">0</span>].<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">1</span>].<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">2</span>].<span class="cm-property">y</span>) <span class="cm-operator">/</span> <span class="cm-number">3</span>;<br>    <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">v</span>[<span class="cm-number">0</span>].<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">1</span>].<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">2</span>].<span class="cm-property">z</span>) <span class="cm-operator">/</span> <span class="cm-number">3</span>;<br>}<br><br><span class="cm-comment">// Compute quad midpoint.</span><br><span class="cm-comment">// Mutates `middle` property of given `poly`.</span><br><span class="cm-keyword">function</span> <span class="cm-def">computeQuadMiddle</span>(<span class="cm-def">poly</span>) {<br>    <span class="cm-keyword">const</span> <span class="cm-def">v</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">vertices</span>;<br>    <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">v</span>[<span class="cm-number">0</span>].<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">1</span>].<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">2</span>].<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">3</span>].<span class="cm-property">x</span>) <span class="cm-operator">/</span> <span class="cm-number">4</span>;<br>    <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">v</span>[<span class="cm-number">0</span>].<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">1</span>].<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">2</span>].<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">3</span>].<span class="cm-property">y</span>) <span class="cm-operator">/</span> <span class="cm-number">4</span>;<br>    <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">v</span>[<span class="cm-number">0</span>].<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">1</span>].<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">2</span>].<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>[<span class="cm-number">3</span>].<span class="cm-property">z</span>) <span class="cm-operator">/</span> <span class="cm-number">4</span>;<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">computePolyMiddle</span>(<span class="cm-def">poly</span>) {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable-2">poly</span>.<span class="cm-property">vertices</span>.<span class="cm-property">length</span> <span class="cm-operator">===</span> <span class="cm-number">3</span>) {<br>        <span class="cm-variable">computeTriMiddle</span>(<span class="cm-variable-2">poly</span>);<br>    } <span class="cm-keyword">else</span> {<br>        <span class="cm-variable">computeQuadMiddle</span>(<span class="cm-variable-2">poly</span>);<br>    }<br>}<br><br><span class="cm-comment">// Compute distance from any polygon (tri or quad) midpoint to camera.</span><br><span class="cm-comment">// Sets `depth` property of given `poly`.</span><br><span class="cm-comment">// Also triggers midpoint calculation, which mutates `middle` property of `poly`.</span><br><span class="cm-keyword">function</span> <span class="cm-def">computePolyDepth</span>(<span class="cm-def">poly</span>) {<br>    <span class="cm-variable">computePolyMiddle</span>(<span class="cm-variable-2">poly</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">dX</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">x</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">dY</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">y</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">dZ</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">middle</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable">cameraDistance</span>;<br>    <span class="cm-variable-2">poly</span>.<span class="cm-property">depth</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">hypot</span>(<span class="cm-variable-2">dX</span>, <span class="cm-variable-2">dY</span>, <span class="cm-variable-2">dZ</span>);<br>}<br><br><span class="cm-comment">// Compute normal of any polygon. Uses normalized vector cross product.</span><br><span class="cm-comment">// Mutates `normalName` property of given `poly`.</span><br><span class="cm-keyword">function</span> <span class="cm-def">computePolyNormal</span>(<span class="cm-def">poly</span>, <span class="cm-def">normalName</span>) {<br>    <span class="cm-comment">// Store quick refs to vertices</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">v1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">vertices</span>[<span class="cm-number">0</span>];<br>    <span class="cm-keyword">const</span> <span class="cm-def">v2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">vertices</span>[<span class="cm-number">1</span>];<br>    <span class="cm-keyword">const</span> <span class="cm-def">v3</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>.<span class="cm-property">vertices</span>[<span class="cm-number">2</span>];<br>    <span class="cm-comment">// Calculate difference of vertices, following winding order.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">ax</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v2</span>.<span class="cm-property">x</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">ay</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v2</span>.<span class="cm-property">y</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">az</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v2</span>.<span class="cm-property">z</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">bx</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v3</span>.<span class="cm-property">x</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">by</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v3</span>.<span class="cm-property">y</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">bz</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v1</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v3</span>.<span class="cm-property">z</span>;<br>    <span class="cm-comment">// Cross product</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">nx</span> <span class="cm-operator">=</span> <span class="cm-variable-2">ay</span><span class="cm-operator">*</span><span class="cm-variable-2">bz</span> <span class="cm-operator">-</span> <span class="cm-variable-2">az</span><span class="cm-operator">*</span><span class="cm-variable-2">by</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">ny</span> <span class="cm-operator">=</span> <span class="cm-variable-2">az</span><span class="cm-operator">*</span><span class="cm-variable-2">bx</span> <span class="cm-operator">-</span> <span class="cm-variable-2">ax</span><span class="cm-operator">*</span><span class="cm-variable-2">bz</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">nz</span> <span class="cm-operator">=</span> <span class="cm-variable-2">ax</span><span class="cm-operator">*</span><span class="cm-variable-2">by</span> <span class="cm-operator">-</span> <span class="cm-variable-2">ay</span><span class="cm-operator">*</span><span class="cm-variable-2">bx</span>;<br>    <span class="cm-comment">// Compute magnitude of normal and normalize</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">mag</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">hypot</span>(<span class="cm-variable-2">nx</span>, <span class="cm-variable-2">ny</span>, <span class="cm-variable-2">nz</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">polyNormal</span> <span class="cm-operator">=</span> <span class="cm-variable-2">poly</span>[<span class="cm-variable-2">normalName</span>];<br>    <span class="cm-variable-2">polyNormal</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">nx</span> <span class="cm-operator">/</span> <span class="cm-variable-2">mag</span>;<br>    <span class="cm-variable-2">polyNormal</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">ny</span> <span class="cm-operator">/</span> <span class="cm-variable-2">mag</span>;<br>    <span class="cm-variable-2">polyNormal</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-variable-2">nz</span> <span class="cm-operator">/</span> <span class="cm-variable-2">mag</span>;<br>}<br><br><span class="cm-comment">// Apply translation/rotation/scale to all given vertices.</span><br><span class="cm-comment">// If `vertices` and `target` are the same array, the vertices will be mutated in place.</span><br><span class="cm-comment">// If `vertices` and `target` are different arrays, `vertices` will not be touched, instead the</span><br><span class="cm-comment">// transformed values from `vertices` will be written to `target` array.</span><br><span class="cm-keyword">function</span> <span class="cm-def">transformVertices</span>(<span class="cm-def">vertices</span>, <span class="cm-def">target</span>, <span class="cm-def">tX</span>, <span class="cm-def">tY</span>, <span class="cm-def">tZ</span>, <span class="cm-def">rX</span>, <span class="cm-def">rY</span>, <span class="cm-def">rZ</span>, <span class="cm-def">sX</span>, <span class="cm-def">sY</span>, <span class="cm-def">sZ</span>) {<br>    <span class="cm-comment">// Matrix multiplcation constants only need calculated once for all vertices.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">sinX</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>(<span class="cm-variable-2">rX</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">cosX</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">cos</span>(<span class="cm-variable-2">rX</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">sinY</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>(<span class="cm-variable-2">rY</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">cosY</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">cos</span>(<span class="cm-variable-2">rY</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">sinZ</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>(<span class="cm-variable-2">rZ</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">cosZ</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">cos</span>(<span class="cm-variable-2">rZ</span>);<br><br>    <span class="cm-comment">// Using forEach() like map(), but with a (recycled) target array.</span><br>    <span class="cm-variable-2">vertices</span>.<span class="cm-property">forEach</span>((<span class="cm-def">v</span>, <span class="cm-def">i</span>) <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">const</span> <span class="cm-def">targetVertex</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>[<span class="cm-variable-2">i</span>];<br>        <span class="cm-comment">// X axis rotation</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">x1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">x</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">y1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">z</span><span class="cm-operator">*</span><span class="cm-variable-2">sinX</span> <span class="cm-operator">+</span> <span class="cm-variable-2">v</span>.<span class="cm-property">y</span><span class="cm-operator">*</span><span class="cm-variable-2">cosX</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">z1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">z</span><span class="cm-operator">*</span><span class="cm-variable-2">cosX</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v</span>.<span class="cm-property">y</span><span class="cm-operator">*</span><span class="cm-variable-2">sinX</span>;<br>        <span class="cm-comment">// Y axis rotation</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">x2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x1</span><span class="cm-operator">*</span><span class="cm-variable-2">cosY</span> <span class="cm-operator">-</span> <span class="cm-variable-2">z1</span><span class="cm-operator">*</span><span class="cm-variable-2">sinY</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">y2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y1</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">z2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x1</span><span class="cm-operator">*</span><span class="cm-variable-2">sinY</span> <span class="cm-operator">+</span> <span class="cm-variable-2">z1</span><span class="cm-operator">*</span><span class="cm-variable-2">cosY</span>;<br>        <span class="cm-comment">// Z axis rotation</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">x3</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x2</span><span class="cm-operator">*</span><span class="cm-variable-2">cosZ</span> <span class="cm-operator">-</span> <span class="cm-variable-2">y2</span><span class="cm-operator">*</span><span class="cm-variable-2">sinZ</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">y3</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x2</span><span class="cm-operator">*</span><span class="cm-variable-2">sinZ</span> <span class="cm-operator">+</span> <span class="cm-variable-2">y2</span><span class="cm-operator">*</span><span class="cm-variable-2">cosZ</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">z3</span> <span class="cm-operator">=</span> <span class="cm-variable-2">z2</span>;<br><br>        <span class="cm-comment">// Scale, Translate, and set the transform.</span><br>        <span class="cm-variable-2">targetVertex</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x3</span> <span class="cm-operator">*</span> <span class="cm-variable-2">sX</span> <span class="cm-operator">+</span> <span class="cm-variable-2">tX</span>;<br>        <span class="cm-variable-2">targetVertex</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y3</span> <span class="cm-operator">*</span> <span class="cm-variable-2">sY</span> <span class="cm-operator">+</span> <span class="cm-variable-2">tY</span>;<br>        <span class="cm-variable-2">targetVertex</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-variable-2">z3</span> <span class="cm-operator">*</span> <span class="cm-variable-2">sZ</span> <span class="cm-operator">+</span> <span class="cm-variable-2">tZ</span>;<br>    });<br>}<br><br><span class="cm-comment">// 3D projection on a single vertex.</span><br><span class="cm-comment">// Directly mutates the vertex.</span><br><span class="cm-keyword">const</span> <span class="cm-def">projectVertex</span> <span class="cm-operator">=</span> <span class="cm-def">v</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">const</span> <span class="cm-def">focalLength</span> <span class="cm-operator">=</span> <span class="cm-variable">cameraDistance</span> <span class="cm-operator">*</span> <span class="cm-variable">sceneScale</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">depth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">focalLength</span> <span class="cm-operator">/</span> (<span class="cm-variable">cameraDistance</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v</span>.<span class="cm-property">z</span>);<br>    <span class="cm-variable-2">v</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-variable-2">depth</span>;<br>    <span class="cm-variable-2">v</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-variable-2">depth</span>;<br>};<br><br><span class="cm-comment">// 3D projection on a single vertex.</span><br><span class="cm-comment">// Mutates a secondary target vertex.</span><br><span class="cm-keyword">const</span> <span class="cm-def">projectVertexTo</span> <span class="cm-operator">=</span> (<span class="cm-def">v</span>, <span class="cm-def">target</span>) <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">const</span> <span class="cm-def">focalLength</span> <span class="cm-operator">=</span> <span class="cm-variable">cameraDistance</span> <span class="cm-operator">*</span> <span class="cm-variable">sceneScale</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">depth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">focalLength</span> <span class="cm-operator">/</span> (<span class="cm-variable">cameraDistance</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v</span>.<span class="cm-property">z</span>);<br>    <span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-variable-2">depth</span>;<br>    <span class="cm-variable-2">target</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-variable-2">depth</span>;<br>};<br><br><br><br><br><br><span class="cm-comment">// PERF.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">// Dummy no-op functions.</span><br><span class="cm-comment">// I use these in a special build for custom performance profiling.</span><br><span class="cm-keyword">const</span> <span class="cm-def">PERF_START</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> {};<br><span class="cm-keyword">const</span> <span class="cm-def">PERF_END</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> {};<br><span class="cm-keyword">const</span> <span class="cm-def">PERF_UPDATE</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> {};<br><br><br><br><br><span class="cm-comment">// 3dModels.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">// Define models once. The origin is the center of the model.</span><br><br><span class="cm-comment">// A simple cube, 8 vertices, 6 quads.</span><br><span class="cm-comment">// Defaults to an edge length of 2 units, can be influenced with `scale`.</span><br><span class="cm-keyword">function</span> <span class="cm-def">makeCubeModel</span>({ <span class="cm-def">scale</span><span class="cm-operator">=</span><span class="cm-number">1</span> }) {<br>    <span class="cm-keyword">return</span> {<br>        <span class="cm-property">vertices</span>: [<br>            <span class="cm-comment">// top</span><br>            { <span class="cm-property">x</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">scale</span> },<br>            { <span class="cm-property">x</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">scale</span> },<br>            { <span class="cm-property">x</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">scale</span> },<br>            { <span class="cm-property">x</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">scale</span> },<br>            <span class="cm-comment">// bottom</span><br>            { <span class="cm-property">x</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span> },<br>            { <span class="cm-property">x</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span> },<br>            { <span class="cm-property">x</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span> },<br>            { <span class="cm-property">x</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span>, <span class="cm-property">y</span>:  <span class="cm-variable-2">scale</span>, <span class="cm-property">z</span>: <span class="cm-operator">-</span><span class="cm-variable-2">scale</span> }<br>        ],<br>        <span class="cm-property">polys</span>: [<br>            <span class="cm-comment">// z = 1</span><br>            { <span class="cm-property">vIndexes</span>: [<span class="cm-number">0</span>, <span class="cm-number">1</span>, <span class="cm-number">2</span>, <span class="cm-number">3</span>] },<br>            <span class="cm-comment">// z = -1</span><br>            { <span class="cm-property">vIndexes</span>: [<span class="cm-number">7</span>, <span class="cm-number">6</span>, <span class="cm-number">5</span>, <span class="cm-number">4</span>] },<br>            <span class="cm-comment">// y = 1</span><br>            { <span class="cm-property">vIndexes</span>: [<span class="cm-number">3</span>, <span class="cm-number">2</span>, <span class="cm-number">6</span>, <span class="cm-number">7</span>] },<br>            <span class="cm-comment">// y = -1</span><br>            { <span class="cm-property">vIndexes</span>: [<span class="cm-number">4</span>, <span class="cm-number">5</span>, <span class="cm-number">1</span>, <span class="cm-number">0</span>] },<br>            <span class="cm-comment">// x = 1</span><br>            { <span class="cm-property">vIndexes</span>: [<span class="cm-number">5</span>, <span class="cm-number">6</span>, <span class="cm-number">2</span>, <span class="cm-number">1</span>] },<br>            <span class="cm-comment">// x = -1</span><br>            { <span class="cm-property">vIndexes</span>: [<span class="cm-number">0</span>, <span class="cm-number">3</span>, <span class="cm-number">7</span>, <span class="cm-number">4</span>] }<br>        ]<br>    };<br>}<br><br><span class="cm-comment">// Not very optimized - lots of duplicate vertices are generated.</span><br><span class="cm-keyword">function</span> <span class="cm-def">makeRecursiveCubeModel</span>({ <span class="cm-def">recursionLevel</span>, <span class="cm-def">splitFn</span>, <span class="cm-def">color</span>, <span class="cm-def">scale</span><span class="cm-operator">=</span><span class="cm-number">1</span> }) {<br>    <span class="cm-keyword">const</span> <span class="cm-def">getScaleAtLevel</span> <span class="cm-operator">=</span> <span class="cm-def">level</span> <span class="cm-operator">=&gt;</span> <span class="cm-number">1</span> <span class="cm-operator">/</span> (<span class="cm-number">3</span> <span class="cm-operator">**</span> <span class="cm-variable-2">level</span>);<br><br>    <span class="cm-comment">// We can model level 0 manually. It's just a single, centered, cube.</span><br>    <span class="cm-keyword">let</span> <span class="cm-def">cubeOrigins</span> <span class="cm-operator">=</span> [{ <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-number">0</span> }];<br><br>    <span class="cm-comment">// Recursively replace cubes with smaller cubes.</span><br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">1</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;=</span><span class="cm-variable-2">recursionLevel</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">scale</span> <span class="cm-operator">=</span> <span class="cm-variable-2">getScaleAtLevel</span>(<span class="cm-variable-2">i</span>) <span class="cm-operator">*</span> <span class="cm-number">2</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">cubeOrigins2</span> <span class="cm-operator">=</span> [];<br>        <span class="cm-variable-2">cubeOrigins</span>.<span class="cm-property">forEach</span>(<span class="cm-def">origin</span> <span class="cm-operator">=&gt;</span> {<br>            <span class="cm-variable-2">cubeOrigins2</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">splitFn</span>(<span class="cm-variable-2">origin</span>, <span class="cm-variable-2">scale</span>));<br>        });<br>        <span class="cm-variable-2">cubeOrigins</span> <span class="cm-operator">=</span> <span class="cm-variable-2">cubeOrigins2</span>;<br>    }<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">finalModel</span> <span class="cm-operator">=</span> { <span class="cm-property">vertices</span>: [], <span class="cm-property">polys</span>: [] };<br><br>    <span class="cm-comment">// Generate single cube model and scale it.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">cubeModel</span> <span class="cm-operator">=</span> <span class="cm-variable">makeCubeModel</span>({ <span class="cm-property">scale</span>: <span class="cm-number">1</span> });<br>    <span class="cm-variable-2">cubeModel</span>.<span class="cm-property">vertices</span>.<span class="cm-property">forEach</span>(<span class="cm-variable">scaleVector</span>(<span class="cm-variable-2">getScaleAtLevel</span>(<span class="cm-variable-2">recursionLevel</span>)));<br><br>    <span class="cm-comment">// Compute the max distance x, y, or z origin values will be.</span><br>    <span class="cm-comment">// Same result as `Math.max(...cubeOrigins.map(o =&gt; o.x))`, but much faster.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">maxComponent</span> <span class="cm-operator">=</span> <span class="cm-variable-2">getScaleAtLevel</span>(<span class="cm-variable-2">recursionLevel</span>) <span class="cm-operator">*</span> (<span class="cm-number">3</span> <span class="cm-operator">**</span> <span class="cm-variable-2">recursionLevel</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>);<br><br>    <span class="cm-comment">// Place cube geometry at each origin.</span><br>    <span class="cm-variable-2">cubeOrigins</span>.<span class="cm-property">forEach</span>((<span class="cm-def">origin</span>, <span class="cm-def">cubeIndex</span>) <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-comment">// To compute occlusion (shading), find origin component with greatest</span><br>        <span class="cm-comment">// magnitude and normalize it relative to `maxComponent`.</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">occlusion</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>(<br>            <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable-2">origin</span>.<span class="cm-property">x</span>),<br>            <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable-2">origin</span>.<span class="cm-property">y</span>),<br>            <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable-2">origin</span>.<span class="cm-property">z</span>)<br>        ) <span class="cm-operator">/</span> <span class="cm-variable-2">maxComponent</span>;<br>        <span class="cm-comment">// At lower iterations, occlusion looks better lightened up a bit.</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">occlusionLighter</span> <span class="cm-operator">=</span> <span class="cm-variable-2">recursionLevel</span> <span class="cm-operator">&gt;</span> <span class="cm-number">2</span><br>            <span class="cm-operator">?</span> <span class="cm-variable-2">occlusion</span><br>            : (<span class="cm-variable-2">occlusion</span> <span class="cm-operator">+</span> <span class="cm-number">0.8</span>) <span class="cm-operator">/</span> <span class="cm-number">1.8</span>;<br>        <span class="cm-comment">// Clone, translate vertices to origin, and apply scale</span><br>        <span class="cm-variable-2">finalModel</span>.<span class="cm-property">vertices</span>.<span class="cm-property">push</span>(<br>            <span class="cm-meta">...</span><span class="cm-variable-2">cubeModel</span>.<span class="cm-property">vertices</span>.<span class="cm-property">map</span>(<span class="cm-def">v</span> <span class="cm-operator">=&gt;</span> ({<br>                <span class="cm-property">x</span>: (<span class="cm-variable-2">v</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">origin</span>.<span class="cm-property">x</span>) <span class="cm-operator">*</span> <span class="cm-variable-2">scale</span>,<br>                <span class="cm-property">y</span>: (<span class="cm-variable-2">v</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">origin</span>.<span class="cm-property">y</span>) <span class="cm-operator">*</span> <span class="cm-variable-2">scale</span>,<br>                <span class="cm-property">z</span>: (<span class="cm-variable-2">v</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">origin</span>.<span class="cm-property">z</span>) <span class="cm-operator">*</span> <span class="cm-variable-2">scale</span><br>            }))<br>        );<br>        <span class="cm-comment">// Clone polys, shift referenced vertex indexes, and compute color.</span><br>        <span class="cm-variable-2">finalModel</span>.<span class="cm-property">polys</span>.<span class="cm-property">push</span>(<br>            <span class="cm-meta">...</span><span class="cm-variable-2">cubeModel</span>.<span class="cm-property">polys</span>.<span class="cm-property">map</span>(<span class="cm-def">poly</span> <span class="cm-operator">=&gt;</span> ({<br>                <span class="cm-property">vIndexes</span>: <span class="cm-variable-2">poly</span>.<span class="cm-property">vIndexes</span>.<span class="cm-property">map</span>(<span class="cm-variable">add</span>(<span class="cm-variable-2">cubeIndex</span> <span class="cm-operator">*</span> <span class="cm-number">8</span>))<br>            }))<br>        );<br>    });<br><br>    <span class="cm-keyword">return</span> <span class="cm-variable-2">finalModel</span>;<br>}<br><br><br><span class="cm-comment">// o: Vector3D - Position of cube's origin (center).</span><br><span class="cm-comment">// s: Vector3D - Determines size of menger sponge.</span><br><span class="cm-keyword">function</span> <span class="cm-def">mengerSpongeSplit</span>(<span class="cm-def">o</span>, <span class="cm-def">s</span>) {<br>    <span class="cm-keyword">return</span> [<br>        <span class="cm-comment">// Top</span><br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-number">0</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-number">0</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> },<br>        <span class="cm-comment">// Bottom</span><br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-number">0</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-number">0</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> },<br>        <span class="cm-comment">// Middle</span><br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> <span class="cm-variable-2">s</span> },<br>        { <span class="cm-property">x</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-variable-2">o</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">s</span> }<br>    ];<br>}<br><br><br><br><span class="cm-comment">// Helper to optimize models by merging duplicate vertices within a threshold,</span><br><span class="cm-comment">// and removing all polys that share the same vertices.</span><br><span class="cm-comment">// Directly mutates the model.</span><br><span class="cm-keyword">function</span> <span class="cm-def">optimizeModel</span>(<span class="cm-def">model</span>, <span class="cm-def">threshold</span><span class="cm-operator">=</span><span class="cm-number">0.0001</span>) {<br>    <span class="cm-keyword">const</span> { <span class="cm-def">vertices</span>, <span class="cm-def">polys</span> } <span class="cm-operator">=</span> <span class="cm-variable-2">model</span>;<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">compareVertices</span> <span class="cm-operator">=</span> (<span class="cm-def">v1</span>, <span class="cm-def">v2</span>) <span class="cm-operator">=&gt;</span> (<br>        <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable-2">v1</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v2</span>.<span class="cm-property">x</span>) <span class="cm-operator">&lt;</span> <span class="cm-variable-2">threshold</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span><br>        <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable-2">v1</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v2</span>.<span class="cm-property">y</span>) <span class="cm-operator">&lt;</span> <span class="cm-variable-2">threshold</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span><br>        <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable-2">v1</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">v2</span>.<span class="cm-property">z</span>) <span class="cm-operator">&lt;</span> <span class="cm-variable-2">threshold</span><br>    );<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">comparePolys</span> <span class="cm-operator">=</span> (<span class="cm-def">p1</span>, <span class="cm-def">p2</span>) <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">const</span> <span class="cm-def">v1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p1</span>.<span class="cm-property">vIndexes</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">v2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p2</span>.<span class="cm-property">vIndexes</span>;<br>        <span class="cm-keyword">return</span> (<br>            (<br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">0</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">0</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">0</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">1</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">0</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">2</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">0</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">3</span>]<br>            ) <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> (<br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">1</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">0</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">1</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">1</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">1</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">2</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">1</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">3</span>]<br>            ) <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> (<br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">2</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">0</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">2</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">1</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">2</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">2</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">2</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">3</span>]<br>            ) <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> (<br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">3</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">0</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">3</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">1</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">3</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">2</span>] <span class="cm-operator">|</span><span class="cm-operator">|</span><br>                <span class="cm-variable-2">v1</span>[<span class="cm-number">3</span>] <span class="cm-operator">===</span> <span class="cm-variable-2">v2</span>[<span class="cm-number">3</span>]<br>            )<br>        );<br>    };<br><br><br>    <span class="cm-variable-2">vertices</span>.<span class="cm-property">forEach</span>((<span class="cm-def">v</span>, <span class="cm-def">i</span>) <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable-2">v</span>.<span class="cm-property">originalIndexes</span> <span class="cm-operator">=</span> [<span class="cm-variable-2">i</span>];<br>    });<br><br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-variable-2">vertices</span>.<span class="cm-property">length</span><span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&gt;=</span><span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">--</span>) {<br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">ii</span><span class="cm-operator">=</span><span class="cm-variable-2">i</span><span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable-2">ii</span><span class="cm-operator">&gt;=</span><span class="cm-number">0</span>; <span class="cm-variable-2">ii</span><span class="cm-operator">--</span>) {<br>            <span class="cm-keyword">const</span> <span class="cm-def">v1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>[<span class="cm-variable-2">i</span>];<br>            <span class="cm-keyword">const</span> <span class="cm-def">v2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>[<span class="cm-variable-2">ii</span>];<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">compareVertices</span>(<span class="cm-variable-2">v1</span>, <span class="cm-variable-2">v2</span>)) {<br>                <span class="cm-variable-2">vertices</span>.<span class="cm-property">splice</span>(<span class="cm-variable-2">i</span>, <span class="cm-number">1</span>);<br>                <span class="cm-variable-2">v2</span>.<span class="cm-property">originalIndexes</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">v1</span>.<span class="cm-property">originalIndexes</span>);<br>                <span class="cm-keyword">break</span>;<br>            }<br>        }<br>    }<br><br>    <span class="cm-variable-2">vertices</span>.<span class="cm-property">forEach</span>((<span class="cm-def">v</span>, <span class="cm-def">i</span>) <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable-2">polys</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> {<br>            <span class="cm-variable-2">p</span>.<span class="cm-property">vIndexes</span>.<span class="cm-property">forEach</span>((<span class="cm-def">vi</span>, <span class="cm-def">ii</span>, <span class="cm-def">arr</span>) <span class="cm-operator">=&gt;</span> {<br>                <span class="cm-keyword">const</span> <span class="cm-def">vo</span> <span class="cm-operator">=</span> <span class="cm-variable-2">v</span>.<span class="cm-property">originalIndexes</span>;<br>                <span class="cm-keyword">if</span> (<span class="cm-variable-2">vo</span>.<span class="cm-property">includes</span>(<span class="cm-variable-2">vi</span>)) {<br>                    <span class="cm-variable-2">arr</span>[<span class="cm-variable-2">ii</span>] <span class="cm-operator">=</span> <span class="cm-variable-2">i</span>;<br>                }<br>            });<br>        });<br>    });<br><br>    <span class="cm-variable-2">polys</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">const</span> <span class="cm-def">vi</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>.<span class="cm-property">vIndexes</span>;<br>        <span class="cm-variable-2">p</span>.<span class="cm-property">sum</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vi</span>[<span class="cm-number">0</span>] <span class="cm-operator">+</span> <span class="cm-variable-2">vi</span>[<span class="cm-number">1</span>] <span class="cm-operator">+</span> <span class="cm-variable-2">vi</span>[<span class="cm-number">2</span>] <span class="cm-operator">+</span> <span class="cm-variable-2">vi</span>[<span class="cm-number">3</span>];<br>    });<br>    <span class="cm-variable-2">polys</span>.<span class="cm-property">sort</span>((<span class="cm-def">a</span>, <span class="cm-def">b</span>) <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">b</span>.<span class="cm-property">sum</span> <span class="cm-operator">-</span> <span class="cm-variable-2">a</span>.<span class="cm-property">sum</span>);<br><br>    <span class="cm-comment">// Assumptions:</span><br>    <span class="cm-comment">// 1. Each poly will either have no duplicates or 1 duplicate.</span><br>    <span class="cm-comment">// 2. If two polys are equal, they are both hidden (two cubes touching),</span><br>    <span class="cm-comment">//    therefore both can be removed.</span><br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-variable-2">polys</span>.<span class="cm-property">length</span><span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&gt;=</span><span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">--</span>) {<br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">ii</span><span class="cm-operator">=</span><span class="cm-variable-2">i</span><span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable-2">ii</span><span class="cm-operator">&gt;=</span><span class="cm-number">0</span>; <span class="cm-variable-2">ii</span><span class="cm-operator">--</span>) {<br>            <span class="cm-keyword">const</span> <span class="cm-def">p1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">polys</span>[<span class="cm-variable-2">i</span>];<br>            <span class="cm-keyword">const</span> <span class="cm-def">p2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">polys</span>[<span class="cm-variable-2">ii</span>];<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">p1</span>.<span class="cm-property">sum</span> <span class="cm-operator">!==</span> <span class="cm-variable-2">p2</span>.<span class="cm-property">sum</span>) <span class="cm-keyword">break</span>;<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">comparePolys</span>(<span class="cm-variable-2">p1</span>, <span class="cm-variable-2">p2</span>)) {<br>                <span class="cm-variable-2">polys</span>.<span class="cm-property">splice</span>(<span class="cm-variable-2">i</span>, <span class="cm-number">1</span>);<br>                <span class="cm-variable-2">polys</span>.<span class="cm-property">splice</span>(<span class="cm-variable-2">ii</span>, <span class="cm-number">1</span>);<br>                <span class="cm-variable-2">i</span><span class="cm-operator">--</span>;<br>                <span class="cm-keyword">break</span>;<br>            }<br>        }<br>    }<br><br>    <span class="cm-keyword">return</span> <span class="cm-variable-2">model</span>;<br>}<br><br><br><br><br><br><span class="cm-comment">// Entity.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-keyword">class</span> <span class="cm-def">Entity</span> {<br>    <span class="cm-property">constructor</span>({ <span class="cm-def">model</span>, <span class="cm-def">color</span>, <span class="cm-def">wireframe</span><span class="cm-operator">=</span><span class="cm-atom">false</span> }) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">vertices</span> <span class="cm-operator">=</span> <span class="cm-variable">cloneVertices</span>(<span class="cm-variable-2">model</span>.<span class="cm-property">vertices</span>);<br>        <span class="cm-keyword">const</span> <span class="cm-def">shadowVertices</span> <span class="cm-operator">=</span> <span class="cm-variable">cloneVertices</span>(<span class="cm-variable-2">model</span>.<span class="cm-property">vertices</span>);<br>        <span class="cm-keyword">const</span> <span class="cm-def">colorHex</span> <span class="cm-operator">=</span> <span class="cm-variable">colorToHex</span>(<span class="cm-variable-2">color</span>);<br>        <span class="cm-keyword">const</span> <span class="cm-def">darkColorHex</span> <span class="cm-operator">=</span> <span class="cm-variable">shadeColor</span>(<span class="cm-variable-2">color</span>, <span class="cm-number">0.4</span>);<br><br>        <span class="cm-keyword">const</span> <span class="cm-def">polys</span> <span class="cm-operator">=</span> <span class="cm-variable-2">model</span>.<span class="cm-property">polys</span>.<span class="cm-property">map</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> ({<br>            <span class="cm-property">vertices</span>: <span class="cm-variable-2">p</span>.<span class="cm-property">vIndexes</span>.<span class="cm-property">map</span>(<span class="cm-def">vIndex</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">vertices</span>[<span class="cm-variable-2">vIndex</span>]),<br>            <span class="cm-property">color</span>: <span class="cm-variable-2">color</span>, <span class="cm-comment">// custom rgb color object</span><br>            <span class="cm-property">wireframe</span>: <span class="cm-variable-2">wireframe</span>,<br>            <span class="cm-property">strokeWidth</span>: <span class="cm-variable-2">wireframe</span> <span class="cm-operator">?</span> <span class="cm-number">2</span> : <span class="cm-number">0</span>, <span class="cm-comment">// Set to non-zero value to draw stroke</span><br>            <span class="cm-property">strokeColor</span>: <span class="cm-variable-2">colorHex</span>, <span class="cm-comment">// must be a CSS color string</span><br>            <span class="cm-property">strokeColorDark</span>: <span class="cm-variable-2">darkColorHex</span>, <span class="cm-comment">// must be a CSS color string</span><br>            <span class="cm-property">depth</span>: <span class="cm-number">0</span>,<br>            <span class="cm-property">middle</span>: { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-number">0</span> },<br>            <span class="cm-property">normalWorld</span>: { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-number">0</span> },<br>            <span class="cm-property">normalCamera</span>: { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-number">0</span> }<br>        }));<br><br>        <span class="cm-keyword">const</span> <span class="cm-def">shadowPolys</span> <span class="cm-operator">=</span> <span class="cm-variable-2">model</span>.<span class="cm-property">polys</span>.<span class="cm-property">map</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> ({<br>            <span class="cm-property">vertices</span>: <span class="cm-variable-2">p</span>.<span class="cm-property">vIndexes</span>.<span class="cm-property">map</span>(<span class="cm-def">vIndex</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">shadowVertices</span>[<span class="cm-variable-2">vIndex</span>]),<br>            <span class="cm-property">wireframe</span>: <span class="cm-variable-2">wireframe</span>,<br>            <span class="cm-property">normalWorld</span>: { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span>, <span class="cm-property">z</span>: <span class="cm-number">0</span> }<br>        }));<br><br>        <span class="cm-keyword">this</span>.<span class="cm-property">projected</span> <span class="cm-operator">=</span> {}; <span class="cm-comment">// Will store 2D projected data</span><br>        <span class="cm-keyword">this</span>.<span class="cm-property">model</span> <span class="cm-operator">=</span> <span class="cm-variable-2">model</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">vertices</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">polys</span> <span class="cm-operator">=</span> <span class="cm-variable-2">polys</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">shadowVertices</span> <span class="cm-operator">=</span> <span class="cm-variable-2">shadowVertices</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">shadowPolys</span> <span class="cm-operator">=</span> <span class="cm-variable-2">shadowPolys</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">reset</span>();<br>    }<br><br>    <span class="cm-comment">// Better names: resetEntity, resetTransform, resetEntityTransform</span><br>    <span class="cm-property">reset</span>() {<br>        <span class="cm-keyword">this</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">xD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">yD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">zD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br><br>        <span class="cm-keyword">this</span>.<span class="cm-property">rotateX</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">rotateY</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">rotateZ</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">rotateXD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">rotateYD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">rotateZD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br><br>        <span class="cm-keyword">this</span>.<span class="cm-property">scaleX</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">scaleY</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">scaleZ</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br><br>        <span class="cm-keyword">this</span>.<span class="cm-property">projected</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        <span class="cm-keyword">this</span>.<span class="cm-property">projected</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    }<br><br>    <span class="cm-property">transform</span>() {<br>        <span class="cm-variable">transformVertices</span>(<br>            <span class="cm-keyword">this</span>.<span class="cm-property">model</span>.<span class="cm-property">vertices</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">vertices</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">x</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">y</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">z</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">rotateX</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">rotateY</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">rotateZ</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">scaleX</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">scaleY</span>,<br>            <span class="cm-keyword">this</span>.<span class="cm-property">scaleZ</span><br>        );<br><br>        <span class="cm-variable">copyVerticesTo</span>(<span class="cm-keyword">this</span>.<span class="cm-property">vertices</span>, <span class="cm-keyword">this</span>.<span class="cm-property">shadowVertices</span>);<br>    }<br><br>    <span class="cm-comment">// Projects origin point, stored as `projected` property.</span><br>    <span class="cm-property">project</span>() {<br>        <span class="cm-variable">projectVertexTo</span>(<span class="cm-keyword">this</span>, <span class="cm-keyword">this</span>.<span class="cm-property">projected</span>);<br>    }<br>}<br><br><br><br><br><br><span class="cm-comment">// getTarget.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">// All active targets</span><br><span class="cm-keyword">const</span> <span class="cm-def">targets</span> <span class="cm-operator">=</span> [];<br><br><span class="cm-comment">// Pool target instances by color, using a Map.</span><br><span class="cm-comment">// keys are color objects, and values are arrays of targets.</span><br><span class="cm-comment">// Also pool wireframe instances separately.</span><br><span class="cm-keyword">const</span> <span class="cm-def">targetPool</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Map</span>(<span class="cm-variable">allColors</span>.<span class="cm-property">map</span>(<span class="cm-def">c</span><span class="cm-operator">=&gt;</span>([<span class="cm-variable-2">c</span>, []])));<br><span class="cm-keyword">const</span> <span class="cm-def">targetWireframePool</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Map</span>(<span class="cm-variable">allColors</span>.<span class="cm-property">map</span>(<span class="cm-def">c</span><span class="cm-operator">=&gt;</span>([<span class="cm-variable-2">c</span>, []])));<br><br><br><br><span class="cm-keyword">const</span> <span class="cm-def">getTarget</span> <span class="cm-operator">=</span> (() <span class="cm-operator">=&gt;</span> {<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">slowmoSpawner</span> <span class="cm-operator">=</span> <span class="cm-variable">makeSpawner</span>({<br>        <span class="cm-property">chance</span>: <span class="cm-number">0.5</span>,<br>        <span class="cm-property">cooldownPerSpawn</span>: <span class="cm-number">10000</span>,<br>        <span class="cm-property">maxSpawns</span>: <span class="cm-number">1</span><br>    });<br><br>    <span class="cm-keyword">let</span> <span class="cm-def">doubleStrong</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">strongSpawner</span> <span class="cm-operator">=</span> <span class="cm-variable">makeSpawner</span>({<br>        <span class="cm-property">chance</span>: <span class="cm-number">0.3</span>,<br>        <span class="cm-property">cooldownPerSpawn</span>: <span class="cm-number">12000</span>,<br>        <span class="cm-property">maxSpawns</span>: <span class="cm-number">1</span><br>    });<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">spinnerSpawner</span> <span class="cm-operator">=</span> <span class="cm-variable">makeSpawner</span>({<br>        <span class="cm-property">chance</span>: <span class="cm-number">0.1</span>,<br>        <span class="cm-property">cooldownPerSpawn</span>: <span class="cm-number">10000</span>,<br>        <span class="cm-property">maxSpawns</span>: <span class="cm-number">1</span><br>    });<br><br>    <span class="cm-comment">// Cached array instances, no need to allocate every time.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">axisOptions</span> <span class="cm-operator">=</span> [<br>        [<span class="cm-string">'x'</span>, <span class="cm-string">'y'</span>],<br>        [<span class="cm-string">'y'</span>, <span class="cm-string">'z'</span>],<br>        [<span class="cm-string">'z'</span>, <span class="cm-string">'x'</span>]<br>    ];<br><br>    <span class="cm-keyword">function</span> <span class="cm-def">getTargetOfStyle</span>(<span class="cm-def">color</span>, <span class="cm-def">wireframe</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">pool</span> <span class="cm-operator">=</span> <span class="cm-variable-2">wireframe</span> <span class="cm-operator">?</span> <span class="cm-variable">targetWireframePool</span> : <span class="cm-variable">targetPool</span>;<br>        <span class="cm-keyword">let</span> <span class="cm-def">target</span> <span class="cm-operator">=</span> <span class="cm-variable-2">pool</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">color</span>).<span class="cm-property">pop</span>();<br>        <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">target</span>) {<br>            <span class="cm-variable-2">target</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Entity</span>({<br>                <span class="cm-property">model</span>: <span class="cm-variable">optimizeModel</span>(<span class="cm-variable">makeRecursiveCubeModel</span>({<br>                    <span class="cm-property">recursionLevel</span>: <span class="cm-number">1</span>,<br>                    <span class="cm-property">splitFn</span>: <span class="cm-variable">mengerSpongeSplit</span>,<br>                    <span class="cm-property">scale</span>: <span class="cm-variable">targetRadius</span><br>                })),<br>                <span class="cm-property">color</span>: <span class="cm-variable-2">color</span>,<br>                <span class="cm-property">wireframe</span>: <span class="cm-variable-2">wireframe</span><br>            });<br><br>            <span class="cm-comment">// Init any properties that will be used.</span><br>            <span class="cm-comment">// These will not be automatically reset when recycled.</span><br>            <span class="cm-variable-2">target</span>.<span class="cm-property">color</span> <span class="cm-operator">=</span> <span class="cm-variable-2">color</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">wireframe</span> <span class="cm-operator">=</span> <span class="cm-variable-2">wireframe</span>;<br>            <span class="cm-comment">// Some properties don't have their final value yet.</span><br>            <span class="cm-comment">// Initialize with any value of the right type.</span><br>            <span class="cm-variable-2">target</span>.<span class="cm-property">hit</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">maxHealth</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">health</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        }<br>        <span class="cm-keyword">return</span> <span class="cm-variable-2">target</span>;<br>    }<br><br>    <span class="cm-keyword">return</span> <span class="cm-keyword">function</span> <span class="cm-def">getTarget</span>() {<br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">doubleStrong</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">doubleStrongEnableScore</span>) {<br>            <span class="cm-variable-2">doubleStrong</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>            <span class="cm-comment">// Spawner is reset automatically when game resets.</span><br>        } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">doubleStrong</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">doubleStrongEnableScore</span>) {<br>            <span class="cm-variable-2">doubleStrong</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;<br>            <span class="cm-variable-2">strongSpawner</span>.<span class="cm-property">mutate</span>({ <span class="cm-property">maxSpawns</span>: <span class="cm-number">2</span> });<br>        }<br><br>        <span class="cm-comment">// Target Parameters</span><br>        <span class="cm-comment">// --------------------------------</span><br>        <span class="cm-keyword">let</span> <span class="cm-def">color</span> <span class="cm-operator">=</span> <span class="cm-variable">pickOne</span>([<span class="cm-variable">BLUE</span>, <span class="cm-variable">GREEN</span>, <span class="cm-variable">ORANGE</span>]);<br>        <span class="cm-keyword">let</span> <span class="cm-def">wireframe</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>        <span class="cm-keyword">let</span> <span class="cm-def">health</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br>        <span class="cm-keyword">let</span> <span class="cm-def">maxHealth</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">spinner</span> <span class="cm-operator">=</span> <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">cubeCount</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">spinnerThreshold</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">isInGame</span>() <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable-2">spinnerSpawner</span>.<span class="cm-property">shouldSpawn</span>();<br><br>        <span class="cm-comment">// Target Parameter Overrides</span><br>        <span class="cm-comment">// --------------------------------</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">cubeCount</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">slowmoThreshold</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable-2">slowmoSpawner</span>.<span class="cm-property">shouldSpawn</span>()) {<br>            <span class="cm-variable-2">color</span> <span class="cm-operator">=</span> <span class="cm-variable">BLUE</span>;<br>            <span class="cm-variable-2">wireframe</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;<br>        }<br>        <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">cubeCount</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">strongThreshold</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable-2">strongSpawner</span>.<span class="cm-property">shouldSpawn</span>()) {<br>            <span class="cm-variable-2">color</span> <span class="cm-operator">=</span> <span class="cm-variable">PINK</span>;<br>            <span class="cm-variable-2">health</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;<br>        }<br><br>        <span class="cm-comment">// Target Creation</span><br>        <span class="cm-comment">// --------------------------------</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">target</span> <span class="cm-operator">=</span> <span class="cm-variable-2">getTargetOfStyle</span>(<span class="cm-variable-2">color</span>, <span class="cm-variable-2">wireframe</span>);<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">hit</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">maxHealth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">maxHealth</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">health</span> <span class="cm-operator">=</span> <span class="cm-variable-2">health</span>;<br>        <span class="cm-variable">updateTargetHealth</span>(<span class="cm-variable-2">target</span>, <span class="cm-number">0</span>);<br><br>        <span class="cm-keyword">const</span> <span class="cm-def">spinSpeeds</span> <span class="cm-operator">=</span> [<br>            <span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-number">0.1</span> <span class="cm-operator">-</span> <span class="cm-number">0.05</span>,<br>            <span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-number">0.1</span> <span class="cm-operator">-</span> <span class="cm-number">0.05</span><br>        ];<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">spinner</span>) {<br>            <span class="cm-comment">// Ends up spinning a random axis</span><br>            <span class="cm-variable-2">spinSpeeds</span>[<span class="cm-number">0</span>] <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">0.25</span>;<br>            <span class="cm-variable-2">spinSpeeds</span>[<span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZ</span> <span class="cm-operator">=</span> <span class="cm-variable">random</span>(<span class="cm-number">0</span>, <span class="cm-variable">TAU</span>);<br>        }<br><br>        <span class="cm-keyword">const</span> <span class="cm-def">axes</span> <span class="cm-operator">=</span> <span class="cm-variable">pickOne</span>(<span class="cm-variable-2">axisOptions</span>);<br><br>        <span class="cm-variable-2">spinSpeeds</span>.<span class="cm-property">forEach</span>((<span class="cm-def">spinSpeed</span>, <span class="cm-def">i</span>) <span class="cm-operator">=&gt;</span> {<br>            <span class="cm-keyword">switch</span> (<span class="cm-variable-2">axes</span>[<span class="cm-variable-2">i</span>]) {<br>                <span class="cm-keyword">case</span> <span class="cm-string">'x'</span>:<br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">rotateXD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">spinSpeed</span>;<br>                    <span class="cm-keyword">break</span>;<br>                <span class="cm-keyword">case</span> <span class="cm-string">'y'</span>:<br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">rotateYD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">spinSpeed</span>;<br>                    <span class="cm-keyword">break</span>;<br>                <span class="cm-keyword">case</span> <span class="cm-string">'z'</span>:<br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">spinSpeed</span>;<br>                    <span class="cm-keyword">break</span>;<br>            }<br>        });<br><br>        <span class="cm-keyword">return</span> <span class="cm-variable-2">target</span>;<br>    }<br>})();<br><br><br><span class="cm-keyword">const</span> <span class="cm-def">updateTargetHealth</span> <span class="cm-operator">=</span> (<span class="cm-def">target</span>, <span class="cm-def">healthDelta</span>) <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable-2">target</span>.<span class="cm-property">health</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">healthDelta</span>;<br>    <span class="cm-comment">// Only update stroke on non-wireframe targets.</span><br>    <span class="cm-comment">// Showing "glue" is a temporary attempt to display health. For now, there's</span><br>    <span class="cm-comment">// no reason to have wireframe targets with high health, so we're fine.</span><br>    <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">target</span>.<span class="cm-property">wireframe</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">strokeWidth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">health</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">strokeColor</span> <span class="cm-operator">=</span> <span class="cm-variable">makeTargetGlueColor</span>(<span class="cm-variable-2">target</span>);<br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">p</span> <span class="cm-keyword">of</span> <span class="cm-variable-2">target</span>.<span class="cm-property">polys</span>) {<br>            <span class="cm-variable-2">p</span>.<span class="cm-property">strokeWidth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">strokeWidth</span>;<br>            <span class="cm-variable-2">p</span>.<span class="cm-property">strokeColor</span> <span class="cm-operator">=</span> <span class="cm-variable-2">strokeColor</span>;<br>        }<br>    }<br>};<br><br><br><span class="cm-keyword">const</span> <span class="cm-def">returnTarget</span> <span class="cm-operator">=</span> <span class="cm-def">target</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable-2">target</span>.<span class="cm-property">reset</span>();<br>    <span class="cm-keyword">const</span> <span class="cm-def">pool</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">wireframe</span> <span class="cm-operator">?</span> <span class="cm-variable">targetWireframePool</span> : <span class="cm-variable">targetPool</span>;<br>    <span class="cm-variable-2">pool</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">target</span>.<span class="cm-property">color</span>).<span class="cm-property">push</span>(<span class="cm-variable-2">target</span>);<br>};<br><br><br><span class="cm-keyword">function</span> <span class="cm-def">resetAllTargets</span>() {<br>    <span class="cm-keyword">while</span>(<span class="cm-variable">targets</span>.<span class="cm-property">length</span>) {<br>        <span class="cm-variable">returnTarget</span>(<span class="cm-variable">targets</span>.<span class="cm-property">pop</span>());<br>    }<br>}<br><br><br><br><br><br><span class="cm-comment">// createBurst.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">// Track all active fragments</span><br><span class="cm-keyword">const</span> <span class="cm-def">frags</span> <span class="cm-operator">=</span> [];<br><span class="cm-comment">// Pool inactive fragments by color, using a Map.</span><br><span class="cm-comment">// keys are color objects, and values are arrays of fragments.</span><br><span class="cm-comment">// // Also pool wireframe instances separately.</span><br><span class="cm-keyword">const</span> <span class="cm-def">fragPool</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Map</span>(<span class="cm-variable">allColors</span>.<span class="cm-property">map</span>(<span class="cm-def">c</span><span class="cm-operator">=&gt;</span>([<span class="cm-variable-2">c</span>, []])));<br><span class="cm-keyword">const</span> <span class="cm-def">fragWireframePool</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Map</span>(<span class="cm-variable">allColors</span>.<span class="cm-property">map</span>(<span class="cm-def">c</span><span class="cm-operator">=&gt;</span>([<span class="cm-variable-2">c</span>, []])));<br><br><br><span class="cm-keyword">const</span> <span class="cm-def">createBurst</span> <span class="cm-operator">=</span> (() <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-comment">// Precompute some private data to be reused for all bursts.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">basePositions</span> <span class="cm-operator">=</span> <span class="cm-variable">mengerSpongeSplit</span>({ <span class="cm-property">x</span>:<span class="cm-number">0</span>, <span class="cm-property">y</span>:<span class="cm-number">0</span>, <span class="cm-property">z</span>:<span class="cm-number">0</span> }, <span class="cm-variable">fragRadius</span><span class="cm-operator">*</span><span class="cm-number">2</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">positions</span> <span class="cm-operator">=</span> <span class="cm-variable">cloneVertices</span>(<span class="cm-variable-2">basePositions</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">prevPositions</span> <span class="cm-operator">=</span> <span class="cm-variable">cloneVertices</span>(<span class="cm-variable-2">basePositions</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">velocities</span> <span class="cm-operator">=</span> <span class="cm-variable">cloneVertices</span>(<span class="cm-variable-2">basePositions</span>);<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">basePositionNormals</span> <span class="cm-operator">=</span> <span class="cm-variable-2">basePositions</span>.<span class="cm-property">map</span>(<span class="cm-variable">normalize</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">positionNormals</span> <span class="cm-operator">=</span> <span class="cm-variable">cloneVertices</span>(<span class="cm-variable-2">basePositionNormals</span>);<br><br><br>    <span class="cm-keyword">const</span> <span class="cm-def">fragCount</span> <span class="cm-operator">=</span> <span class="cm-variable-2">basePositions</span>.<span class="cm-property">length</span>;<br><br>    <span class="cm-keyword">function</span> <span class="cm-def">getFragForTarget</span>(<span class="cm-def">target</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">pool</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">wireframe</span> <span class="cm-operator">?</span> <span class="cm-variable">fragWireframePool</span> : <span class="cm-variable">fragPool</span>;<br>        <span class="cm-keyword">let</span> <span class="cm-def">frag</span> <span class="cm-operator">=</span> <span class="cm-variable-2">pool</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">target</span>.<span class="cm-property">color</span>).<span class="cm-property">pop</span>();<br>        <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">frag</span>) {<br>            <span class="cm-variable-2">frag</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Entity</span>({<br>                <span class="cm-property">model</span>: <span class="cm-variable">makeCubeModel</span>({ <span class="cm-property">scale</span>: <span class="cm-variable">fragRadius</span> }),<br>                <span class="cm-property">color</span>: <span class="cm-variable-2">target</span>.<span class="cm-property">color</span>,<br>                <span class="cm-property">wireframe</span>: <span class="cm-variable-2">target</span>.<span class="cm-property">wireframe</span><br>            });<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">color</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">color</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">wireframe</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">wireframe</span>;<br>        }<br>        <span class="cm-keyword">return</span> <span class="cm-variable-2">frag</span>;<br>    }<br><br>    <span class="cm-keyword">return</span> (<span class="cm-def">target</span>, <span class="cm-def">force</span><span class="cm-operator">=</span><span class="cm-number">1</span>) <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-comment">// Calculate fragment positions, and what would have been the previous positions</span><br>        <span class="cm-comment">// when still a part of the larger target.</span><br>        <span class="cm-variable">transformVertices</span>(<br>            <span class="cm-variable-2">basePositions</span>, <span class="cm-variable-2">positions</span>,<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">y</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">z</span>,<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">rotateX</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">rotateY</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZ</span>,<br>            <span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-number">1</span><br>        );<br>        <span class="cm-variable">transformVertices</span>(<br>            <span class="cm-variable-2">basePositions</span>, <span class="cm-variable-2">prevPositions</span>,<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">xD</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">yD</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">zD</span>,<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">rotateX</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateXD</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">rotateY</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateYD</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZ</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZD</span>,<br>            <span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-number">1</span><br>        );<br><br>        <span class="cm-comment">// Compute velocity of each fragment, based on previous positions.</span><br>        <span class="cm-comment">// Will write to `velocities` array.</span><br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">fragCount</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>            <span class="cm-keyword">const</span> <span class="cm-def">position</span> <span class="cm-operator">=</span> <span class="cm-variable-2">positions</span>[<span class="cm-variable-2">i</span>];<br>            <span class="cm-keyword">const</span> <span class="cm-def">prevPosition</span> <span class="cm-operator">=</span> <span class="cm-variable-2">prevPositions</span>[<span class="cm-variable-2">i</span>];<br>            <span class="cm-keyword">const</span> <span class="cm-def">velocity</span> <span class="cm-operator">=</span> <span class="cm-variable-2">velocities</span>[<span class="cm-variable-2">i</span>];<br><br>            <span class="cm-variable-2">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">prevPosition</span>.<span class="cm-property">x</span>;<br>            <span class="cm-variable-2">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">prevPosition</span>.<span class="cm-property">y</span>;<br>            <span class="cm-variable-2">velocity</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable-2">prevPosition</span>.<span class="cm-property">z</span>;<br>        }<br><br><br><br>        <span class="cm-comment">// Apply target rotation to normals</span><br>        <span class="cm-variable">transformVertices</span>(<br>            <span class="cm-variable-2">basePositionNormals</span>, <span class="cm-variable-2">positionNormals</span>,<br>            <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>,<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">rotateX</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">rotateY</span>, <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZ</span>,<br>            <span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-number">1</span><br>        );<br><br><br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">fragCount</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>            <span class="cm-keyword">const</span> <span class="cm-def">position</span> <span class="cm-operator">=</span> <span class="cm-variable-2">positions</span>[<span class="cm-variable-2">i</span>];<br>            <span class="cm-keyword">const</span> <span class="cm-def">velocity</span> <span class="cm-operator">=</span> <span class="cm-variable-2">velocities</span>[<span class="cm-variable-2">i</span>];<br>            <span class="cm-keyword">const</span> <span class="cm-def">normal</span> <span class="cm-operator">=</span> <span class="cm-variable-2">positionNormals</span>[<span class="cm-variable-2">i</span>];<br><br>            <span class="cm-keyword">const</span> <span class="cm-def">frag</span> <span class="cm-operator">=</span> <span class="cm-variable-2">getFragForTarget</span>(<span class="cm-variable-2">target</span>);<br><br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">x</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">y</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">z</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateX</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateX</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateY</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateY</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateZ</span> <span class="cm-operator">=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZ</span>;<br><br><br>            <span class="cm-keyword">const</span> <span class="cm-def">burstSpeed</span> <span class="cm-operator">=</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> <span class="cm-variable-2">force</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">randSpeed</span> <span class="cm-operator">=</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> <span class="cm-variable-2">force</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">rotateScale</span> <span class="cm-operator">=</span> <span class="cm-number">0.015</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">xD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> (<span class="cm-variable-2">normal</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-variable-2">burstSpeed</span>) <span class="cm-operator">+</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-variable-2">randSpeed</span>);<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">yD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> (<span class="cm-variable-2">normal</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-variable-2">burstSpeed</span>) <span class="cm-operator">+</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-variable-2">randSpeed</span>);<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">zD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">velocity</span>.<span class="cm-property">z</span> <span class="cm-operator">+</span> (<span class="cm-variable-2">normal</span>.<span class="cm-property">z</span> <span class="cm-operator">*</span> <span class="cm-variable-2">burstSpeed</span>) <span class="cm-operator">+</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-variable-2">randSpeed</span>);<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateXD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">xD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">rotateScale</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateYD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">yD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">rotateScale</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateZD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">zD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">rotateScale</span>;<br><br>            <span class="cm-variable">frags</span>.<span class="cm-property">push</span>(<span class="cm-variable-2">frag</span>);<br>        };<br>    }<br>})();<br><br><br><span class="cm-keyword">const</span> <span class="cm-def">returnFrag</span> <span class="cm-operator">=</span> <span class="cm-def">frag</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable-2">frag</span>.<span class="cm-property">reset</span>();<br>    <span class="cm-keyword">const</span> <span class="cm-def">pool</span> <span class="cm-operator">=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">wireframe</span> <span class="cm-operator">?</span> <span class="cm-variable">fragWireframePool</span> : <span class="cm-variable">fragPool</span>;<br>    <span class="cm-variable-2">pool</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">frag</span>.<span class="cm-property">color</span>).<span class="cm-property">push</span>(<span class="cm-variable-2">frag</span>);<br>};<br><br><br><br><br><br><span class="cm-comment">// sparks.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">sparks</span> <span class="cm-operator">=</span> [];<br><span class="cm-keyword">const</span> <span class="cm-def">sparkPool</span> <span class="cm-operator">=</span> [];<br><br><br><span class="cm-keyword">function</span> <span class="cm-def">addSpark</span>(<span class="cm-def">x</span>, <span class="cm-def">y</span>, <span class="cm-def">xD</span>, <span class="cm-def">yD</span>) {<br>    <span class="cm-keyword">const</span> <span class="cm-def">spark</span> <span class="cm-operator">=</span> <span class="cm-variable">sparkPool</span>.<span class="cm-property">pop</span>() <span class="cm-operator">|</span><span class="cm-operator">|</span> {};<br><br>    <span class="cm-variable-2">spark</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">xD</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span>;<br>    <span class="cm-variable-2">spark</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">yD</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span>;<br>    <span class="cm-variable-2">spark</span>.<span class="cm-property">xD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">xD</span>;<br>    <span class="cm-variable-2">spark</span>.<span class="cm-property">yD</span> <span class="cm-operator">=</span> <span class="cm-variable-2">yD</span>;<br>    <span class="cm-variable-2">spark</span>.<span class="cm-property">life</span> <span class="cm-operator">=</span> <span class="cm-variable">random</span>(<span class="cm-number">200</span>, <span class="cm-number">300</span>);<br>    <span class="cm-variable-2">spark</span>.<span class="cm-property">maxLife</span> <span class="cm-operator">=</span> <span class="cm-variable-2">spark</span>.<span class="cm-property">life</span>;<br><br>    <span class="cm-variable">sparks</span>.<span class="cm-property">push</span>(<span class="cm-variable-2">spark</span>);<br><br>    <span class="cm-keyword">return</span> <span class="cm-variable-2">spark</span>;<br>}<br><br><br><span class="cm-comment">// Spherical spark burst</span><br><span class="cm-keyword">function</span> <span class="cm-def">sparkBurst</span>(<span class="cm-def">x</span>, <span class="cm-def">y</span>, <span class="cm-def">count</span>, <span class="cm-def">maxSpeed</span>) {<br>    <span class="cm-keyword">const</span> <span class="cm-def">angleInc</span> <span class="cm-operator">=</span> <span class="cm-variable">TAU</span> <span class="cm-operator">/</span> <span class="cm-variable-2">count</span>;<br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">count</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">angle</span> <span class="cm-operator">=</span> <span class="cm-variable-2">i</span> <span class="cm-operator">*</span> <span class="cm-variable-2">angleInc</span> <span class="cm-operator">+</span> <span class="cm-variable-2">angleInc</span> <span class="cm-operator">*</span> <span class="cm-variable">Math</span>.<span class="cm-property">random</span>();<br>        <span class="cm-keyword">const</span> <span class="cm-def">speed</span> <span class="cm-operator">=</span> (<span class="cm-number">1</span> <span class="cm-operator">-</span> <span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">**</span> <span class="cm-number">3</span>) <span class="cm-operator">*</span> <span class="cm-variable-2">maxSpeed</span>;<br>        <span class="cm-variable">addSpark</span>(<br>            <span class="cm-variable-2">x</span>,<br>            <span class="cm-variable-2">y</span>,<br>            <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>(<span class="cm-variable-2">angle</span>) <span class="cm-operator">*</span> <span class="cm-variable-2">speed</span>,<br>            <span class="cm-variable">Math</span>.<span class="cm-property">cos</span>(<span class="cm-variable-2">angle</span>) <span class="cm-operator">*</span> <span class="cm-variable-2">speed</span><br>        );<br>    }<br>}<br><br><br><span class="cm-comment">// Make a target "leak" sparks from all vertices.</span><br><span class="cm-comment">// This is used to create the effect of target glue "shedding".</span><br><span class="cm-keyword">let</span> <span class="cm-def">glueShedVertices</span>;<br><span class="cm-keyword">function</span> <span class="cm-def">glueShedSparks</span>(<span class="cm-def">target</span>) {<br>    <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">glueShedVertices</span>) {<br>        <span class="cm-variable">glueShedVertices</span> <span class="cm-operator">=</span> <span class="cm-variable">cloneVertices</span>(<span class="cm-variable-2">target</span>.<span class="cm-property">vertices</span>);<br>    } <span class="cm-keyword">else</span> {<br>        <span class="cm-variable">copyVerticesTo</span>(<span class="cm-variable-2">target</span>.<span class="cm-property">vertices</span>, <span class="cm-variable">glueShedVertices</span>);<br>    }<br><br>    <span class="cm-variable">glueShedVertices</span>.<span class="cm-property">forEach</span>(<span class="cm-def">v</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">if</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">&lt;</span> <span class="cm-number">0.4</span>) {<br>            <span class="cm-variable">projectVertex</span>(<span class="cm-variable-2">v</span>);<br>            <span class="cm-variable">addSpark</span>(<br>                <span class="cm-variable-2">v</span>.<span class="cm-property">x</span>,<br>                <span class="cm-variable-2">v</span>.<span class="cm-property">y</span>,<br>                <span class="cm-variable">random</span>(<span class="cm-operator">-</span><span class="cm-number">12</span>, <span class="cm-number">12</span>),<br>                <span class="cm-variable">random</span>(<span class="cm-operator">-</span><span class="cm-number">12</span>, <span class="cm-number">12</span>)<br>            );<br>        }<br>    });<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">returnSpark</span>(<span class="cm-def">spark</span>) {<br>    <span class="cm-variable">sparkPool</span>.<span class="cm-property">push</span>(<span class="cm-variable-2">spark</span>);<br>}<br><br><br><br><br><br><span class="cm-comment">// hud.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">hudContainerNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.hud'</span>);<br><br><span class="cm-keyword">function</span> <span class="cm-def">setHudVisibility</span>(<span class="cm-def">visible</span>) {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable-2">visible</span>) {<br>        <span class="cm-variable">hudContainerNode</span>.<span class="cm-property">style</span>.<span class="cm-property">display</span> <span class="cm-operator">=</span> <span class="cm-string">'block'</span>;<br>    } <span class="cm-keyword">else</span> {<br>        <span class="cm-variable">hudContainerNode</span>.<span class="cm-property">style</span>.<span class="cm-property">display</span> <span class="cm-operator">=</span> <span class="cm-string">'none'</span>;<br>    }<br>}<br><br><br><span class="cm-comment">///////////</span><br><span class="cm-comment">// Score //</span><br><span class="cm-comment">///////////</span><br><span class="cm-keyword">const</span> <span class="cm-def">scoreNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.score-lbl'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">cubeCountNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.cube-count-lbl'</span>);<br><br><span class="cm-keyword">function</span> <span class="cm-def">renderScoreHud</span>() {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable">isCasualGame</span>()) {<br>        <span class="cm-variable">scoreNode</span>.<span class="cm-property">style</span>.<span class="cm-property">display</span> <span class="cm-operator">=</span> <span class="cm-string">'none'</span>;<br>        <span class="cm-variable">cubeCountNode</span>.<span class="cm-property">style</span>.<span class="cm-property">opacity</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br>    } <span class="cm-keyword">else</span> {<br>        <span class="cm-variable">scoreNode</span>.<span class="cm-property">innerText</span> <span class="cm-operator">=</span> <span class="cm-string-2">`SCORE: ${</span><span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span><span class="cm-string-2">}</span><span class="cm-string-2">`</span>;<br>        <span class="cm-variable">scoreNode</span>.<span class="cm-property">style</span>.<span class="cm-property">display</span> <span class="cm-operator">=</span> <span class="cm-string">'block'</span>;<br>        <span class="cm-variable">cubeCountNode</span>.<span class="cm-property">style</span>.<span class="cm-property">opacity</span> <span class="cm-operator">=</span> <span class="cm-number">0.65</span> ;<br>    }<br>    <span class="cm-variable">cubeCountNode</span>.<span class="cm-property">innerText</span> <span class="cm-operator">=</span> <span class="cm-string-2">`CUBES SMASHED: ${</span><span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">cubeCount</span><span class="cm-string-2">}</span><span class="cm-string-2">`</span>;<br>}<br><br><span class="cm-variable">renderScoreHud</span>();<br><br><br><span class="cm-comment">//////////////////</span><br><span class="cm-comment">// Pause Button //</span><br><span class="cm-comment">//////////////////</span><br><br><span class="cm-variable">handlePointerDown</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.pause-btn'</span>), () <span class="cm-operator">=&gt;</span> <span class="cm-variable">pauseGame</span>());<br><br><br><span class="cm-comment">////////////////////</span><br><span class="cm-comment">// Slow-Mo Status //</span><br><span class="cm-comment">////////////////////</span><br><br><span class="cm-keyword">const</span> <span class="cm-def">slowmoNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.slowmo'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">slowmoBarNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.slowmo__bar'</span>);<br><br><span class="cm-keyword">function</span> <span class="cm-def">renderSlowmoStatus</span>(<span class="cm-def">percentRemaining</span>) {<br>    <span class="cm-variable">slowmoNode</span>.<span class="cm-property">style</span>.<span class="cm-property">opacity</span> <span class="cm-operator">=</span> <span class="cm-variable-2">percentRemaining</span> <span class="cm-operator">===</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-number">0</span> : <span class="cm-number">1</span>;<br>    <span class="cm-variable">slowmoBarNode</span>.<span class="cm-property">style</span>.<span class="cm-property">transform</span> <span class="cm-operator">=</span> <span class="cm-string-2">`scaleX(${</span><span class="cm-variable-2">percentRemaining</span>.<span class="cm-property">toFixed</span>(<span class="cm-number">3</span>)<span class="cm-string-2">}</span><span class="cm-string-2">)`</span>;<br>}<br><br><br><br><br><br><span class="cm-comment">// menus.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">// Top-level menu containers</span><br><span class="cm-keyword">const</span> <span class="cm-def">menuContainerNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.menus'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">menuMainNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.menu--main'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">menuPauseNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.menu--pause'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">menuScoreNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.menu--score'</span>);<br><br><span class="cm-keyword">const</span> <span class="cm-def">finalScoreLblNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.final-score-lbl'</span>);<br><span class="cm-keyword">const</span> <span class="cm-def">highScoreLblNode</span> <span class="cm-operator">=</span> <span class="cm-variable">$</span>(<span class="cm-string">'.high-score-lbl'</span>);<br><br><br><br><span class="cm-keyword">function</span> <span class="cm-def">showMenu</span>(<span class="cm-def">node</span>) {<br>    <span class="cm-variable-2">node</span>.<span class="cm-property">classList</span>.<span class="cm-property">add</span>(<span class="cm-string">'active'</span>);<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">hideMenu</span>(<span class="cm-def">node</span>) {<br>    <span class="cm-variable-2">node</span>.<span class="cm-property">classList</span>.<span class="cm-property">remove</span>(<span class="cm-string">'active'</span>);<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">renderMenus</span>() {<br>    <span class="cm-variable">hideMenu</span>(<span class="cm-variable">menuMainNode</span>);<br>    <span class="cm-variable">hideMenu</span>(<span class="cm-variable">menuPauseNode</span>);<br>    <span class="cm-variable">hideMenu</span>(<span class="cm-variable">menuScoreNode</span>);<br><br>    <span class="cm-keyword">switch</span> (<span class="cm-variable">state</span>.<span class="cm-property">menus</span>.<span class="cm-property">active</span>) {<br>        <span class="cm-keyword">case</span> <span class="cm-variable">MENU_MAIN</span>:<br>            <span class="cm-variable">showMenu</span>(<span class="cm-variable">menuMainNode</span>);<br>            <span class="cm-keyword">break</span>;<br>        <span class="cm-keyword">case</span> <span class="cm-variable">MENU_PAUSE</span>:<br>            <span class="cm-variable">showMenu</span>(<span class="cm-variable">menuPauseNode</span>);<br>            <span class="cm-keyword">break</span>;<br>        <span class="cm-keyword">case</span> <span class="cm-variable">MENU_SCORE</span>:<br>            <span class="cm-variable">finalScoreLblNode</span>.<span class="cm-property">textContent</span> <span class="cm-operator">=</span> <span class="cm-variable">formatNumber</span>(<span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span>);<br>            <span class="cm-keyword">if</span> (<span class="cm-variable">isNewHighScore</span>()) {<br>                <span class="cm-variable">highScoreLblNode</span>.<span class="cm-property">textContent</span> <span class="cm-operator">=</span> <span class="cm-string">'New High Score!'</span>;<br>            } <span class="cm-keyword">else</span> {<br>                <span class="cm-variable">highScoreLblNode</span>.<span class="cm-property">textContent</span> <span class="cm-operator">=</span> <span class="cm-string-2">`High Score: ${</span><span class="cm-variable">formatNumber</span>(<span class="cm-variable">getHighScore</span>())<span class="cm-string-2">}</span><span class="cm-string-2">`</span>;<br>            }<br>            <span class="cm-variable">showMenu</span>(<span class="cm-variable">menuScoreNode</span>);<br>            <span class="cm-keyword">break</span>;<br>    }<br><br>    <span class="cm-variable">setHudVisibility</span>(<span class="cm-operator">!</span><span class="cm-variable">isMenuVisible</span>());<br>    <span class="cm-variable">menuContainerNode</span>.<span class="cm-property">classList</span>.<span class="cm-property">toggle</span>(<span class="cm-string">'has-active'</span>, <span class="cm-variable">isMenuVisible</span>());<br>    <span class="cm-variable">menuContainerNode</span>.<span class="cm-property">classList</span>.<span class="cm-property">toggle</span>(<span class="cm-string">'interactive-mode'</span>, <span class="cm-variable">isMenuVisible</span>() <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">pointerIsDown</span>);<br>}<br><br><span class="cm-variable">renderMenus</span>();<br><br><br><br><span class="cm-comment">////////////////////</span><br><span class="cm-comment">// Button Actions //</span><br><span class="cm-comment">////////////////////</span><br><br><span class="cm-comment">// Main Menu</span><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.play-normal-btn'</span>), () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable">setGameMode</span>(<span class="cm-variable">GAME_MODE_RANKED</span>);<br>    <span class="cm-variable">setActiveMenu</span>(<span class="cm-atom">null</span>);<br>    <span class="cm-variable">resetGame</span>();<br>});<br><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.play-casual-btn'</span>), () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable">setGameMode</span>(<span class="cm-variable">GAME_MODE_CASUAL</span>);<br>    <span class="cm-variable">setActiveMenu</span>(<span class="cm-atom">null</span>);<br>    <span class="cm-variable">resetGame</span>();<br>});<br><br><span class="cm-comment">// Pause Menu</span><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.resume-btn'</span>), () <span class="cm-operator">=&gt;</span> <span class="cm-variable">resumeGame</span>());<br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.menu-btn--pause'</span>), () <span class="cm-operator">=&gt;</span> <span class="cm-variable">setActiveMenu</span>(<span class="cm-variable">MENU_MAIN</span>));<br><br><span class="cm-comment">// Score Menu</span><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.play-again-btn'</span>), () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable">setActiveMenu</span>(<span class="cm-atom">null</span>);<br>    <span class="cm-variable">resetGame</span>();<br>});<br><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.menu-btn--score'</span>), () <span class="cm-operator">=&gt;</span> <span class="cm-variable">setActiveMenu</span>(<span class="cm-variable">MENU_MAIN</span>));<br><br><br><br><br><span class="cm-comment">////////////////////</span><br><span class="cm-comment">// Button Actions //</span><br><span class="cm-comment">////////////////////</span><br><br><span class="cm-comment">// Main Menu</span><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.play-normal-btn'</span>), () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable">setGameMode</span>(<span class="cm-variable">GAME_MODE_RANKED</span>);<br>    <span class="cm-variable">setActiveMenu</span>(<span class="cm-atom">null</span>);<br>    <span class="cm-variable">resetGame</span>();<br>});<br><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.play-casual-btn'</span>), () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable">setGameMode</span>(<span class="cm-variable">GAME_MODE_CASUAL</span>);<br>    <span class="cm-variable">setActiveMenu</span>(<span class="cm-atom">null</span>);<br>    <span class="cm-variable">resetGame</span>();<br>});<br><br><span class="cm-comment">// Pause Menu</span><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.resume-btn'</span>), () <span class="cm-operator">=&gt;</span> <span class="cm-variable">resumeGame</span>());<br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.menu-btn--pause'</span>), () <span class="cm-operator">=&gt;</span> <span class="cm-variable">setActiveMenu</span>(<span class="cm-variable">MENU_MAIN</span>));<br><br><span class="cm-comment">// Score Menu</span><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.play-again-btn'</span>), () <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-variable">setActiveMenu</span>(<span class="cm-atom">null</span>);<br>    <span class="cm-variable">resetGame</span>();<br>});<br><br><span class="cm-variable">handleClick</span>(<span class="cm-variable">$</span>(<span class="cm-string">'.menu-btn--score'</span>), () <span class="cm-operator">=&gt;</span> <span class="cm-variable">setActiveMenu</span>(<span class="cm-variable">MENU_MAIN</span>));<br><br><br><br><br><br><span class="cm-comment">// actions.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">//////////////////</span><br><span class="cm-comment">// MENU ACTIONS //</span><br><span class="cm-comment">//////////////////</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">setActiveMenu</span>(<span class="cm-def">menu</span>) {<br>    <span class="cm-variable">state</span>.<span class="cm-property">menus</span>.<span class="cm-property">active</span> <span class="cm-operator">=</span> <span class="cm-variable-2">menu</span>;<br>    <span class="cm-variable">renderMenus</span>();<br>}<br><br><br><span class="cm-comment">/////////////////</span><br><span class="cm-comment">// HUD ACTIONS //</span><br><span class="cm-comment">/////////////////</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">setScore</span>(<span class="cm-def">score</span>) {<br>    <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span> <span class="cm-operator">=</span> <span class="cm-variable-2">score</span>;<br>    <span class="cm-variable">renderScoreHud</span>();<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">incrementScore</span>(<span class="cm-def">inc</span>) {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable">isInGame</span>()) {<br>        <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">inc</span>;<br>        <span class="cm-keyword">if</span> (<span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {<br>            <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        }<br>        <span class="cm-variable">renderScoreHud</span>();<br>    }<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">setCubeCount</span>(<span class="cm-def">count</span>) {<br>    <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">cubeCount</span> <span class="cm-operator">=</span> <span class="cm-variable-2">count</span>;<br>    <span class="cm-variable">renderScoreHud</span>();<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">incrementCubeCount</span>(<span class="cm-def">inc</span>) {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable">isInGame</span>()) {<br>        <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">cubeCount</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">inc</span>;<br>        <span class="cm-variable">renderScoreHud</span>();<br>    }<br>}<br><br><br><span class="cm-comment">//////////////////</span><br><span class="cm-comment">// GAME ACTIONS //</span><br><span class="cm-comment">//////////////////</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">setGameMode</span>(<span class="cm-def">mode</span>) {<br>    <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">mode</span> <span class="cm-operator">=</span> <span class="cm-variable-2">mode</span>;<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">resetGame</span>() {<br>    <span class="cm-variable">resetAllTargets</span>();<br>    <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">time</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">resetAllCooldowns</span>();<br>    <span class="cm-variable">setScore</span>(<span class="cm-number">0</span>);<br>    <span class="cm-variable">setCubeCount</span>(<span class="cm-number">0</span>);<br>    <span class="cm-variable">spawnTime</span> <span class="cm-operator">=</span> <span class="cm-variable">getSpawnDelay</span>();<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">pauseGame</span>() {<br>    <span class="cm-variable">isInGame</span>() <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">setActiveMenu</span>(<span class="cm-variable">MENU_PAUSE</span>);<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">resumeGame</span>() {<br>    <span class="cm-variable">isPaused</span>() <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">setActiveMenu</span>(<span class="cm-atom">null</span>);<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">endGame</span>() {<br>    <span class="cm-variable">handleCanvasPointerUp</span>();<br>    <span class="cm-keyword">if</span> (<span class="cm-variable">isNewHighScore</span>()) {<br>        <span class="cm-variable">setHighScore</span>(<span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">score</span>);<br>    }<br>    <span class="cm-variable">setActiveMenu</span>(<span class="cm-variable">MENU_SCORE</span>);<br>}<br><br><br><br><span class="cm-comment">////////////////////////</span><br><span class="cm-comment">// KEYBOARD SHORTCUTS //</span><br><span class="cm-comment">////////////////////////</span><br><br><span class="cm-variable">window</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'keydown'</span>, <span class="cm-def">event</span> <span class="cm-operator">=&gt;</span> {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable-2">event</span>.<span class="cm-property">key</span> <span class="cm-operator">===</span> <span class="cm-string">'p'</span>) {<br>        <span class="cm-variable">isPaused</span>() <span class="cm-operator">?</span> <span class="cm-variable">resumeGame</span>() : <span class="cm-variable">pauseGame</span>();<br>    }<br>});<br><br><br><br><br><br><br><span class="cm-comment">// tick.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><br><span class="cm-keyword">let</span> <span class="cm-def">spawnTime</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">maxSpawnX</span> <span class="cm-operator">=</span> <span class="cm-number">450</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">pointerDelta</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> };<br><span class="cm-keyword">const</span> <span class="cm-def">pointerDeltaScaled</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> };<br><br><span class="cm-comment">// Temp slowmo state. Should be relocated once this stabilizes.</span><br><span class="cm-keyword">const</span> <span class="cm-def">slowmoDuration</span> <span class="cm-operator">=</span> <span class="cm-number">1500</span>;<br><span class="cm-keyword">let</span> <span class="cm-def">slowmoRemaining</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br><span class="cm-keyword">let</span> <span class="cm-def">spawnExtra</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br><span class="cm-keyword">const</span> <span class="cm-def">spawnExtraDelay</span> <span class="cm-operator">=</span> <span class="cm-number">300</span>;<br><span class="cm-keyword">let</span> <span class="cm-def">targetSpeed</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br><br><br><span class="cm-keyword">function</span> <span class="cm-def">tick</span>(<span class="cm-def">width</span>, <span class="cm-def">height</span>, <span class="cm-def">simTime</span>, <span class="cm-def">simSpeed</span>, <span class="cm-def">lag</span>) {<br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'frame'</span>);<br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'tick'</span>);<br><br>    <span class="cm-variable">state</span>.<span class="cm-property">game</span>.<span class="cm-property">time</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">simTime</span>;<br><br>    <span class="cm-keyword">if</span> (<span class="cm-variable">slowmoRemaining</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>) {<br>        <span class="cm-variable">slowmoRemaining</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">simTime</span>;<br>        <span class="cm-keyword">if</span> (<span class="cm-variable">slowmoRemaining</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {<br>            <span class="cm-variable">slowmoRemaining</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        }<br>        <span class="cm-variable">targetSpeed</span> <span class="cm-operator">=</span> <span class="cm-variable">pointerIsDown</span> <span class="cm-operator">?</span> <span class="cm-number">0.075</span> : <span class="cm-number">0.3</span>;<br>    } <span class="cm-keyword">else</span> {<br>        <span class="cm-keyword">const</span> <span class="cm-def">menuPointerDown</span> <span class="cm-operator">=</span> <span class="cm-variable">isMenuVisible</span>() <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">pointerIsDown</span>;<br>        <span class="cm-variable">targetSpeed</span> <span class="cm-operator">=</span> <span class="cm-variable-2">menuPointerDown</span> <span class="cm-operator">?</span> <span class="cm-number">0.025</span> : <span class="cm-number">1</span>;<br>    }<br><br>    <span class="cm-variable">renderSlowmoStatus</span>(<span class="cm-variable">slowmoRemaining</span> <span class="cm-operator">/</span> <span class="cm-variable">slowmoDuration</span>);<br><br>    <span class="cm-variable">gameSpeed</span> <span class="cm-operator">+=</span> (<span class="cm-variable">targetSpeed</span> <span class="cm-operator">-</span> <span class="cm-variable">gameSpeed</span>) <span class="cm-operator">/</span> <span class="cm-number">22</span> <span class="cm-operator">*</span> <span class="cm-variable-2">lag</span>;<br>    <span class="cm-variable">gameSpeed</span> <span class="cm-operator">=</span> <span class="cm-variable">clamp</span>(<span class="cm-variable">gameSpeed</span>, <span class="cm-number">0</span>, <span class="cm-number">1</span>);<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">centerX</span> <span class="cm-operator">=</span> <span class="cm-variable-2">width</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">centerY</span> <span class="cm-operator">=</span> <span class="cm-variable-2">height</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>;<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">simAirDrag</span> <span class="cm-operator">=</span> <span class="cm-number">1</span> <span class="cm-operator">-</span> (<span class="cm-variable">airDrag</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">simAirDragSpark</span> <span class="cm-operator">=</span> <span class="cm-number">1</span> <span class="cm-operator">-</span> (<span class="cm-variable">airDragSpark</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>);<br><br>    <span class="cm-comment">// Pointer Tracking</span><br>    <span class="cm-comment">// -------------------</span><br><br>    <span class="cm-comment">// Compute speed and x/y deltas.</span><br>    <span class="cm-comment">// There is also a "scaled" variant taking game speed into account. This serves two purposes:</span><br>    <span class="cm-comment">//  - Lag won't create large spikes in speed/deltas</span><br>    <span class="cm-comment">//  - In slow mo, speed is increased proportionately to match "reality". Without this boost,</span><br>    <span class="cm-comment">//    it feels like your actions are dampened in slow mo.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">forceMultiplier</span> <span class="cm-operator">=</span> <span class="cm-number">1</span> <span class="cm-operator">/</span> (<span class="cm-variable-2">simSpeed</span> <span class="cm-operator">*</span> <span class="cm-number">0.75</span> <span class="cm-operator">+</span> <span class="cm-number">0.25</span>);<br>    <span class="cm-variable">pointerDelta</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">pointerDelta</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">lastPointer</span> <span class="cm-operator">=</span> <span class="cm-variable">touchPoints</span>[<span class="cm-variable">touchPoints</span>.<span class="cm-property">length</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];<br><br>    <span class="cm-keyword">if</span> (<span class="cm-variable">pointerIsDown</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable-2">lastPointer</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-operator">!</span><span class="cm-variable-2">lastPointer</span>.<span class="cm-property">touchBreak</span>) {<br>        <span class="cm-variable">pointerDelta</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> (<span class="cm-variable">pointerScene</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">lastPointer</span>.<span class="cm-property">x</span>);<br>        <span class="cm-variable">pointerDelta</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> (<span class="cm-variable">pointerScene</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">lastPointer</span>.<span class="cm-property">y</span>);<br>        <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable">pointerDelta</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-variable-2">forceMultiplier</span>;<br>        <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable">pointerDelta</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-variable-2">forceMultiplier</span>;<br>    }<br>    <span class="cm-keyword">const</span> <span class="cm-def">pointerSpeed</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">hypot</span>(<span class="cm-variable">pointerDelta</span>.<span class="cm-property">x</span>, <span class="cm-variable">pointerDelta</span>.<span class="cm-property">y</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">pointerSpeedScaled</span> <span class="cm-operator">=</span> <span class="cm-variable-2">pointerSpeed</span> <span class="cm-operator">*</span> <span class="cm-variable-2">forceMultiplier</span>;<br><br>    <span class="cm-comment">// Track points for later calculations, including drawing trail.</span><br>    <span class="cm-variable">touchPoints</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">p</span>.<span class="cm-property">life</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">simTime</span>);<br><br>    <span class="cm-keyword">if</span> (<span class="cm-variable">pointerIsDown</span>) {<br>        <span class="cm-variable">touchPoints</span>.<span class="cm-property">push</span>({<br>            <span class="cm-property">x</span>: <span class="cm-variable">pointerScene</span>.<span class="cm-property">x</span>,<br>            <span class="cm-property">y</span>: <span class="cm-variable">pointerScene</span>.<span class="cm-property">y</span>,<br>            <span class="cm-property">life</span>: <span class="cm-variable">touchPointLife</span><br>        });<br>    }<br><br>    <span class="cm-keyword">while</span> (<span class="cm-variable">touchPoints</span>[<span class="cm-number">0</span>] <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">touchPoints</span>[<span class="cm-number">0</span>].<span class="cm-property">life</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span>) {<br>        <span class="cm-variable">touchPoints</span>.<span class="cm-property">shift</span>();<br>    }<br><br><br>    <span class="cm-comment">// Entity Manipulation</span><br>    <span class="cm-comment">// --------------------</span><br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'entities'</span>);<br><br>    <span class="cm-comment">// Spawn targets</span><br>    <span class="cm-variable">spawnTime</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">simTime</span>;<br>    <span class="cm-keyword">if</span> (<span class="cm-variable">spawnTime</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span>) {<br>        <span class="cm-keyword">if</span> (<span class="cm-variable">spawnExtra</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>) {<br>            <span class="cm-variable">spawnExtra</span><span class="cm-operator">--</span>;<br>            <span class="cm-variable">spawnTime</span> <span class="cm-operator">=</span> <span class="cm-variable">spawnExtraDelay</span>;<br>        } <span class="cm-keyword">else</span> {<br>            <span class="cm-variable">spawnTime</span> <span class="cm-operator">=</span> <span class="cm-variable">getSpawnDelay</span>();<br>        }<br>        <span class="cm-keyword">const</span> <span class="cm-def">target</span> <span class="cm-operator">=</span> <span class="cm-variable">getTarget</span>();<br>        <span class="cm-keyword">const</span> <span class="cm-def">spawnRadius</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">min</span>(<span class="cm-variable-2">centerX</span> <span class="cm-operator">*</span> <span class="cm-number">0.8</span>, <span class="cm-variable">maxSpawnX</span>);<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-variable-2">spawnRadius</span> <span class="cm-operator">*</span> <span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable-2">spawnRadius</span>);<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">centerY</span> <span class="cm-operator">+</span> <span class="cm-variable">targetHitRadius</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-variable">targetRadius</span><span class="cm-operator">*</span><span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable">targetRadius</span>);<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">xD</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-operator">-</span><span class="cm-number">2</span> <span class="cm-operator">/</span> <span class="cm-number">120</span>);<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">yD</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">20</span>;<br>        <span class="cm-variable">targets</span>.<span class="cm-property">push</span>(<span class="cm-variable-2">target</span>);<br>    }<br><br>    <span class="cm-comment">// Animate targets and remove when offscreen</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">leftBound</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable-2">centerX</span> <span class="cm-operator">+</span> <span class="cm-variable">targetRadius</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">rightBound</span> <span class="cm-operator">=</span> <span class="cm-variable-2">centerX</span> <span class="cm-operator">-</span> <span class="cm-variable">targetRadius</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">ceiling</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable-2">centerY</span> <span class="cm-operator">-</span> <span class="cm-number">120</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">boundDamping</span> <span class="cm-operator">=</span> <span class="cm-number">0.4</span>;<br><br>    <span class="cm-variable">targetLoop</span>:<br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-variable">targets</span>.<span class="cm-property">length</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">--</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">target</span> <span class="cm-operator">=</span> <span class="cm-variable">targets</span>[<span class="cm-variable-2">i</span>];<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">xD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">yD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">y</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">ceiling</span>) {<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">ceiling</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">yD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        }<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">leftBound</span>) {<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">leftBound</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">xD</span> <span class="cm-operator">*=</span> <span class="cm-operator">-</span><span class="cm-variable-2">boundDamping</span>;<br>        } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">rightBound</span>) {<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">rightBound</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">xD</span> <span class="cm-operator">*=</span> <span class="cm-operator">-</span><span class="cm-variable-2">boundDamping</span>;<br>        }<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">z</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">backboardZ</span>) {<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-variable">backboardZ</span>;<br>            <span class="cm-variable-2">target</span>.<span class="cm-property">zD</span> <span class="cm-operator">*=</span> <span class="cm-operator">-</span><span class="cm-variable-2">boundDamping</span>;<br>        }<br><br>        <span class="cm-variable-2">target</span>.<span class="cm-property">yD</span> <span class="cm-operator">+=</span> <span class="cm-variable">gravity</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">rotateX</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateXD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">rotateY</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateYD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZ</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">target</span>.<span class="cm-property">rotateZD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">transform</span>();<br>        <span class="cm-variable-2">target</span>.<span class="cm-property">project</span>();<br><br>        <span class="cm-comment">// Remove if offscreen</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">y</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">centerY</span> <span class="cm-operator">+</span> <span class="cm-variable">targetHitRadius</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>) {<br>            <span class="cm-variable">targets</span>.<span class="cm-property">splice</span>(<span class="cm-variable-2">i</span>, <span class="cm-number">1</span>);<br>            <span class="cm-variable">returnTarget</span>(<span class="cm-variable-2">target</span>);<br>            <span class="cm-keyword">if</span> (<span class="cm-variable">isInGame</span>()) {<br>                <span class="cm-keyword">if</span> (<span class="cm-variable">isCasualGame</span>()) {<br>                    <span class="cm-variable">incrementScore</span>(<span class="cm-operator">-</span><span class="cm-number">25</span>);<br>                } <span class="cm-keyword">else</span> {<br>                    <span class="cm-variable">endGame</span>();<br>                }<br>            }<br>            <span class="cm-keyword">continue</span>;<br>        }<br><br><br>        <span class="cm-comment">// If pointer is moving really fast, we want to hittest multiple points along the path.</span><br>        <span class="cm-comment">// We can't use scaled pointer speed to determine this, since we care about actual screen</span><br>        <span class="cm-comment">// distance covered.</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">hitTestCount</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">ceil</span>(<span class="cm-variable-2">pointerSpeed</span> <span class="cm-operator">/</span> <span class="cm-variable">targetRadius</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>);<br>        <span class="cm-comment">// Start loop at `1` and use `&lt;=` check, so we skip 0% and end up at 100%.</span><br>        <span class="cm-comment">// This omits the previous point position, and includes the most recent.</span><br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">ii</span><span class="cm-operator">=</span><span class="cm-number">1</span>; <span class="cm-variable-2">ii</span><span class="cm-operator">&lt;=</span><span class="cm-variable-2">hitTestCount</span>; <span class="cm-variable-2">ii</span><span class="cm-operator">++</span>) {<br>            <span class="cm-keyword">const</span> <span class="cm-def">percent</span> <span class="cm-operator">=</span> <span class="cm-number">1</span> <span class="cm-operator">-</span> (<span class="cm-variable-2">ii</span> <span class="cm-operator">/</span> <span class="cm-variable-2">hitTestCount</span>);<br>            <span class="cm-keyword">const</span> <span class="cm-def">hitX</span> <span class="cm-operator">=</span> <span class="cm-variable">pointerScene</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable">pointerDelta</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-variable-2">percent</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">hitY</span> <span class="cm-operator">=</span> <span class="cm-variable">pointerScene</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable">pointerDelta</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-variable-2">percent</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">distance</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">hypot</span>(<br>                <span class="cm-variable-2">hitX</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">projected</span>.<span class="cm-property">x</span>,<br>                <span class="cm-variable-2">hitY</span> <span class="cm-operator">-</span> <span class="cm-variable-2">target</span>.<span class="cm-property">projected</span>.<span class="cm-property">y</span><br>            );<br><br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">distance</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">targetHitRadius</span>) {<br>                <span class="cm-comment">// Hit! (though we don't want to allow hits on multiple sequential frames)</span><br>                <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">target</span>.<span class="cm-property">hit</span>) {<br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">hit</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;<br><br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">xD</span> <span class="cm-operator">+=</span> <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-variable">hitDampening</span>;<br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">yD</span> <span class="cm-operator">+=</span> <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-variable">hitDampening</span>;<br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">rotateXD</span> <span class="cm-operator">+=</span> <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-number">0.001</span>;<br>                    <span class="cm-variable-2">target</span>.<span class="cm-property">rotateYD</span> <span class="cm-operator">+=</span> <span class="cm-variable">pointerDeltaScaled</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-number">0.001</span>;<br><br>                    <span class="cm-keyword">const</span> <span class="cm-def">sparkSpeed</span> <span class="cm-operator">=</span> <span class="cm-number">7</span> <span class="cm-operator">+</span> <span class="cm-variable-2">pointerSpeedScaled</span> <span class="cm-operator">*</span> <span class="cm-number">0.125</span>;<br><br>                    <span class="cm-keyword">if</span> (<span class="cm-variable-2">pointerSpeedScaled</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">minPointerSpeed</span>) {<br>                        <span class="cm-variable-2">target</span>.<span class="cm-property">health</span><span class="cm-operator">--</span>;<br>                        <span class="cm-variable">incrementScore</span>(<span class="cm-number">10</span>);<br><br>                        <span class="cm-keyword">if</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">health</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span>) {<br>                            <span class="cm-variable">incrementCubeCount</span>(<span class="cm-number">1</span>);<br>                            <span class="cm-variable">createBurst</span>(<span class="cm-variable-2">target</span>, <span class="cm-variable-2">forceMultiplier</span>);<br>                            <span class="cm-variable">sparkBurst</span>(<span class="cm-variable-2">hitX</span>, <span class="cm-variable-2">hitY</span>, <span class="cm-number">8</span>, <span class="cm-variable-2">sparkSpeed</span>);<br>                            <span class="cm-keyword">if</span> (<span class="cm-variable-2">target</span>.<span class="cm-property">wireframe</span>) {<br>                                <span class="cm-variable">slowmoRemaining</span> <span class="cm-operator">=</span> <span class="cm-variable">slowmoDuration</span>;<br>                                <span class="cm-variable">spawnTime</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>                                <span class="cm-variable">spawnExtra</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>;<br>                            }<br>                            <span class="cm-variable">targets</span>.<span class="cm-property">splice</span>(<span class="cm-variable-2">i</span>, <span class="cm-number">1</span>);<br>                            <span class="cm-variable">returnTarget</span>(<span class="cm-variable-2">target</span>);<br>                        } <span class="cm-keyword">else</span> {<br>                            <span class="cm-variable">sparkBurst</span>(<span class="cm-variable-2">hitX</span>, <span class="cm-variable-2">hitY</span>, <span class="cm-number">8</span>, <span class="cm-variable-2">sparkSpeed</span>);<br>                            <span class="cm-variable">glueShedSparks</span>(<span class="cm-variable-2">target</span>);<br>                            <span class="cm-variable">updateTargetHealth</span>(<span class="cm-variable-2">target</span>, <span class="cm-number">0</span>);<br>                        }<br>                    } <span class="cm-keyword">else</span> {<br>                        <span class="cm-variable">incrementScore</span>(<span class="cm-number">5</span>);<br>                        <span class="cm-variable">sparkBurst</span>(<span class="cm-variable-2">hitX</span>, <span class="cm-variable-2">hitY</span>, <span class="cm-number">3</span>, <span class="cm-variable-2">sparkSpeed</span>);<br>                    }<br>                }<br>                <span class="cm-comment">// Break the current loop and continue the outer loop.</span><br>                <span class="cm-comment">// This skips to processing the next target.</span><br>                <span class="cm-keyword">continue</span> <span class="cm-variable">targetLoop</span>;<br>            }<br>        }<br><br>        <span class="cm-comment">// This code will only run if target hasn't been "hit".</span><br>        <span class="cm-variable-2">target</span>.<span class="cm-property">hit</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>    }<br><br>    <span class="cm-comment">// Animate fragments and remove when offscreen.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">fragBackboardZ</span> <span class="cm-operator">=</span> <span class="cm-variable">backboardZ</span> <span class="cm-operator">+</span> <span class="cm-variable">fragRadius</span>;<br>    <span class="cm-comment">// Allow fragments to move off-screen to sides for a while, since shadows are still visible.</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">fragLeftBound</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable-2">width</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">fragRightBound</span> <span class="cm-operator">=</span> <span class="cm-variable-2">width</span>;<br><br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-variable">frags</span>.<span class="cm-property">length</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">--</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">frag</span> <span class="cm-operator">=</span> <span class="cm-variable">frags</span>[<span class="cm-variable-2">i</span>];<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">xD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">yD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">z</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">zD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br><br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">xD</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">simAirDrag</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">yD</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">simAirDrag</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">zD</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">simAirDrag</span>;<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">frag</span>.<span class="cm-property">y</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">ceiling</span>) {<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">ceiling</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">yD</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>        }<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">frag</span>.<span class="cm-property">z</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">fragBackboardZ</span>) {<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">z</span> <span class="cm-operator">=</span> <span class="cm-variable-2">fragBackboardZ</span>;<br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">zD</span> <span class="cm-operator">*=</span> <span class="cm-operator">-</span><span class="cm-variable-2">boundDamping</span>;<br>        }<br><br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">yD</span> <span class="cm-operator">+=</span> <span class="cm-variable">gravity</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateX</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateXD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateY</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateYD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateZ</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">frag</span>.<span class="cm-property">rotateZD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">transform</span>();<br>        <span class="cm-variable-2">frag</span>.<span class="cm-property">project</span>();<br><br>        <span class="cm-comment">// Removal conditions</span><br>        <span class="cm-keyword">if</span> (<br>            <span class="cm-comment">// Bottom of screen</span><br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">projected</span>.<span class="cm-property">y</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">centerY</span> <span class="cm-operator">+</span> <span class="cm-variable">targetHitRadius</span> <span class="cm-operator">|</span><span class="cm-operator">|</span><br>            <span class="cm-comment">// Sides of screen</span><br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">projected</span>.<span class="cm-property">x</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">fragLeftBound</span> <span class="cm-operator">|</span><span class="cm-operator">|</span><br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">projected</span>.<span class="cm-property">x</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">fragRightBound</span> <span class="cm-operator">|</span><span class="cm-operator">|</span><br>            <span class="cm-comment">// Too close to camera</span><br>            <span class="cm-variable-2">frag</span>.<span class="cm-property">z</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">cameraFadeEndZ</span><br>        ) {<br>            <span class="cm-variable">frags</span>.<span class="cm-property">splice</span>(<span class="cm-variable-2">i</span>, <span class="cm-number">1</span>);<br>            <span class="cm-variable">returnFrag</span>(<span class="cm-variable-2">frag</span>);<br>            <span class="cm-keyword">continue</span>;<br>        }<br>    }<br><br>    <span class="cm-comment">// 2D sparks</span><br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-variable">sparks</span>.<span class="cm-property">length</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">--</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">spark</span> <span class="cm-operator">=</span> <span class="cm-variable">sparks</span>[<span class="cm-variable-2">i</span>];<br>        <span class="cm-variable-2">spark</span>.<span class="cm-property">life</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">simTime</span>;<br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">spark</span>.<span class="cm-property">life</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span>) {<br>            <span class="cm-variable">sparks</span>.<span class="cm-property">splice</span>(<span class="cm-variable-2">i</span>, <span class="cm-number">1</span>);<br>            <span class="cm-variable">returnSpark</span>(<span class="cm-variable-2">spark</span>);<br>            <span class="cm-keyword">continue</span>;<br>        }<br>        <span class="cm-variable-2">spark</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">spark</span>.<span class="cm-property">xD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">spark</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">spark</span>.<span class="cm-property">yD</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>        <span class="cm-variable-2">spark</span>.<span class="cm-property">xD</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">simAirDragSpark</span>;<br>        <span class="cm-variable-2">spark</span>.<span class="cm-property">yD</span> <span class="cm-operator">*=</span> <span class="cm-variable-2">simAirDragSpark</span>;<br>        <span class="cm-variable-2">spark</span>.<span class="cm-property">yD</span> <span class="cm-operator">+=</span> <span class="cm-variable">gravity</span> <span class="cm-operator">*</span> <span class="cm-variable-2">simSpeed</span>;<br>    }<br><br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'entities'</span>);<br><br>    <span class="cm-comment">// 3D transforms</span><br>    <span class="cm-comment">// -------------------</span><br><br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'3D'</span>);<br><br>    <span class="cm-comment">// Aggregate all scene vertices/polys</span><br>    <span class="cm-variable">allVertices</span>.<span class="cm-property">length</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">allPolys</span>.<span class="cm-property">length</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">allShadowVertices</span>.<span class="cm-property">length</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">allShadowPolys</span>.<span class="cm-property">length</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-variable">targets</span>.<span class="cm-property">forEach</span>(<span class="cm-def">entity</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable">allVertices</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">vertices</span>);<br>        <span class="cm-variable">allPolys</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">polys</span>);<br>        <span class="cm-variable">allShadowVertices</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">shadowVertices</span>);<br>        <span class="cm-variable">allShadowPolys</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">shadowPolys</span>);<br>    });<br><br>    <span class="cm-variable">frags</span>.<span class="cm-property">forEach</span>(<span class="cm-def">entity</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable">allVertices</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">vertices</span>);<br>        <span class="cm-variable">allPolys</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">polys</span>);<br>        <span class="cm-variable">allShadowVertices</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">shadowVertices</span>);<br>        <span class="cm-variable">allShadowPolys</span>.<span class="cm-property">push</span>(<span class="cm-meta">...</span><span class="cm-variable-2">entity</span>.<span class="cm-property">shadowPolys</span>);<br>    });<br><br>    <span class="cm-comment">// Scene calculations/transformations</span><br>    <span class="cm-variable">allPolys</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">computePolyNormal</span>(<span class="cm-variable-2">p</span>, <span class="cm-string">'normalWorld'</span>));<br>    <span class="cm-variable">allPolys</span>.<span class="cm-property">forEach</span>(<span class="cm-variable">computePolyDepth</span>);<br>    <span class="cm-variable">allPolys</span>.<span class="cm-property">sort</span>((<span class="cm-def">a</span>, <span class="cm-def">b</span>) <span class="cm-operator">=&gt;</span> <span class="cm-variable-2">b</span>.<span class="cm-property">depth</span> <span class="cm-operator">-</span> <span class="cm-variable-2">a</span>.<span class="cm-property">depth</span>);<br><br>    <span class="cm-comment">// Perspective projection</span><br>    <span class="cm-variable">allVertices</span>.<span class="cm-property">forEach</span>(<span class="cm-variable">projectVertex</span>);<br><br>    <span class="cm-variable">allPolys</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">computePolyNormal</span>(<span class="cm-variable-2">p</span>, <span class="cm-string">'normalCamera'</span>));<br><br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'3D'</span>);<br><br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'shadows'</span>);<br><br>    <span class="cm-comment">// Rotate shadow vertices to light source perspective</span><br>    <span class="cm-variable">transformVertices</span>(<br>        <span class="cm-variable">allShadowVertices</span>,<br>        <span class="cm-variable">allShadowVertices</span>,<br>        <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>,<br>        <span class="cm-variable">TAU</span><span class="cm-operator">/</span><span class="cm-number">8</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>,<br>        <span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-number">1</span><br>    );<br><br>    <span class="cm-variable">allShadowPolys</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">computePolyNormal</span>(<span class="cm-variable-2">p</span>, <span class="cm-string">'normalWorld'</span>));<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">shadowDistanceMult</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">hypot</span>(<span class="cm-number">1</span>, <span class="cm-number">1</span>);<br>    <span class="cm-keyword">const</span> <span class="cm-def">shadowVerticesLength</span> <span class="cm-operator">=</span> <span class="cm-variable">allShadowVertices</span>.<span class="cm-property">length</span>;<br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">shadowVerticesLength</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">distance</span> <span class="cm-operator">=</span> <span class="cm-variable">allVertices</span>[<span class="cm-variable-2">i</span>].<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable">backboardZ</span>;<br>        <span class="cm-variable">allShadowVertices</span>[<span class="cm-variable-2">i</span>].<span class="cm-property">z</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">shadowDistanceMult</span> <span class="cm-operator">*</span> <span class="cm-variable-2">distance</span>;<br>    }<br>    <span class="cm-variable">transformVertices</span>(<br>        <span class="cm-variable">allShadowVertices</span>,<br>        <span class="cm-variable">allShadowVertices</span>,<br>        <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>,<br>        <span class="cm-operator">-</span><span class="cm-variable">TAU</span><span class="cm-operator">/</span><span class="cm-number">8</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>,<br>        <span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-number">1</span><br>    );<br>    <span class="cm-variable">allShadowVertices</span>.<span class="cm-property">forEach</span>(<span class="cm-variable">projectVertex</span>);<br><br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'shadows'</span>);<br><br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'tick'</span>);<br>}<br><br><br><br><br><br><span class="cm-comment">// draw.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">draw</span>(<span class="cm-def">ctx</span>, <span class="cm-def">width</span>, <span class="cm-def">height</span>, <span class="cm-def">viewScale</span>) {<br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'draw'</span>);<br><br>    <span class="cm-keyword">const</span> <span class="cm-def">halfW</span> <span class="cm-operator">=</span> <span class="cm-variable-2">width</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">halfH</span> <span class="cm-operator">=</span> <span class="cm-variable-2">height</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>;<br><br><br>    <span class="cm-comment">// 3D Polys</span><br>    <span class="cm-comment">// ---------------</span><br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineJoin</span> <span class="cm-operator">=</span> <span class="cm-string">'bevel'</span>;<br><br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'drawShadows'</span>);<br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">fillStyle</span> <span class="cm-operator">=</span> <span class="cm-variable">shadowColor</span>;<br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-variable">shadowColor</span>;<br>    <span class="cm-variable">allShadowPolys</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">p</span>.<span class="cm-property">wireframe</span>) {<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>;<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">beginPath</span>();<br>            <span class="cm-keyword">const</span> { <span class="cm-def">vertices</span> } <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">vCount</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>.<span class="cm-property">length</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">firstV</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>[<span class="cm-number">0</span>];<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable-2">firstV</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">firstV</span>.<span class="cm-property">y</span>);<br>            <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">1</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">vCount</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>                <span class="cm-keyword">const</span> <span class="cm-def">v</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>[<span class="cm-variable-2">i</span>];<br>                <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable-2">v</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">v</span>.<span class="cm-property">y</span>);<br>            }<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">closePath</span>();<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">stroke</span>();<br>        } <span class="cm-keyword">else</span> {<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">beginPath</span>();<br>            <span class="cm-keyword">const</span> { <span class="cm-def">vertices</span> } <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">vCount</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>.<span class="cm-property">length</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">firstV</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>[<span class="cm-number">0</span>];<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable-2">firstV</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">firstV</span>.<span class="cm-property">y</span>);<br>            <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">1</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">vCount</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>                <span class="cm-keyword">const</span> <span class="cm-def">v</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>[<span class="cm-variable-2">i</span>];<br>                <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable-2">v</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">v</span>.<span class="cm-property">y</span>);<br>            }<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">closePath</span>();<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">fill</span>();<br>        }<br>    });<br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'drawShadows'</span>);<br><br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'drawPolys'</span>);<br><br>    <span class="cm-variable">allPolys</span>.<span class="cm-property">forEach</span>(<span class="cm-def">p</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">p</span>.<span class="cm-property">wireframe</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable-2">p</span>.<span class="cm-property">normalCamera</span>.<span class="cm-property">z</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) <span class="cm-keyword">return</span>;<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">p</span>.<span class="cm-property">strokeWidth</span> <span class="cm-operator">!==</span> <span class="cm-number">0</span>) {<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>.<span class="cm-property">normalCamera</span>.<span class="cm-property">z</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-variable-2">p</span>.<span class="cm-property">strokeWidth</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span> : <span class="cm-variable-2">p</span>.<span class="cm-property">strokeWidth</span>;<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>.<span class="cm-property">normalCamera</span>.<span class="cm-property">z</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-variable-2">p</span>.<span class="cm-property">strokeColorDark</span> : <span class="cm-variable-2">p</span>.<span class="cm-property">strokeColor</span>;<br>        }<br><br>        <span class="cm-keyword">const</span> { <span class="cm-def">vertices</span> } <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">lastV</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vertices</span>[<span class="cm-variable-2">vertices</span>.<span class="cm-property">length</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];<br>        <span class="cm-keyword">const</span> <span class="cm-def">fadeOut</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>.<span class="cm-property">middle</span>.<span class="cm-property">z</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">cameraFadeStartZ</span>;<br><br>        <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">p</span>.<span class="cm-property">wireframe</span>) {<br>            <span class="cm-keyword">const</span> <span class="cm-def">normalLight</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p</span>.<span class="cm-property">normalWorld</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span> <span class="cm-operator">+</span> <span class="cm-variable-2">p</span>.<span class="cm-property">normalWorld</span>.<span class="cm-property">z</span> <span class="cm-operator">*</span> <span class="cm-operator">-</span><span class="cm-number">0.5</span>;<br>            <span class="cm-keyword">const</span> <span class="cm-def">lightness</span> <span class="cm-operator">=</span> <span class="cm-variable-2">normalLight</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span><br>                <span class="cm-operator">?</span> <span class="cm-number">0.1</span><br>                : ((<span class="cm-variable-2">normalLight</span> <span class="cm-operator">**</span> <span class="cm-number">32</span> <span class="cm-operator">-</span> <span class="cm-variable-2">normalLight</span>) <span class="cm-operator">/</span> <span class="cm-number">2</span>) <span class="cm-operator">*</span> <span class="cm-number">0.9</span> <span class="cm-operator">+</span> <span class="cm-number">0.1</span>;<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">fillStyle</span> <span class="cm-operator">=</span> <span class="cm-variable">shadeColor</span>(<span class="cm-variable-2">p</span>.<span class="cm-property">color</span>, <span class="cm-variable-2">lightness</span>);<br>        }<br><br>        <span class="cm-comment">// Fade out polys close to camera. `globalAlpha` must be reset later.</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">fadeOut</span>) {<br>            <span class="cm-comment">// If polygon gets really close to camera (outside `cameraFadeRange`) the alpha</span><br>            <span class="cm-comment">// can go negative, which has the appearance of alpha = 1. So, we'll clamp it at 0.</span><br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">globalAlpha</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>(<span class="cm-number">0</span>, <span class="cm-number">1</span> <span class="cm-operator">-</span> (<span class="cm-variable-2">p</span>.<span class="cm-property">middle</span>.<span class="cm-property">z</span> <span class="cm-operator">-</span> <span class="cm-variable">cameraFadeStartZ</span>) <span class="cm-operator">/</span> <span class="cm-variable">cameraFadeRange</span>);<br>        }<br><br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">beginPath</span>();<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable-2">lastV</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">lastV</span>.<span class="cm-property">y</span>);<br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">v</span> <span class="cm-keyword">of</span> <span class="cm-variable-2">vertices</span>) {<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable-2">v</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">v</span>.<span class="cm-property">y</span>);<br>        }<br><br>        <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">p</span>.<span class="cm-property">wireframe</span>) {<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">fill</span>();<br>        }<br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">p</span>.<span class="cm-property">strokeWidth</span> <span class="cm-operator">!==</span> <span class="cm-number">0</span>) {<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">stroke</span>();<br>        }<br><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">fadeOut</span>) {<br>            <span class="cm-variable-2">ctx</span>.<span class="cm-property">globalAlpha</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br>        }<br>    });<br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'drawPolys'</span>);<br><br><br>    <span class="cm-variable">PERF_START</span>(<span class="cm-string">'draw2D'</span>);<br><br>    <span class="cm-comment">// 2D Sparks</span><br>    <span class="cm-comment">// ---------------</span><br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-variable">sparkColor</span>;<br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-variable">sparkThickness</span>;<br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">beginPath</span>();<br>    <span class="cm-variable">sparks</span>.<span class="cm-property">forEach</span>(<span class="cm-def">spark</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable-2">spark</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">spark</span>.<span class="cm-property">y</span>);<br>        <span class="cm-comment">// Shrink sparks to zero length as they die.</span><br>        <span class="cm-comment">// Speed up shrinking as life approaches 0 (root curve).</span><br>        <span class="cm-comment">// Note that sparks already get smaller over time as their speed slows</span><br>        <span class="cm-comment">// down from damping. So this is like a double scale down. To counter this</span><br>        <span class="cm-comment">// a bit and keep the sparks larger for longer, we'll also increase the scale</span><br>        <span class="cm-comment">// a bit after applying the root curve.</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">scale</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">spark</span>.<span class="cm-property">life</span> <span class="cm-operator">/</span> <span class="cm-variable-2">spark</span>.<span class="cm-property">maxLife</span>) <span class="cm-operator">**</span> <span class="cm-number">0.5</span> <span class="cm-operator">*</span> <span class="cm-number">1.5</span>;<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable-2">spark</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">spark</span>.<span class="cm-property">xD</span><span class="cm-operator">*</span><span class="cm-variable-2">scale</span>, <span class="cm-variable-2">spark</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">spark</span>.<span class="cm-property">yD</span><span class="cm-operator">*</span><span class="cm-variable-2">scale</span>);<br><br>    });<br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">stroke</span>();<br><br><br>    <span class="cm-comment">// Touch Strokes</span><br>    <span class="cm-comment">// ---------------</span><br><br>    <span class="cm-variable-2">ctx</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-variable">touchTrailColor</span>;<br>    <span class="cm-keyword">const</span> <span class="cm-def">touchPointCount</span> <span class="cm-operator">=</span> <span class="cm-variable">touchPoints</span>.<span class="cm-property">length</span>;<br>    <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">1</span>; <span class="cm-variable-2">i</span><span class="cm-operator">&lt;</span><span class="cm-variable-2">touchPointCount</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {<br>        <span class="cm-keyword">const</span> <span class="cm-def">current</span> <span class="cm-operator">=</span> <span class="cm-variable">touchPoints</span>[<span class="cm-variable-2">i</span>];<br>        <span class="cm-keyword">const</span> <span class="cm-def">prev</span> <span class="cm-operator">=</span> <span class="cm-variable">touchPoints</span>[<span class="cm-variable-2">i</span><span class="cm-operator">-</span><span class="cm-number">1</span>];<br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">current</span>.<span class="cm-property">touchBreak</span> <span class="cm-operator">|</span><span class="cm-operator">|</span> <span class="cm-variable-2">prev</span>.<span class="cm-property">touchBreak</span>) {<br>            <span class="cm-keyword">continue</span>;<br>        }<br>        <span class="cm-keyword">const</span> <span class="cm-def">scale</span> <span class="cm-operator">=</span> <span class="cm-variable-2">current</span>.<span class="cm-property">life</span> <span class="cm-operator">/</span> <span class="cm-variable">touchPointLife</span>;<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">scale</span> <span class="cm-operator">*</span> <span class="cm-variable">touchTrailThickness</span>;<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">beginPath</span>();<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable-2">prev</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">prev</span>.<span class="cm-property">y</span>);<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable-2">current</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">current</span>.<span class="cm-property">y</span>);<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">stroke</span>();<br>    }<br><br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'draw2D'</span>);<br><br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'draw'</span>);<br>    <span class="cm-variable">PERF_END</span>(<span class="cm-string">'frame'</span>);<br><br>    <span class="cm-comment">// Display performance updates.</span><br>    <span class="cm-variable">PERF_UPDATE</span>();<br>}<br><br><br><br><br><br><span class="cm-comment">// canvas.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">setupCanvases</span>() {<br>    <span class="cm-keyword">const</span> <span class="cm-def">ctx</span> <span class="cm-operator">=</span> <span class="cm-variable">canvas</span>.<span class="cm-property">getContext</span>(<span class="cm-string">'2d'</span>);<br>    <span class="cm-comment">// devicePixelRatio alias</span><br>    <span class="cm-keyword">const</span> <span class="cm-def">dpr</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">devicePixelRatio</span> <span class="cm-operator">|</span><span class="cm-operator">|</span> <span class="cm-number">1</span>;<br>    <span class="cm-comment">// View will be scaled so objects appear sized similarly on all screen sizes.</span><br>    <span class="cm-keyword">let</span> <span class="cm-def">viewScale</span>;<br>    <span class="cm-comment">// Dimensions (taking viewScale into account!)</span><br>    <span class="cm-keyword">let</span> <span class="cm-def">width</span>, <span class="cm-def">height</span>;<br><br>    <span class="cm-keyword">function</span> <span class="cm-def">handleResize</span>() {<br>        <span class="cm-keyword">const</span> <span class="cm-def">w</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">innerWidth</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">h</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">innerHeight</span>;<br>        <span class="cm-variable-2">viewScale</span> <span class="cm-operator">=</span> <span class="cm-variable-2">h</span> <span class="cm-operator">/</span> <span class="cm-number">1000</span>;<br>        <span class="cm-variable-2">width</span> <span class="cm-operator">=</span> <span class="cm-variable-2">w</span> <span class="cm-operator">/</span> <span class="cm-variable-2">viewScale</span>;<br>        <span class="cm-variable-2">height</span> <span class="cm-operator">=</span> <span class="cm-variable-2">h</span> <span class="cm-operator">/</span> <span class="cm-variable-2">viewScale</span>;<br>        <span class="cm-variable">canvas</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-variable-2">w</span> <span class="cm-operator">*</span> <span class="cm-variable-2">dpr</span>;<br>        <span class="cm-variable">canvas</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-variable-2">h</span> <span class="cm-operator">*</span> <span class="cm-variable-2">dpr</span>;<br>        <span class="cm-variable">canvas</span>.<span class="cm-property">style</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-variable-2">w</span> <span class="cm-operator">+</span> <span class="cm-string">'px'</span>;<br>        <span class="cm-variable">canvas</span>.<span class="cm-property">style</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-variable-2">h</span> <span class="cm-operator">+</span> <span class="cm-string">'px'</span>;<br>    }<br><br>    <span class="cm-comment">// Set initial size</span><br>    <span class="cm-variable-2">handleResize</span>();<br>    <span class="cm-comment">// resize fullscreen canvas</span><br>    <span class="cm-variable">window</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'resize'</span>, <span class="cm-variable-2">handleResize</span>);<br><br><br>    <span class="cm-comment">// Run game loop</span><br>    <span class="cm-keyword">let</span> <span class="cm-def">lastTimestamp</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>    <span class="cm-keyword">function</span> <span class="cm-def">frameHandler</span>(<span class="cm-def">timestamp</span>) {<br>        <span class="cm-keyword">let</span> <span class="cm-def">frameTime</span> <span class="cm-operator">=</span> <span class="cm-variable-2">timestamp</span> <span class="cm-operator">-</span> <span class="cm-variable-2">lastTimestamp</span>;<br>        <span class="cm-variable-2">lastTimestamp</span> <span class="cm-operator">=</span> <span class="cm-variable-2">timestamp</span>;<br><br>        <span class="cm-comment">// always queue another frame</span><br>        <span class="cm-variable">raf</span>();<br><br>        <span class="cm-comment">// If game is paused, we'll still track frameTime (above) but all other</span><br>        <span class="cm-comment">// game logic and drawing can be avoided.</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable">isPaused</span>()) <span class="cm-keyword">return</span>;<br><br>        <span class="cm-comment">// make sure negative time isn't reported (first frame can be whacky)</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable-2">frameTime</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {<br>            <span class="cm-variable-2">frameTime</span> <span class="cm-operator">=</span> <span class="cm-number">17</span>;<br>        }<br>        <span class="cm-comment">// - cap minimum framerate to 15fps[~68ms] (assuming 60fps[~17ms] as 'normal')</span><br>        <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable-2">frameTime</span> <span class="cm-operator">&gt;</span> <span class="cm-number">68</span>) {<br>            <span class="cm-variable-2">frameTime</span> <span class="cm-operator">=</span> <span class="cm-number">68</span>;<br>        }<br><br>        <span class="cm-keyword">const</span> <span class="cm-def">halfW</span> <span class="cm-operator">=</span> <span class="cm-variable-2">width</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">halfH</span> <span class="cm-operator">=</span> <span class="cm-variable-2">height</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>;<br><br>        <span class="cm-comment">// Convert pointer position from screen to scene coords.</span><br>        <span class="cm-variable">pointerScene</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable">pointerScreen</span>.<span class="cm-property">x</span> <span class="cm-operator">/</span> <span class="cm-variable-2">viewScale</span> <span class="cm-operator">-</span> <span class="cm-variable-2">halfW</span>;<br>        <span class="cm-variable">pointerScene</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable">pointerScreen</span>.<span class="cm-property">y</span> <span class="cm-operator">/</span> <span class="cm-variable-2">viewScale</span> <span class="cm-operator">-</span> <span class="cm-variable-2">halfH</span>;<br><br>        <span class="cm-keyword">const</span> <span class="cm-def">lag</span> <span class="cm-operator">=</span> <span class="cm-variable-2">frameTime</span> <span class="cm-operator">/</span> <span class="cm-number">16.6667</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">simTime</span> <span class="cm-operator">=</span> <span class="cm-variable">gameSpeed</span> <span class="cm-operator">*</span> <span class="cm-variable-2">frameTime</span>;<br>        <span class="cm-keyword">const</span> <span class="cm-def">simSpeed</span> <span class="cm-operator">=</span> <span class="cm-variable">gameSpeed</span> <span class="cm-operator">*</span> <span class="cm-variable-2">lag</span>;<br>        <span class="cm-variable">tick</span>(<span class="cm-variable-2">width</span>, <span class="cm-variable-2">height</span>, <span class="cm-variable-2">simTime</span>, <span class="cm-variable-2">simSpeed</span>, <span class="cm-variable-2">lag</span>);<br><br>        <span class="cm-comment">// Auto clear canvas</span><br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">clearRect</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-variable">canvas</span>.<span class="cm-property">width</span>, <span class="cm-variable">canvas</span>.<span class="cm-property">height</span>);<br>        <span class="cm-comment">// Auto scale drawing for high res displays, and incorporate `viewScale`.</span><br>        <span class="cm-comment">// Also shift canvas so (0, 0) is the middle of the screen.</span><br>        <span class="cm-comment">// This just works with 3D perspective projection.</span><br>        <span class="cm-keyword">const</span> <span class="cm-def">drawScale</span> <span class="cm-operator">=</span> <span class="cm-variable-2">dpr</span> <span class="cm-operator">*</span> <span class="cm-variable-2">viewScale</span>;<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">scale</span>(<span class="cm-variable-2">drawScale</span>, <span class="cm-variable-2">drawScale</span>);<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">translate</span>(<span class="cm-variable-2">halfW</span>, <span class="cm-variable-2">halfH</span>);<br>        <span class="cm-variable">draw</span>(<span class="cm-variable-2">ctx</span>, <span class="cm-variable-2">width</span>, <span class="cm-variable-2">height</span>, <span class="cm-variable-2">viewScale</span>);<br>        <span class="cm-variable-2">ctx</span>.<span class="cm-property">setTransform</span>(<span class="cm-number">1</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">1</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>);<br>    }<br>    <span class="cm-keyword">const</span> <span class="cm-def">raf</span> <span class="cm-operator">=</span> () <span class="cm-operator">=&gt;</span> <span class="cm-variable">requestAnimationFrame</span>(<span class="cm-variable-2">frameHandler</span>);<br>    <span class="cm-comment">// Start loop</span><br>    <span class="cm-variable-2">raf</span>();<br>}<br><br><br><br><br><br><span class="cm-comment">// interaction.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-comment">// Interaction</span><br><span class="cm-comment">// -----------------------------</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">handleCanvasPointerDown</span>(<span class="cm-def">x</span>, <span class="cm-def">y</span>) {<br>    <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">pointerIsDown</span>) {<br>        <span class="cm-variable">pointerIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;<br>        <span class="cm-variable">pointerScreen</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x</span>;<br>        <span class="cm-variable">pointerScreen</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y</span>;<br>        <span class="cm-comment">// On when menus are open, point down/up toggles an interactive mode.</span><br>        <span class="cm-comment">// We just need to rerender the menu system for it to respond.</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable">isMenuVisible</span>()) <span class="cm-variable">renderMenus</span>();<br>    }<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">handleCanvasPointerUp</span>() {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable">pointerIsDown</span>) {<br>        <span class="cm-variable">pointerIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>        <span class="cm-variable">touchPoints</span>.<span class="cm-property">push</span>({<br>            <span class="cm-property">touchBreak</span>: <span class="cm-atom">true</span>,<br>            <span class="cm-property">life</span>: <span class="cm-variable">touchPointLife</span><br>        });<br>        <span class="cm-comment">// On when menus are open, point down/up toggles an interactive mode.</span><br>        <span class="cm-comment">// We just need to rerender the menu system for it to respond.</span><br>        <span class="cm-keyword">if</span> (<span class="cm-variable">isMenuVisible</span>()) <span class="cm-variable">renderMenus</span>();<br>    }<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">handleCanvasPointerMove</span>(<span class="cm-def">x</span>, <span class="cm-def">y</span>) {<br>    <span class="cm-keyword">if</span> (<span class="cm-variable">pointerIsDown</span>) {<br>        <span class="cm-variable">pointerScreen</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x</span>;<br>        <span class="cm-variable">pointerScreen</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y</span>;<br>    }<br>}<br><br><br><span class="cm-comment">// Use pointer events if available, otherwise fallback to touch events (for iOS).</span><br><span class="cm-keyword">if</span> (<span class="cm-string">'PointerEvent'</span> <span class="cm-keyword">in</span> <span class="cm-variable">window</span>) {<br>    <span class="cm-variable">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'pointerdown'</span>, <span class="cm-def">event</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable-2">event</span>.<span class="cm-property">isPrimary</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">handleCanvasPointerDown</span>(<span class="cm-variable-2">event</span>.<span class="cm-property">clientX</span>, <span class="cm-variable-2">event</span>.<span class="cm-property">clientY</span>);<br>    });<br><br>    <span class="cm-variable">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'pointerup'</span>, <span class="cm-def">event</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable-2">event</span>.<span class="cm-property">isPrimary</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">handleCanvasPointerUp</span>();<br>    });<br><br>    <span class="cm-variable">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'pointermove'</span>, <span class="cm-def">event</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-variable-2">event</span>.<span class="cm-property">isPrimary</span> <span class="cm-operator">&amp;</span><span class="cm-operator">&amp;</span> <span class="cm-variable">handleCanvasPointerMove</span>(<span class="cm-variable-2">event</span>.<span class="cm-property">clientX</span>, <span class="cm-variable-2">event</span>.<span class="cm-property">clientY</span>);<br>    });<br><br>    <span class="cm-comment">// We also need to know if the mouse leaves the page. For this game, it's best if that</span><br>    <span class="cm-comment">// cancels a swipe, so essentially acts as a "mouseup" event.</span><br>    <span class="cm-variable">document</span>.<span class="cm-property">body</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'mouseleave'</span>, <span class="cm-variable">handleCanvasPointerUp</span>);<br>} <span class="cm-keyword">else</span> {<br>    <span class="cm-keyword">let</span> <span class="cm-def">activeTouchId</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;<br>    <span class="cm-variable">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'touchstart'</span>, <span class="cm-def">event</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">pointerIsDown</span>) {<br>            <span class="cm-keyword">const</span> <span class="cm-def">touch</span> <span class="cm-operator">=</span> <span class="cm-variable-2">event</span>.<span class="cm-property">changedTouches</span>[<span class="cm-number">0</span>];<br>            <span class="cm-variable-2">activeTouchId</span> <span class="cm-operator">=</span> <span class="cm-variable-2">touch</span>.<span class="cm-property">identifier</span>;<br>            <span class="cm-variable">handleCanvasPointerDown</span>(<span class="cm-variable-2">touch</span>.<span class="cm-property">clientX</span>, <span class="cm-variable-2">touch</span>.<span class="cm-property">clientY</span>);<br>        }<br>    });<br>    <span class="cm-variable">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'touchend'</span>, <span class="cm-def">event</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">touch</span> <span class="cm-keyword">of</span> <span class="cm-variable-2">event</span>.<span class="cm-property">changedTouches</span>) {<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">touch</span>.<span class="cm-property">identifier</span> <span class="cm-operator">===</span> <span class="cm-variable-2">activeTouchId</span>) {<br>                <span class="cm-variable">handleCanvasPointerUp</span>();<br>                <span class="cm-keyword">break</span>;<br>            }<br>        }<br>    });<br>    <span class="cm-variable">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'touchmove'</span>, <span class="cm-def">event</span> <span class="cm-operator">=&gt;</span> {<br>        <span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">touch</span> <span class="cm-keyword">of</span> <span class="cm-variable-2">event</span>.<span class="cm-property">changedTouches</span>) {<br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">touch</span>.<span class="cm-property">identifier</span> <span class="cm-operator">===</span> <span class="cm-variable-2">activeTouchId</span>) {<br>                <span class="cm-variable">handleCanvasPointerMove</span>(<span class="cm-variable-2">touch</span>.<span class="cm-property">clientX</span>, <span class="cm-variable-2">touch</span>.<span class="cm-property">clientY</span>);<br>                <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();<br>                <span class="cm-keyword">break</span>;<br>            }<br>        }<br>    }, { <span class="cm-property">passive</span>: <span class="cm-atom">false</span> });<br>}<br><br><br><br><br><br><span class="cm-comment">// index.js</span><br><span class="cm-comment">// ============================================================================</span><br><span class="cm-comment">// ============================================================================</span><br><br><span class="cm-variable">setupCanvases</span>();<br></code></pre>
</div>
<div id="result-box" class="code-box active" role="region" aria-label="Result">
<iframe id="result-iframe" class="result-iframe " sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media" tabindex="-1" data-src="https://s.codepen.io/MillerTime/fullembedgrid/BexBbE?type=embed&amp;animations=run" src="./BexBbE(1).html" allowtransparency="true" frameborder="0" scrolling="yes" allowpaymentrequest="true" allowfullscreen="true" name="CodePen Preview for Menja" title="CodePen Preview for Menja">
      </iframe>
</div>
<div id="about-box">
<div class="about-container">
<div class="about-user">
<a href="https://codepen.io/MillerTime" target="_blank" rel="noopener" class="about-image" style="background-image: url(https://s.cdpn.io/profiles/user/329180/512.jpg?100000)"></a>
<div class="about-user-info">
<p>
This Pen is owned by <a href="https://codepen.io/MillerTime" target="_blank" rel="noopener">Caleb Miller</a> on <a href="https://codepen.io/" target="_blank" rel="noopener">CodePen</a>.
</p>
<p>
<a href="https://codepen.io/MillerTime" target="_blank" rel="noopener" class="about-user-more">
See more by @MillerTime on CodePen
</a>
</p>
</div>
</div>
</div>
</div>
</div>
<footer class="embed-footer" id="embed-footer">
<button id="resources-link" class="resources-link action-button bottom left" href="#resources-box" aria-pressed="false" role="button">
Resources
</button>
<ul class="scaling-choices bottom right">
<li><button class="action-button active" id="zoom-button-1">1×</button></li><li><button class="action-button" id="zoom-button-05">0.5×</button></li><li><button class="action-button" id="zoom-button-025">0.25×</button></li>
</ul>
<button id="rerun-button" class="action-button rerun-button bottom right">
Rerun
</button>
</footer>
<div class="resources-box" id="resources-box">
<h3>External CSS</h3>
<p>
This Pen doesn't use any external CSS resources.
</p>
<h3>External JavaScript</h3>
<p>
This Pen doesn't use any external JavaScript resources.
</p>
</div>
<script>
    __processedPen = {"html":"&lt;!-- Game canvas --&gt;\n&lt;canvas id=&quot;c&quot;&gt;&lt;/canvas&gt;\n\n&lt;!-- Gameplay HUD --&gt;\n&lt;div class=&quot;hud&quot;&gt;\n\t&lt;div class=&quot;hud__score&quot;&gt;\n\t\t&lt;div class=&quot;score-lbl&quot;&gt;&lt;/div&gt;\n\t\t&lt;div class=&quot;cube-count-lbl&quot;&gt;&lt;/div&gt;\n\t&lt;/div&gt;\n\t&lt;div class=&quot;pause-btn&quot;&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;\n\t&lt;div class=&quot;slowmo&quot;&gt;\n\t\t&lt;div class=&quot;slowmo__bar&quot;&gt;&lt;/div&gt;\n\t&lt;/div&gt;\n&lt;/div&gt;\n\n&lt;!-- Menu System --&gt;\n&lt;div class=&quot;menus&quot;&gt;\n\t&lt;div class=&quot;menu menu--main&quot;&gt;\n\t\t&lt;h1&gt;MENJA&lt;/h1&gt;\n\t\t&lt;button type=&quot;button&quot; class=&quot;play-normal-btn&quot;&gt;PLAY GAME&lt;/button&gt;\n\t\t&lt;button type=&quot;button&quot; class=&quot;play-casual-btn&quot;&gt;CASUAL MODE&lt;/button&gt;\n\t\t&lt;div class=&quot;credits&quot;&gt;An 8kB game by &lt;a href=&quot;https://cmiller.tech&quot;&gt;Caleb Miller&lt;/a&gt;&lt;/div&gt;\n\t&lt;/div&gt;\n\t&lt;div class=&quot;menu menu--pause&quot;&gt;\n\t\t&lt;h1&gt;Paused&lt;/h1&gt;\n\t\t&lt;button type=&quot;button&quot; class=&quot;resume-btn&quot;&gt;RESUME GAME&lt;/button&gt;\n\t\t&lt;button type=&quot;button&quot; class=&quot;menu-btn--pause&quot;&gt;MAIN MENU&lt;/button&gt;\n\t&lt;/div&gt;\n\t&lt;div class=&quot;menu menu--score&quot;&gt;\n\t\t&lt;h1&gt;Game Over&lt;/h1&gt;\n\t\t&lt;h2&gt;Your Score:&lt;/h2&gt;\n\t\t&lt;div class=&quot;final-score-lbl&quot;&gt;&lt;/div&gt;\n\t\t&lt;div class=&quot;high-score-lbl&quot;&gt;&lt;/div&gt;\n\t\t&lt;button type=&quot;button&quot; class=&quot;play-again-btn&quot;&gt;PLAY AGAIN&lt;/button&gt;\n\t\t&lt;button type=&quot;button&quot; class=&quot;menu-btn--score&quot;&gt;MAIN MENU&lt;/button&gt;\n\t&lt;/div&gt;\n&lt;/div&gt;","css":"body {\n\tmargin: 0;\n\tbackground-color: #000;\n\tbackground-image: radial-gradient(ellipse at top, #335476 0.0%, #31506e 11.1%, #304b67 22.2%, #2f4760 33.3%, #2d4359 44.4%, #2c3f51 55.6%, #2a3a4a 66.7%, #293643 77.8%, #28323d 88.9%, #262e36 100.0%);\n\theight: 100vh;\n\toverflow: hidden;\n\n\tfont-family: monospace;\n\tfont-weight: bold;\n\tletter-spacing: 0.06em;\n\tcolor: rgba(255, 255, 255, 0.75);\n}\n\n#c {\n\tdisplay: block;\n\ttouch-action: none;\n\ttransform: translateZ(0);\n}\n\n\n/*/////////////////////\n//        HUD        //\n/////////////////////*/\n\n\n.hud__score,\n.pause-btn {\n\tposition: fixed;\n\tfont-size: calc(14px + 2vw + 1vh);\n}\n\n.hud__score {\n\ttop: 0.65em;\n\tleft: 0.65em;\n\tpointer-events: none;\n\tuser-select: none;\n}\n\n.cube-count-lbl {\n\tfont-size: 0.46em;\n}\n\n.pause-btn {\n\tposition: fixed;\n\ttop: 0;\n\tright: 0;\n\tpadding: 0.8em 0.65em;\n}\n\n.pause-btn &gt; div {\n\tposition: relative;\n\twidth: 0.8em;\n\theight: 0.8em;\n\topacity: 0.75;\n}\n\n.pause-btn &gt; div::before,\n.pause-btn &gt; div::after {\n\tcontent: &#39;&#39;;\n\tdisplay: block;\n\twidth: 34%;\n\theight: 100%;\n\tposition: absolute;\n\tbackground-color: #fff;\n}\n\n.pause-btn &gt; div::after {\n\tright: 0;\n}\n\n.slowmo {\n\tposition: fixed;\n\tbottom: 0;\n\twidth: 100%;\n\tpointer-events: none;\n\topacity: 0;\n\ttransition: opacity 0.4s;\n\twill-change: opacity;\n}\n\n.slowmo::before {\n\tcontent: &#39;SLOW-MO&#39;;\n\tdisplay: block;\n\tfont-size: calc(8px + 1vw + 0.5vh);\n\tmargin-left: 0.5em;\n\tmargin-bottom: 8px;\n}\n\n.slowmo::after {\n\tcontent: &#39;&#39;;\n\tdisplay: block;\n\tposition: fixed;\n\tbottom: 0;\n\twidth: 100%;\n\theight: 1.5vh;\n\tbackground-color: rgba(0, 0, 0, 0.25);\n\tz-index: -1;\n}\n\n.slowmo__bar {\n\theight: 1.5vh;\n\tbackground-color: rgba(255, 255, 255, 0.75);\n\ttransform-origin: 0 0;\n}\n\n\n\n/*/////////////////////\n//       MENUS       //\n/////////////////////*/\n\n.menus::before {\n\tcontent: &#39;&#39;;\n\tpointer-events: none;\n\tposition: fixed;\n\ttop: 0;\n\tright: 0;\n\tbottom: 0;\n\tleft: 0;\n\tbackground-color: #000;\n\topacity: 0;\n\ttransition: opacity 0.2s;\n\ttransition-timing-function: ease-in;\n}\n\n.menus.has-active::before {\n\topacity: 0.08;\n\ttransition-duration: 0.4s;\n\ttransition-timing-function: ease-out;\n}\n\n.menus.interactive-mode::before {\n\topacity: 0.02;\n}\n\n\n\n/* Menu containers */\n.menu {\n\tpointer-events: none;\n\tposition: fixed;\n\ttop: 0;\n\tright: 0;\n\tbottom: 0;\n\tleft: 0;\n\tdisplay: flex;\n\tflex-direction: column;\n\tjustify-content: center;\n\talign-items: center;\n\tuser-select: none;\n\ttext-align: center;\n\tcolor: rgba(255, 255, 255, 0.9);\n\topacity: 0;\n\tvisibility: hidden;\n\ttransform: translateY(30px);\n\ttransition-property: opacity, visibility, transform;\n\ttransition-duration: 0.2s;\n\ttransition-timing-function: ease-in;\n}\n\n.menu.active {\n\topacity: 1;\n\tvisibility: visible;\n\ttransform: translateY(0);\n\ttransition-duration: 0.4s;\n\ttransition-timing-function: ease-out;\n}\n\n.menus.interactive-mode .menu.active {\n\topacity: 0.6;\n}\n\n.menus:not(.interactive-mode) .menu.active &gt; * {\n\tpointer-events: auto;\n}\n\n\n/* Common menu elements */\n\nh1 {\n\tfont-size: 4rem;\n\tline-height: 0.95;\n\ttext-align: center;\n\tfont-weight: bold;\n\tmargin: 0 0.65em 1em;\n}\n\nh2 {\n\tfont-size: 1.2rem;\n\tline-height: 1;\n\ttext-align: center;\n\tfont-weight: bold;\n\tmargin: -1em 0.65em 1em;\n}\n\n.final-score-lbl {\n\tfont-size: 5rem;\n\tmargin: -0.2em 0 0;\n}\n\n.high-score-lbl {\n\tfont-size: 1.2rem;\n\tmargin: 0 0 2.5em;\n}\n\nbutton {\n\tdisplay: block;\n\tposition: relative;\n\twidth: 200px;\n\tpadding: 12px 20px;\n\tbackground: transparent;\n\tborder: none;\n\toutline: none;\n\tuser-select: none;\n\tfont-family: monospace;\n\tfont-weight: bold;\n\tfont-size: 1.4rem;\n\tcolor: #fff;\n\topacity: 0.75;\n\ttransition: opacity 0.3s;\n}\n\nbutton::before {\n\tcontent: &#39;&#39;;\n\tposition: absolute;\n\ttop: 0;\n\tright: 0;\n\tbottom: 0;\n\tleft: 0;\n\tbackground-color: rgba(255, 255, 255, 0.15);\n\ttransform: scale(0, 0);\n\topacity: 0;\n\ttransition: opacity 0.3s, transform 0.3s;\n}\n\n/* No `:focus` styles because this is a mouse/touch game! */\nbutton:active {\n\topacity: 1;\n}\n\nbutton:active::before {\n\ttransform: scale(1, 1);\n\topacity: 1;\n}\n\n.credits {\n\tposition: fixed;\n\twidth: 100%;\n\tleft: 0;\n\tbottom: 20px;\n}\n\na {\n\tcolor: white;\n}\n\n/* Only enable hover state on large screens */\n@media (min-width: 1025px) {\n\tbutton:hover {\n\t\topacity: 1;\n\t}\n\n\tbutton:hover::before {\n\t\ttransform: scale(1, 1);\n\t\topacity: 1;\n\t}\n}\n","js":"// globalConfig.js\n// ============================================================================\n// ============================================================================\n\n// Provides global variables used by the entire program.\n// Most of this should be configuration.\n\n// Timing multiplier for entire game engine.\nlet gameSpeed = 1;\n\n// Colors\nconst BLUE = { r: 0x67, g: 0xd7, b: 0xf0 };\nconst GREEN = { r: 0xa6, g: 0xe0, b: 0x2c };\nconst PINK = { r: 0xfa, g: 0x24, b: 0x73 };\nconst ORANGE = { r: 0xfe, g: 0x95, b: 0x22 };\nconst allColors = [BLUE, GREEN, PINK, ORANGE];\n\n// Gameplay\nconst getSpawnDelay = () =&gt; {\n  const spawnDelayMax = 1400;\n  const spawnDelayMin = 550;\n  const spawnDelay = spawnDelayMax - state.game.cubeCount * 3.1;\n  return Math.max(spawnDelay, spawnDelayMin);\n};\nconst doubleStrongEnableScore = 2000;\n// Number of cubes that must be smashed before activating a feature.\nconst slowmoThreshold = 10;\nconst strongThreshold = 25;\nconst spinnerThreshold = 25;\n\n// Interaction state\nlet pointerIsDown = false;\n// The last known position of the primary pointer in screen coordinates.`\nlet pointerScreen = { x: 0, y: 0 };\n// Same as `pointerScreen`, but converted to scene coordinates in rAF.\nlet pointerScene = { x: 0, y: 0 };\n// Minimum speed of pointer before &quot;hits&quot; are counted.\nconst minPointerSpeed = 60;\n// The hit speed affects the direction the target post-hit. This number dampens that force.\nconst hitDampening = 0.1;\n// Backboard receives shadows and is the farthest negative Z position of entities.\nconst backboardZ = -400;\nconst shadowColor = &#39;#262e36&#39;;\n// How much air drag is applied to standard objects\nconst airDrag = 0.022;\nconst gravity = 0.3;\n// Spark config\nconst sparkColor = &#39;rgba(170,221,255,.9)&#39;;\nconst sparkThickness = 2.2;\nconst airDragSpark = 0.1;\n// Track pointer positions to show trail\nconst touchTrailColor = &#39;rgba(170,221,255,.62)&#39;;\nconst touchTrailThickness = 7;\nconst touchPointLife = 120;\nconst touchPoints = [];\n// Size of in-game targets. This affects rendered size and hit area.\nconst targetRadius = 40;\nconst targetHitRadius = 50;\nconst makeTargetGlueColor = target =&gt; {\n  // const alpha = (target.health - 1) / (target.maxHealth - 1);\n  // return `rgba(170,221,255,${alpha.toFixed(3)})`;\n  return &#39;rgb(170,221,255)&#39;;\n};\n// Size of target fragments\nconst fragRadius = targetRadius / 3;\n\n\n\n// Game canvas element needed in setup.js and interaction.js\nconst canvas = document.querySelector(&#39;#c&#39;);\n\n// 3D camera config\n// Affects perspective\nconst cameraDistance = 900;\n// Does not affect perspective\nconst sceneScale = 1;\n// Objects that get too close to the camera will be faded out to transparent over this range.\n// const cameraFadeStartZ = 0.8*cameraDistance - 6*targetRadius;\nconst cameraFadeStartZ = 0.45 * cameraDistance;\nconst cameraFadeEndZ = 0.65 * cameraDistance;\nconst cameraFadeRange = cameraFadeEndZ - cameraFadeStartZ;\n\n// Globals used to accumlate all vertices/polygons in each frame\nconst allVertices = [];\nconst allPolys = [];\nconst allShadowVertices = [];\nconst allShadowPolys = [];\n\n\n\n\n// state.js\n// ============================================================================\n// ============================================================================\n\n///////////\n// Enums //\n///////////\n\n// Game Modes\nconst GAME_MODE_RANKED = Symbol(&#39;GAME_MODE_RANKED&#39;);\nconst GAME_MODE_CASUAL = Symbol(&#39;GAME_MODE_CASUAL&#39;);\n\n// Available Menus\nconst MENU_MAIN = Symbol(&#39;MENU_MAIN&#39;);\nconst MENU_PAUSE = Symbol(&#39;MENU_PAUSE&#39;);\nconst MENU_SCORE = Symbol(&#39;MENU_SCORE&#39;);\n\n\n\n//////////////////\n// Global State //\n//////////////////\n\nconst state = {\n  game: {\n    mode: GAME_MODE_RANKED,\n    // Run time of current game.\n    time: 0,\n    // Player score.\n    score: 0,\n    // Total number of cubes smashed in game.\n    cubeCount: 0 },\n\n  menus: {\n    // Set to `null` to hide all menus\n    active: MENU_MAIN } };\n\n\n\n\n////////////////////////////\n// Global State Selectors //\n////////////////////////////\n\nconst isInGame = () =&gt; !state.menus.active;\nconst isMenuVisible = () =&gt; !!state.menus.active;\nconst isCasualGame = () =&gt; state.game.mode === GAME_MODE_CASUAL;\nconst isPaused = () =&gt; state.menus.active === MENU_PAUSE;\n\n\n///////////////////\n// Local Storage //\n///////////////////\n\nconst highScoreKey = &#39;__menja__highScore&#39;;\nconst getHighScore = () =&gt; {\n  const raw = localStorage.getItem(highScoreKey);\n  return raw ? parseInt(raw, 10) : 0;\n};\n\nlet _lastHighscore = getHighScore();\nconst setHighScore = score =&gt; {\n  _lastHighscore = getHighScore();\n  localStorage.setItem(highScoreKey, String(score));\n};\n\nconst isNewHighScore = () =&gt; state.game.score &gt; _lastHighscore;\n\n\n\n\n// utils.js\n// ============================================================================\n// ============================================================================\n\n\nconst invariant = (condition, message) =&gt; {\n  if (!condition) throw new Error(message);\n};\n\n\n/////////\n// DOM //\n/////////\n\nconst $ = selector =&gt; document.querySelector(selector);\nconst handleClick = (element, handler) =&gt; element.addEventListener(&#39;click&#39;, handler);\nconst handlePointerDown = (element, handler) =&gt; {\n  element.addEventListener(&#39;touchstart&#39;, handler);\n  element.addEventListener(&#39;mousedown&#39;, handler);\n};\n\n\n\n////////////////////////\n// Formatting Helpers //\n////////////////////////\n\n// Converts a number into a formatted string with thousand separators.\nconst formatNumber = num =&gt; num.toLocaleString();\n\n\n\n////////////////////\n// Math Constants //\n////////////////////\n\nconst PI = Math.PI;\nconst TAU = Math.PI * 2;\nconst ETA = Math.PI * 0.5;\n\n\n\n//////////////////\n// Math Helpers //\n//////////////////\n\n// Clamps a number between min and max values (inclusive)\nconst clamp = (num, min, max) =&gt; Math.min(Math.max(num, min), max);\n\n// Linearly interpolate between numbers a and b by a specific amount.\n// mix &gt;= 0 &amp;&amp; mix &lt;= 1\nconst lerp = (a, b, mix) =&gt; (b - a) * mix + a;\n\n\n\n\n////////////////////\n// Random Helpers //\n////////////////////\n\n// Generates a random number between min (inclusive) and max (exclusive)\nconst random = (min, max) =&gt; Math.random() * (max - min) + min;\n\n// Generates a random integer between and possibly including min and max values\nconst randomInt = (min, max) =&gt; (Math.random() * (max - min + 1) | 0) + min;\n\n// Returns a random element from an array\nconst pickOne = arr =&gt; arr[Math.random() * arr.length | 0];\n\n\n\n\n///////////////////\n// Color Helpers //\n///////////////////\n\n// Converts an { r, g, b } color object to a 6-digit hex code.\nconst colorToHex = color =&gt; {\n  return &#39;#&#39; +\n  (color.r | 0).toString(16).padStart(2, &#39;0&#39;) +\n  (color.g | 0).toString(16).padStart(2, &#39;0&#39;) +\n  (color.b | 0).toString(16).padStart(2, &#39;0&#39;);\n};\n\n// Operates on an { r, g, b } color object.\n// Returns string hex code.\n// `lightness` must range from 0 to 1. 0 is pure black, 1 is pure white.\nconst shadeColor = (color, lightness) =&gt; {\n  let other, mix;\n  if (lightness &lt; 0.5) {\n    other = 0;\n    mix = 1 - lightness * 2;\n  } else {\n    other = 255;\n    mix = lightness * 2 - 1;\n  }\n  return &#39;#&#39; +\n  (lerp(color.r, other, mix) | 0).toString(16).padStart(2, &#39;0&#39;) +\n  (lerp(color.g, other, mix) | 0).toString(16).padStart(2, &#39;0&#39;) +\n  (lerp(color.b, other, mix) | 0).toString(16).padStart(2, &#39;0&#39;);\n};\n\n\n\n\n\n////////////////////\n// Timing Helpers //\n////////////////////\n\nconst _allCooldowns = [];\n\nconst makeCooldown = (rechargeTime, units = 1) =&gt; {\n  let timeRemaining = 0;\n  let lastTime = 0;\n\n  const initialOptions = { rechargeTime, units };\n\n  const updateTime = () =&gt; {\n    const now = state.game.time;\n    // Reset time remaining if time goes backwards.\n    if (now &lt; lastTime) {\n      timeRemaining = 0;\n    } else {\n      // update...\n      timeRemaining -= now - lastTime;\n      if (timeRemaining &lt; 0) timeRemaining = 0;\n    }\n    lastTime = now;\n  };\n\n  const canUse = () =&gt; {\n    updateTime();\n    return timeRemaining &lt;= rechargeTime * (units - 1);\n  };\n\n  const cooldown = {\n    canUse,\n    useIfAble() {\n      const usable = canUse();\n      if (usable) timeRemaining += rechargeTime;\n      return usable;\n    },\n    mutate(options) {\n      if (options.rechargeTime) {\n        // Apply recharge time delta so change takes effect immediately.\n        timeRemaining -= rechargeTime - options.rechargeTime;\n        if (timeRemaining &lt; 0) timeRemaining = 0;\n        rechargeTime = options.rechargeTime;\n      }\n      if (options.units) units = options.units;\n    },\n    reset() {\n      timeRemaining = 0;\n      lastTime = 0;\n      this.mutate(initialOptions);\n    } };\n\n\n  _allCooldowns.push(cooldown);\n\n  return cooldown;\n};\n\nconst resetAllCooldowns = () =&gt; _allCooldowns.forEach(cooldown =&gt; cooldown.reset());\n\nconst makeSpawner = ({ chance, cooldownPerSpawn, maxSpawns }) =&gt; {\n  const cooldown = makeCooldown(cooldownPerSpawn, maxSpawns);\n  return {\n    shouldSpawn() {\n      return Math.random() &lt;= chance &amp;&amp; cooldown.useIfAble();\n    },\n    mutate(options) {\n      if (options.chance) chance = options.chance;\n      cooldown.mutate({\n        rechargeTime: options.cooldownPerSpawn,\n        units: options.maxSpawns });\n\n    } };\n\n};\n\n\n\n\n////////////////////\n// Vector Helpers //\n////////////////////\n\nconst normalize = v =&gt; {\n  const mag = Math.hypot(v.x, v.y, v.z);\n  return {\n    x: v.x / mag,\n    y: v.y / mag,\n    z: v.z / mag };\n\n};\n\n// Curried math helpers\nconst add = a =&gt; b =&gt; a + b;\n// Curried vector helpers\nconst scaleVector = scale =&gt; vector =&gt; {\n  vector.x *= scale;\n  vector.y *= scale;\n  vector.z *= scale;\n};\n\n\n\n\n\n\n\n\n////////////////\n// 3D Helpers //\n////////////////\n\n// Clone array and all vertices.\nfunction cloneVertices(vertices) {\n  return vertices.map(v =&gt; ({ x: v.x, y: v.y, z: v.z }));\n}\n\n// Copy vertex data from one array into another.\n// Arrays must be the same length.\nfunction copyVerticesTo(arr1, arr2) {\n  const len = arr1.length;\n  for (let i = 0; i &lt; len; i++) {\n    const v1 = arr1[i];\n    const v2 = arr2[i];\n    v2.x = v1.x;\n    v2.y = v1.y;\n    v2.z = v1.z;\n  }\n}\n\n// Compute triangle midpoint.\n// Mutates `middle` property of given `poly`.\nfunction computeTriMiddle(poly) {\n  const v = poly.vertices;\n  poly.middle.x = (v[0].x + v[1].x + v[2].x) / 3;\n  poly.middle.y = (v[0].y + v[1].y + v[2].y) / 3;\n  poly.middle.z = (v[0].z + v[1].z + v[2].z) / 3;\n}\n\n// Compute quad midpoint.\n// Mutates `middle` property of given `poly`.\nfunction computeQuadMiddle(poly) {\n  const v = poly.vertices;\n  poly.middle.x = (v[0].x + v[1].x + v[2].x + v[3].x) / 4;\n  poly.middle.y = (v[0].y + v[1].y + v[2].y + v[3].y) / 4;\n  poly.middle.z = (v[0].z + v[1].z + v[2].z + v[3].z) / 4;\n}\n\nfunction computePolyMiddle(poly) {\n  if (poly.vertices.length === 3) {\n    computeTriMiddle(poly);\n  } else {\n    computeQuadMiddle(poly);\n  }\n}\n\n// Compute distance from any polygon (tri or quad) midpoint to camera.\n// Sets `depth` property of given `poly`.\n// Also triggers midpoint calculation, which mutates `middle` property of `poly`.\nfunction computePolyDepth(poly) {\n  computePolyMiddle(poly);\n  const dX = poly.middle.x;\n  const dY = poly.middle.y;\n  const dZ = poly.middle.z - cameraDistance;\n  poly.depth = Math.hypot(dX, dY, dZ);\n}\n\n// Compute normal of any polygon. Uses normalized vector cross product.\n// Mutates `normalName` property of given `poly`.\nfunction computePolyNormal(poly, normalName) {\n  // Store quick refs to vertices\n  const v1 = poly.vertices[0];\n  const v2 = poly.vertices[1];\n  const v3 = poly.vertices[2];\n  // Calculate difference of vertices, following winding order.\n  const ax = v1.x - v2.x;\n  const ay = v1.y - v2.y;\n  const az = v1.z - v2.z;\n  const bx = v1.x - v3.x;\n  const by = v1.y - v3.y;\n  const bz = v1.z - v3.z;\n  // Cross product\n  const nx = ay * bz - az * by;\n  const ny = az * bx - ax * bz;\n  const nz = ax * by - ay * bx;\n  // Compute magnitude of normal and normalize\n  const mag = Math.hypot(nx, ny, nz);\n  const polyNormal = poly[normalName];\n  polyNormal.x = nx / mag;\n  polyNormal.y = ny / mag;\n  polyNormal.z = nz / mag;\n}\n\n// Apply translation/rotation/scale to all given vertices.\n// If `vertices` and `target` are the same array, the vertices will be mutated in place.\n// If `vertices` and `target` are different arrays, `vertices` will not be touched, instead the\n// transformed values from `vertices` will be written to `target` array.\nfunction transformVertices(vertices, target, tX, tY, tZ, rX, rY, rZ, sX, sY, sZ) {\n  // Matrix multiplcation constants only need calculated once for all vertices.\n  const sinX = Math.sin(rX);\n  const cosX = Math.cos(rX);\n  const sinY = Math.sin(rY);\n  const cosY = Math.cos(rY);\n  const sinZ = Math.sin(rZ);\n  const cosZ = Math.cos(rZ);\n\n  // Using forEach() like map(), but with a (recycled) target array.\n  vertices.forEach((v, i) =&gt; {\n    const targetVertex = target[i];\n    // X axis rotation\n    const x1 = v.x;\n    const y1 = v.z * sinX + v.y * cosX;\n    const z1 = v.z * cosX - v.y * sinX;\n    // Y axis rotation\n    const x2 = x1 * cosY - z1 * sinY;\n    const y2 = y1;\n    const z2 = x1 * sinY + z1 * cosY;\n    // Z axis rotation\n    const x3 = x2 * cosZ - y2 * sinZ;\n    const y3 = x2 * sinZ + y2 * cosZ;\n    const z3 = z2;\n\n    // Scale, Translate, and set the transform.\n    targetVertex.x = x3 * sX + tX;\n    targetVertex.y = y3 * sY + tY;\n    targetVertex.z = z3 * sZ + tZ;\n  });\n}\n\n// 3D projection on a single vertex.\n// Directly mutates the vertex.\nconst projectVertex = v =&gt; {\n  const focalLength = cameraDistance * sceneScale;\n  const depth = focalLength / (cameraDistance - v.z);\n  v.x = v.x * depth;\n  v.y = v.y * depth;\n};\n\n// 3D projection on a single vertex.\n// Mutates a secondary target vertex.\nconst projectVertexTo = (v, target) =&gt; {\n  const focalLength = cameraDistance * sceneScale;\n  const depth = focalLength / (cameraDistance - v.z);\n  target.x = v.x * depth;\n  target.y = v.y * depth;\n};\n\n\n\n\n\n// PERF.js\n// ============================================================================\n// ============================================================================\n\n// Dummy no-op functions.\n// I use these in a special build for custom performance profiling.\nconst PERF_START = () =&gt; {};\nconst PERF_END = () =&gt; {};\nconst PERF_UPDATE = () =&gt; {};\n\n\n\n\n// 3dModels.js\n// ============================================================================\n// ============================================================================\n\n// Define models once. The origin is the center of the model.\n\n// A simple cube, 8 vertices, 6 quads.\n// Defaults to an edge length of 2 units, can be influenced with `scale`.\nfunction makeCubeModel({ scale = 1 }) {\n  return {\n    vertices: [\n    // top\n    { x: -scale, y: -scale, z: scale },\n    { x: scale, y: -scale, z: scale },\n    { x: scale, y: scale, z: scale },\n    { x: -scale, y: scale, z: scale },\n    // bottom\n    { x: -scale, y: -scale, z: -scale },\n    { x: scale, y: -scale, z: -scale },\n    { x: scale, y: scale, z: -scale },\n    { x: -scale, y: scale, z: -scale }],\n\n    polys: [\n    // z = 1\n    { vIndexes: [0, 1, 2, 3] },\n    // z = -1\n    { vIndexes: [7, 6, 5, 4] },\n    // y = 1\n    { vIndexes: [3, 2, 6, 7] },\n    // y = -1\n    { vIndexes: [4, 5, 1, 0] },\n    // x = 1\n    { vIndexes: [5, 6, 2, 1] },\n    // x = -1\n    { vIndexes: [0, 3, 7, 4] }] };\n\n\n}\n\n// Not very optimized - lots of duplicate vertices are generated.\nfunction makeRecursiveCubeModel({ recursionLevel, splitFn, color, scale = 1 }) {\n  const getScaleAtLevel = level =&gt; 1 / 3 ** level;\n\n  // We can model level 0 manually. It&#39;s just a single, centered, cube.\n  let cubeOrigins = [{ x: 0, y: 0, z: 0 }];\n\n  // Recursively replace cubes with smaller cubes.\n  for (let i = 1; i &lt;= recursionLevel; i++) {\n    const scale = getScaleAtLevel(i) * 2;\n    const cubeOrigins2 = [];\n    cubeOrigins.forEach(origin =&gt; {\n      cubeOrigins2.push(...splitFn(origin, scale));\n    });\n    cubeOrigins = cubeOrigins2;\n  }\n\n  const finalModel = { vertices: [], polys: [] };\n\n  // Generate single cube model and scale it.\n  const cubeModel = makeCubeModel({ scale: 1 });\n  cubeModel.vertices.forEach(scaleVector(getScaleAtLevel(recursionLevel)));\n\n  // Compute the max distance x, y, or z origin values will be.\n  // Same result as `Math.max(...cubeOrigins.map(o =&gt; o.x))`, but much faster.\n  const maxComponent = getScaleAtLevel(recursionLevel) * (3 ** recursionLevel - 1);\n\n  // Place cube geometry at each origin.\n  cubeOrigins.forEach((origin, cubeIndex) =&gt; {\n    // To compute occlusion (shading), find origin component with greatest\n    // magnitude and normalize it relative to `maxComponent`.\n    const occlusion = Math.max(\n    Math.abs(origin.x),\n    Math.abs(origin.y),\n    Math.abs(origin.z)) /\n    maxComponent;\n    // At lower iterations, occlusion looks better lightened up a bit.\n    const occlusionLighter = recursionLevel &gt; 2 ?\n    occlusion :\n    (occlusion + 0.8) / 1.8;\n    // Clone, translate vertices to origin, and apply scale\n    finalModel.vertices.push(\n    ...cubeModel.vertices.map(v =&gt; ({\n      x: (v.x + origin.x) * scale,\n      y: (v.y + origin.y) * scale,\n      z: (v.z + origin.z) * scale })));\n\n\n    // Clone polys, shift referenced vertex indexes, and compute color.\n    finalModel.polys.push(\n    ...cubeModel.polys.map(poly =&gt; ({\n      vIndexes: poly.vIndexes.map(add(cubeIndex * 8)) })));\n\n\n  });\n\n  return finalModel;\n}\n\n\n// o: Vector3D - Position of cube&#39;s origin (center).\n// s: Vector3D - Determines size of menger sponge.\nfunction mengerSpongeSplit(o, s) {\n  return [\n  // Top\n  { x: o.x + s, y: o.y - s, z: o.z + s },\n  { x: o.x + s, y: o.y - s, z: o.z + 0 },\n  { x: o.x + s, y: o.y - s, z: o.z - s },\n  { x: o.x + 0, y: o.y - s, z: o.z + s },\n  { x: o.x + 0, y: o.y - s, z: o.z - s },\n  { x: o.x - s, y: o.y - s, z: o.z + s },\n  { x: o.x - s, y: o.y - s, z: o.z + 0 },\n  { x: o.x - s, y: o.y - s, z: o.z - s },\n  // Bottom\n  { x: o.x + s, y: o.y + s, z: o.z + s },\n  { x: o.x + s, y: o.y + s, z: o.z + 0 },\n  { x: o.x + s, y: o.y + s, z: o.z - s },\n  { x: o.x + 0, y: o.y + s, z: o.z + s },\n  { x: o.x + 0, y: o.y + s, z: o.z - s },\n  { x: o.x - s, y: o.y + s, z: o.z + s },\n  { x: o.x - s, y: o.y + s, z: o.z + 0 },\n  { x: o.x - s, y: o.y + s, z: o.z - s },\n  // Middle\n  { x: o.x + s, y: o.y + 0, z: o.z + s },\n  { x: o.x + s, y: o.y + 0, z: o.z - s },\n  { x: o.x - s, y: o.y + 0, z: o.z + s },\n  { x: o.x - s, y: o.y + 0, z: o.z - s }];\n\n}\n\n\n\n// Helper to optimize models by merging duplicate vertices within a threshold,\n// and removing all polys that share the same vertices.\n// Directly mutates the model.\nfunction optimizeModel(model, threshold = 0.0001) {\n  const { vertices, polys } = model;\n\n  const compareVertices = (v1, v2) =&gt;\n  Math.abs(v1.x - v2.x) &lt; threshold &amp;&amp;\n  Math.abs(v1.y - v2.y) &lt; threshold &amp;&amp;\n  Math.abs(v1.z - v2.z) &lt; threshold;\n\n\n  const comparePolys = (p1, p2) =&gt; {\n    const v1 = p1.vIndexes;\n    const v2 = p2.vIndexes;\n    return (\n      (\n      v1[0] === v2[0] ||\n      v1[0] === v2[1] ||\n      v1[0] === v2[2] ||\n      v1[0] === v2[3]) &amp;&amp; (\n\n      v1[1] === v2[0] ||\n      v1[1] === v2[1] ||\n      v1[1] === v2[2] ||\n      v1[1] === v2[3]) &amp;&amp; (\n\n      v1[2] === v2[0] ||\n      v1[2] === v2[1] ||\n      v1[2] === v2[2] ||\n      v1[2] === v2[3]) &amp;&amp; (\n\n      v1[3] === v2[0] ||\n      v1[3] === v2[1] ||\n      v1[3] === v2[2] ||\n      v1[3] === v2[3]));\n\n\n  };\n\n\n  vertices.forEach((v, i) =&gt; {\n    v.originalIndexes = [i];\n  });\n\n  for (let i = vertices.length - 1; i &gt;= 0; i--) {\n    for (let ii = i - 1; ii &gt;= 0; ii--) {\n      const v1 = vertices[i];\n      const v2 = vertices[ii];\n      if (compareVertices(v1, v2)) {\n        vertices.splice(i, 1);\n        v2.originalIndexes.push(...v1.originalIndexes);\n        break;\n      }\n    }\n  }\n\n  vertices.forEach((v, i) =&gt; {\n    polys.forEach(p =&gt; {\n      p.vIndexes.forEach((vi, ii, arr) =&gt; {\n        const vo = v.originalIndexes;\n        if (vo.includes(vi)) {\n          arr[ii] = i;\n        }\n      });\n    });\n  });\n\n  polys.forEach(p =&gt; {\n    const vi = p.vIndexes;\n    p.sum = vi[0] + vi[1] + vi[2] + vi[3];\n  });\n  polys.sort((a, b) =&gt; b.sum - a.sum);\n\n  // Assumptions:\n  // 1. Each poly will either have no duplicates or 1 duplicate.\n  // 2. If two polys are equal, they are both hidden (two cubes touching),\n  //    therefore both can be removed.\n  for (let i = polys.length - 1; i &gt;= 0; i--) {\n    for (let ii = i - 1; ii &gt;= 0; ii--) {\n      const p1 = polys[i];\n      const p2 = polys[ii];\n      if (p1.sum !== p2.sum) break;\n      if (comparePolys(p1, p2)) {\n        polys.splice(i, 1);\n        polys.splice(ii, 1);\n        i--;\n        break;\n      }\n    }\n  }\n\n  return model;\n}\n\n\n\n\n\n// Entity.js\n// ============================================================================\n// ============================================================================\n\nclass Entity {\n  constructor({ model, color, wireframe = false }) {\n    const vertices = cloneVertices(model.vertices);\n    const shadowVertices = cloneVertices(model.vertices);\n    const colorHex = colorToHex(color);\n    const darkColorHex = shadeColor(color, 0.4);\n\n    const polys = model.polys.map(p =&gt; ({\n      vertices: p.vIndexes.map(vIndex =&gt; vertices[vIndex]),\n      color: color, // custom rgb color object\n      wireframe: wireframe,\n      strokeWidth: wireframe ? 2 : 0, // Set to non-zero value to draw stroke\n      strokeColor: colorHex, // must be a CSS color string\n      strokeColorDark: darkColorHex, // must be a CSS color string\n      depth: 0,\n      middle: { x: 0, y: 0, z: 0 },\n      normalWorld: { x: 0, y: 0, z: 0 },\n      normalCamera: { x: 0, y: 0, z: 0 } }));\n\n\n    const shadowPolys = model.polys.map(p =&gt; ({\n      vertices: p.vIndexes.map(vIndex =&gt; shadowVertices[vIndex]),\n      wireframe: wireframe,\n      normalWorld: { x: 0, y: 0, z: 0 } }));\n\n\n    this.projected = {}; // Will store 2D projected data\n    this.model = model;\n    this.vertices = vertices;\n    this.polys = polys;\n    this.shadowVertices = shadowVertices;\n    this.shadowPolys = shadowPolys;\n    this.reset();\n  }\n\n  // Better names: resetEntity, resetTransform, resetEntityTransform\n  reset() {\n    this.x = 0;\n    this.y = 0;\n    this.z = 0;\n    this.xD = 0;\n    this.yD = 0;\n    this.zD = 0;\n\n    this.rotateX = 0;\n    this.rotateY = 0;\n    this.rotateZ = 0;\n    this.rotateXD = 0;\n    this.rotateYD = 0;\n    this.rotateZD = 0;\n\n    this.scaleX = 1;\n    this.scaleY = 1;\n    this.scaleZ = 1;\n\n    this.projected.x = 0;\n    this.projected.y = 0;\n  }\n\n  transform() {\n    transformVertices(\n    this.model.vertices,\n    this.vertices,\n    this.x,\n    this.y,\n    this.z,\n    this.rotateX,\n    this.rotateY,\n    this.rotateZ,\n    this.scaleX,\n    this.scaleY,\n    this.scaleZ);\n\n\n    copyVerticesTo(this.vertices, this.shadowVertices);\n  }\n\n  // Projects origin point, stored as `projected` property.\n  project() {\n    projectVertexTo(this, this.projected);\n  }}\n\n\n\n\n\n\n// getTarget.js\n// ============================================================================\n// ============================================================================\n\n// All active targets\nconst targets = [];\n\n// Pool target instances by color, using a Map.\n// keys are color objects, and values are arrays of targets.\n// Also pool wireframe instances separately.\nconst targetPool = new Map(allColors.map(c =&gt; [c, []]));\nconst targetWireframePool = new Map(allColors.map(c =&gt; [c, []]));\n\n\n\nconst getTarget = (() =&gt; {\n\n  const slowmoSpawner = makeSpawner({\n    chance: 0.5,\n    cooldownPerSpawn: 10000,\n    maxSpawns: 1 });\n\n\n  let doubleStrong = false;\n  const strongSpawner = makeSpawner({\n    chance: 0.3,\n    cooldownPerSpawn: 12000,\n    maxSpawns: 1 });\n\n\n  const spinnerSpawner = makeSpawner({\n    chance: 0.1,\n    cooldownPerSpawn: 10000,\n    maxSpawns: 1 });\n\n\n  // Cached array instances, no need to allocate every time.\n  const axisOptions = [\n  [&#39;x&#39;, &#39;y&#39;],\n  [&#39;y&#39;, &#39;z&#39;],\n  [&#39;z&#39;, &#39;x&#39;]];\n\n\n  function getTargetOfStyle(color, wireframe) {\n    const pool = wireframe ? targetWireframePool : targetPool;\n    let target = pool.get(color).pop();\n    if (!target) {\n      target = new Entity({\n        model: optimizeModel(makeRecursiveCubeModel({\n          recursionLevel: 1,\n          splitFn: mengerSpongeSplit,\n          scale: targetRadius })),\n\n        color: color,\n        wireframe: wireframe });\n\n\n      // Init any properties that will be used.\n      // These will not be automatically reset when recycled.\n      target.color = color;\n      target.wireframe = wireframe;\n      // Some properties don&#39;t have their final value yet.\n      // Initialize with any value of the right type.\n      target.hit = false;\n      target.maxHealth = 0;\n      target.health = 0;\n    }\n    return target;\n  }\n\n  return function getTarget() {\n    if (doubleStrong &amp;&amp; state.game.score &lt;= doubleStrongEnableScore) {\n      doubleStrong = false;\n      // Spawner is reset automatically when game resets.\n    } else if (!doubleStrong &amp;&amp; state.game.score &gt; doubleStrongEnableScore) {\n      doubleStrong = true;\n      strongSpawner.mutate({ maxSpawns: 2 });\n    }\n\n    // Target Parameters\n    // --------------------------------\n    let color = pickOne([BLUE, GREEN, ORANGE]);\n    let wireframe = false;\n    let health = 1;\n    let maxHealth = 3;\n    const spinner = state.game.cubeCount &gt;= spinnerThreshold &amp;&amp; isInGame() &amp;&amp; spinnerSpawner.shouldSpawn();\n\n    // Target Parameter Overrides\n    // --------------------------------\n    if (state.game.cubeCount &gt;= slowmoThreshold &amp;&amp; slowmoSpawner.shouldSpawn()) {\n      color = BLUE;\n      wireframe = true;\n    } else\n    if (state.game.cubeCount &gt;= strongThreshold &amp;&amp; strongSpawner.shouldSpawn()) {\n      color = PINK;\n      health = 3;\n    }\n\n    // Target Creation\n    // --------------------------------\n    const target = getTargetOfStyle(color, wireframe);\n    target.hit = false;\n    target.maxHealth = maxHealth;\n    target.health = health;\n    updateTargetHealth(target, 0);\n\n    const spinSpeeds = [\n    Math.random() * 0.1 - 0.05,\n    Math.random() * 0.1 - 0.05];\n\n\n    if (spinner) {\n      // Ends up spinning a random axis\n      spinSpeeds[0] = -0.25;\n      spinSpeeds[1] = 0;\n      target.rotateZ = random(0, TAU);\n    }\n\n    const axes = pickOne(axisOptions);\n\n    spinSpeeds.forEach((spinSpeed, i) =&gt; {\n      switch (axes[i]) {\n        case &#39;x&#39;:\n          target.rotateXD = spinSpeed;\n          break;\n        case &#39;y&#39;:\n          target.rotateYD = spinSpeed;\n          break;\n        case &#39;z&#39;:\n          target.rotateZD = spinSpeed;\n          break;}\n\n    });\n\n    return target;\n  };\n})();\n\n\nconst updateTargetHealth = (target, healthDelta) =&gt; {\n  target.health += healthDelta;\n  // Only update stroke on non-wireframe targets.\n  // Showing &quot;glue&quot; is a temporary attempt to display health. For now, there&#39;s\n  // no reason to have wireframe targets with high health, so we&#39;re fine.\n  if (!target.wireframe) {\n    const strokeWidth = target.health - 1;\n    const strokeColor = makeTargetGlueColor(target);\n    for (let p of target.polys) {\n      p.strokeWidth = strokeWidth;\n      p.strokeColor = strokeColor;\n    }\n  }\n};\n\n\nconst returnTarget = target =&gt; {\n  target.reset();\n  const pool = target.wireframe ? targetWireframePool : targetPool;\n  pool.get(target.color).push(target);\n};\n\n\nfunction resetAllTargets() {\n  while (targets.length) {\n    returnTarget(targets.pop());\n  }\n}\n\n\n\n\n\n// createBurst.js\n// ============================================================================\n// ============================================================================\n\n// Track all active fragments\nconst frags = [];\n// Pool inactive fragments by color, using a Map.\n// keys are color objects, and values are arrays of fragments.\n// // Also pool wireframe instances separately.\nconst fragPool = new Map(allColors.map(c =&gt; [c, []]));\nconst fragWireframePool = new Map(allColors.map(c =&gt; [c, []]));\n\n\nconst createBurst = (() =&gt; {\n  // Precompute some private data to be reused for all bursts.\n  const basePositions = mengerSpongeSplit({ x: 0, y: 0, z: 0 }, fragRadius * 2);\n  const positions = cloneVertices(basePositions);\n  const prevPositions = cloneVertices(basePositions);\n  const velocities = cloneVertices(basePositions);\n\n  const basePositionNormals = basePositions.map(normalize);\n  const positionNormals = cloneVertices(basePositionNormals);\n\n\n  const fragCount = basePositions.length;\n\n  function getFragForTarget(target) {\n    const pool = target.wireframe ? fragWireframePool : fragPool;\n    let frag = pool.get(target.color).pop();\n    if (!frag) {\n      frag = new Entity({\n        model: makeCubeModel({ scale: fragRadius }),\n        color: target.color,\n        wireframe: target.wireframe });\n\n      frag.color = target.color;\n      frag.wireframe = target.wireframe;\n    }\n    return frag;\n  }\n\n  return (target, force = 1) =&gt; {\n    // Calculate fragment positions, and what would have been the previous positions\n    // when still a part of the larger target.\n    transformVertices(\n    basePositions, positions,\n    target.x, target.y, target.z,\n    target.rotateX, target.rotateY, target.rotateZ,\n    1, 1, 1);\n\n    transformVertices(\n    basePositions, prevPositions,\n    target.x - target.xD, target.y - target.yD, target.z - target.zD,\n    target.rotateX - target.rotateXD, target.rotateY - target.rotateYD, target.rotateZ - target.rotateZD,\n    1, 1, 1);\n\n\n    // Compute velocity of each fragment, based on previous positions.\n    // Will write to `velocities` array.\n    for (let i = 0; i &lt; fragCount; i++) {\n      const position = positions[i];\n      const prevPosition = prevPositions[i];\n      const velocity = velocities[i];\n\n      velocity.x = position.x - prevPosition.x;\n      velocity.y = position.y - prevPosition.y;\n      velocity.z = position.z - prevPosition.z;\n    }\n\n\n\n    // Apply target rotation to normals\n    transformVertices(\n    basePositionNormals, positionNormals,\n    0, 0, 0,\n    target.rotateX, target.rotateY, target.rotateZ,\n    1, 1, 1);\n\n\n\n    for (let i = 0; i &lt; fragCount; i++) {\n      const position = positions[i];\n      const velocity = velocities[i];\n      const normal = positionNormals[i];\n\n      const frag = getFragForTarget(target);\n\n      frag.x = position.x;\n      frag.y = position.y;\n      frag.z = position.z;\n      frag.rotateX = target.rotateX;\n      frag.rotateY = target.rotateY;\n      frag.rotateZ = target.rotateZ;\n\n\n      const burstSpeed = 2 * force;\n      const randSpeed = 2 * force;\n      const rotateScale = 0.015;\n      frag.xD = velocity.x + normal.x * burstSpeed + Math.random() * randSpeed;\n      frag.yD = velocity.y + normal.y * burstSpeed + Math.random() * randSpeed;\n      frag.zD = velocity.z + normal.z * burstSpeed + Math.random() * randSpeed;\n      frag.rotateXD = frag.xD * rotateScale;\n      frag.rotateYD = frag.yD * rotateScale;\n      frag.rotateZD = frag.zD * rotateScale;\n\n      frags.push(frag);\n    };\n  };\n})();\n\n\nconst returnFrag = frag =&gt; {\n  frag.reset();\n  const pool = frag.wireframe ? fragWireframePool : fragPool;\n  pool.get(frag.color).push(frag);\n};\n\n\n\n\n\n// sparks.js\n// ============================================================================\n// ============================================================================\n\nconst sparks = [];\nconst sparkPool = [];\n\n\nfunction addSpark(x, y, xD, yD) {\n  const spark = sparkPool.pop() || {};\n\n  spark.x = x + xD * 0.5;\n  spark.y = y + yD * 0.5;\n  spark.xD = xD;\n  spark.yD = yD;\n  spark.life = random(200, 300);\n  spark.maxLife = spark.life;\n\n  sparks.push(spark);\n\n  return spark;\n}\n\n\n// Spherical spark burst\nfunction sparkBurst(x, y, count, maxSpeed) {\n  const angleInc = TAU / count;\n  for (let i = 0; i &lt; count; i++) {\n    const angle = i * angleInc + angleInc * Math.random();\n    const speed = (1 - Math.random() ** 3) * maxSpeed;\n    addSpark(\n    x,\n    y,\n    Math.sin(angle) * speed,\n    Math.cos(angle) * speed);\n\n  }\n}\n\n\n// Make a target &quot;leak&quot; sparks from all vertices.\n// This is used to create the effect of target glue &quot;shedding&quot;.\nlet glueShedVertices;\nfunction glueShedSparks(target) {\n  if (!glueShedVertices) {\n    glueShedVertices = cloneVertices(target.vertices);\n  } else {\n    copyVerticesTo(target.vertices, glueShedVertices);\n  }\n\n  glueShedVertices.forEach(v =&gt; {\n    if (Math.random() &lt; 0.4) {\n      projectVertex(v);\n      addSpark(\n      v.x,\n      v.y,\n      random(-12, 12),\n      random(-12, 12));\n\n    }\n  });\n}\n\nfunction returnSpark(spark) {\n  sparkPool.push(spark);\n}\n\n\n\n\n\n// hud.js\n// ============================================================================\n// ============================================================================\n\nconst hudContainerNode = $(&#39;.hud&#39;);\n\nfunction setHudVisibility(visible) {\n  if (visible) {\n    hudContainerNode.style.display = &#39;block&#39;;\n  } else {\n    hudContainerNode.style.display = &#39;none&#39;;\n  }\n}\n\n\n///////////\n// Score //\n///////////\nconst scoreNode = $(&#39;.score-lbl&#39;);\nconst cubeCountNode = $(&#39;.cube-count-lbl&#39;);\n\nfunction renderScoreHud() {\n  if (isCasualGame()) {\n    scoreNode.style.display = &#39;none&#39;;\n    cubeCountNode.style.opacity = 1;\n  } else {\n    scoreNode.innerText = `SCORE: ${state.game.score}`;\n    scoreNode.style.display = &#39;block&#39;;\n    cubeCountNode.style.opacity = 0.65;\n  }\n  cubeCountNode.innerText = `CUBES SMASHED: ${state.game.cubeCount}`;\n}\n\nrenderScoreHud();\n\n\n//////////////////\n// Pause Button //\n//////////////////\n\nhandlePointerDown($(&#39;.pause-btn&#39;), () =&gt; pauseGame());\n\n\n////////////////////\n// Slow-Mo Status //\n////////////////////\n\nconst slowmoNode = $(&#39;.slowmo&#39;);\nconst slowmoBarNode = $(&#39;.slowmo__bar&#39;);\n\nfunction renderSlowmoStatus(percentRemaining) {\n  slowmoNode.style.opacity = percentRemaining === 0 ? 0 : 1;\n  slowmoBarNode.style.transform = `scaleX(${percentRemaining.toFixed(3)})`;\n}\n\n\n\n\n\n// menus.js\n// ============================================================================\n// ============================================================================\n\n// Top-level menu containers\nconst menuContainerNode = $(&#39;.menus&#39;);\nconst menuMainNode = $(&#39;.menu--main&#39;);\nconst menuPauseNode = $(&#39;.menu--pause&#39;);\nconst menuScoreNode = $(&#39;.menu--score&#39;);\n\nconst finalScoreLblNode = $(&#39;.final-score-lbl&#39;);\nconst highScoreLblNode = $(&#39;.high-score-lbl&#39;);\n\n\n\nfunction showMenu(node) {\n  node.classList.add(&#39;active&#39;);\n}\n\nfunction hideMenu(node) {\n  node.classList.remove(&#39;active&#39;);\n}\n\nfunction renderMenus() {\n  hideMenu(menuMainNode);\n  hideMenu(menuPauseNode);\n  hideMenu(menuScoreNode);\n\n  switch (state.menus.active) {\n    case MENU_MAIN:\n      showMenu(menuMainNode);\n      break;\n    case MENU_PAUSE:\n      showMenu(menuPauseNode);\n      break;\n    case MENU_SCORE:\n      finalScoreLblNode.textContent = formatNumber(state.game.score);\n      if (isNewHighScore()) {\n        highScoreLblNode.textContent = &#39;New High Score!&#39;;\n      } else {\n        highScoreLblNode.textContent = `High Score: ${formatNumber(getHighScore())}`;\n      }\n      showMenu(menuScoreNode);\n      break;}\n\n\n  setHudVisibility(!isMenuVisible());\n  menuContainerNode.classList.toggle(&#39;has-active&#39;, isMenuVisible());\n  menuContainerNode.classList.toggle(&#39;interactive-mode&#39;, isMenuVisible() &amp;&amp; pointerIsDown);\n}\n\nrenderMenus();\n\n\n\n////////////////////\n// Button Actions //\n////////////////////\n\n// Main Menu\nhandleClick($(&#39;.play-normal-btn&#39;), () =&gt; {\n  setGameMode(GAME_MODE_RANKED);\n  setActiveMenu(null);\n  resetGame();\n});\n\nhandleClick($(&#39;.play-casual-btn&#39;), () =&gt; {\n  setGameMode(GAME_MODE_CASUAL);\n  setActiveMenu(null);\n  resetGame();\n});\n\n// Pause Menu\nhandleClick($(&#39;.resume-btn&#39;), () =&gt; resumeGame());\nhandleClick($(&#39;.menu-btn--pause&#39;), () =&gt; setActiveMenu(MENU_MAIN));\n\n// Score Menu\nhandleClick($(&#39;.play-again-btn&#39;), () =&gt; {\n  setActiveMenu(null);\n  resetGame();\n});\n\nhandleClick($(&#39;.menu-btn--score&#39;), () =&gt; setActiveMenu(MENU_MAIN));\n\n\n\n\n////////////////////\n// Button Actions //\n////////////////////\n\n// Main Menu\nhandleClick($(&#39;.play-normal-btn&#39;), () =&gt; {\n  setGameMode(GAME_MODE_RANKED);\n  setActiveMenu(null);\n  resetGame();\n});\n\nhandleClick($(&#39;.play-casual-btn&#39;), () =&gt; {\n  setGameMode(GAME_MODE_CASUAL);\n  setActiveMenu(null);\n  resetGame();\n});\n\n// Pause Menu\nhandleClick($(&#39;.resume-btn&#39;), () =&gt; resumeGame());\nhandleClick($(&#39;.menu-btn--pause&#39;), () =&gt; setActiveMenu(MENU_MAIN));\n\n// Score Menu\nhandleClick($(&#39;.play-again-btn&#39;), () =&gt; {\n  setActiveMenu(null);\n  resetGame();\n});\n\nhandleClick($(&#39;.menu-btn--score&#39;), () =&gt; setActiveMenu(MENU_MAIN));\n\n\n\n\n\n// actions.js\n// ============================================================================\n// ============================================================================\n\n//////////////////\n// MENU ACTIONS //\n//////////////////\n\nfunction setActiveMenu(menu) {\n  state.menus.active = menu;\n  renderMenus();\n}\n\n\n/////////////////\n// HUD ACTIONS //\n/////////////////\n\nfunction setScore(score) {\n  state.game.score = score;\n  renderScoreHud();\n}\n\nfunction incrementScore(inc) {\n  if (isInGame()) {\n    state.game.score += inc;\n    if (state.game.score &lt; 0) {\n      state.game.score = 0;\n    }\n    renderScoreHud();\n  }\n}\n\nfunction setCubeCount(count) {\n  state.game.cubeCount = count;\n  renderScoreHud();\n}\n\nfunction incrementCubeCount(inc) {\n  if (isInGame()) {\n    state.game.cubeCount += inc;\n    renderScoreHud();\n  }\n}\n\n\n//////////////////\n// GAME ACTIONS //\n//////////////////\n\nfunction setGameMode(mode) {\n  state.game.mode = mode;\n}\n\nfunction resetGame() {\n  resetAllTargets();\n  state.game.time = 0;\n  resetAllCooldowns();\n  setScore(0);\n  setCubeCount(0);\n  spawnTime = getSpawnDelay();\n}\n\nfunction pauseGame() {\n  isInGame() &amp;&amp; setActiveMenu(MENU_PAUSE);\n}\n\nfunction resumeGame() {\n  isPaused() &amp;&amp; setActiveMenu(null);\n}\n\nfunction endGame() {\n  handleCanvasPointerUp();\n  if (isNewHighScore()) {\n    setHighScore(state.game.score);\n  }\n  setActiveMenu(MENU_SCORE);\n}\n\n\n\n////////////////////////\n// KEYBOARD SHORTCUTS //\n////////////////////////\n\nwindow.addEventListener(&#39;keydown&#39;, event =&gt; {\n  if (event.key === &#39;p&#39;) {\n    isPaused() ? resumeGame() : pauseGame();\n  }\n});\n\n\n\n\n\n\n// tick.js\n// ============================================================================\n// ============================================================================\n\n\nlet spawnTime = 0;\nconst maxSpawnX = 450;\nconst pointerDelta = { x: 0, y: 0 };\nconst pointerDeltaScaled = { x: 0, y: 0 };\n\n// Temp slowmo state. Should be relocated once this stabilizes.\nconst slowmoDuration = 1500;\nlet slowmoRemaining = 0;\nlet spawnExtra = 0;\nconst spawnExtraDelay = 300;\nlet targetSpeed = 1;\n\n\nfunction tick(width, height, simTime, simSpeed, lag) {\n  PERF_START(&#39;frame&#39;);\n  PERF_START(&#39;tick&#39;);\n\n  state.game.time += simTime;\n\n  if (slowmoRemaining &gt; 0) {\n    slowmoRemaining -= simTime;\n    if (slowmoRemaining &lt; 0) {\n      slowmoRemaining = 0;\n    }\n    targetSpeed = pointerIsDown ? 0.075 : 0.3;\n  } else {\n    const menuPointerDown = isMenuVisible() &amp;&amp; pointerIsDown;\n    targetSpeed = menuPointerDown ? 0.025 : 1;\n  }\n\n  renderSlowmoStatus(slowmoRemaining / slowmoDuration);\n\n  gameSpeed += (targetSpeed - gameSpeed) / 22 * lag;\n  gameSpeed = clamp(gameSpeed, 0, 1);\n\n  const centerX = width / 2;\n  const centerY = height / 2;\n\n  const simAirDrag = 1 - airDrag * simSpeed;\n  const simAirDragSpark = 1 - airDragSpark * simSpeed;\n\n  // Pointer Tracking\n  // -------------------\n\n  // Compute speed and x/y deltas.\n  // There is also a &quot;scaled&quot; variant taking game speed into account. This serves two purposes:\n  //  - Lag won&#39;t create large spikes in speed/deltas\n  //  - In slow mo, speed is increased proportionately to match &quot;reality&quot;. Without this boost,\n  //    it feels like your actions are dampened in slow mo.\n  const forceMultiplier = 1 / (simSpeed * 0.75 + 0.25);\n  pointerDelta.x = 0;\n  pointerDelta.y = 0;\n  pointerDeltaScaled.x = 0;\n  pointerDeltaScaled.y = 0;\n  const lastPointer = touchPoints[touchPoints.length - 1];\n\n  if (pointerIsDown &amp;&amp; lastPointer &amp;&amp; !lastPointer.touchBreak) {\n    pointerDelta.x = pointerScene.x - lastPointer.x;\n    pointerDelta.y = pointerScene.y - lastPointer.y;\n    pointerDeltaScaled.x = pointerDelta.x * forceMultiplier;\n    pointerDeltaScaled.y = pointerDelta.y * forceMultiplier;\n  }\n  const pointerSpeed = Math.hypot(pointerDelta.x, pointerDelta.y);\n  const pointerSpeedScaled = pointerSpeed * forceMultiplier;\n\n  // Track points for later calculations, including drawing trail.\n  touchPoints.forEach(p =&gt; p.life -= simTime);\n\n  if (pointerIsDown) {\n    touchPoints.push({\n      x: pointerScene.x,\n      y: pointerScene.y,\n      life: touchPointLife });\n\n  }\n\n  while (touchPoints[0] &amp;&amp; touchPoints[0].life &lt;= 0) {\n    touchPoints.shift();\n  }\n\n\n  // Entity Manipulation\n  // --------------------\n  PERF_START(&#39;entities&#39;);\n\n  // Spawn targets\n  spawnTime -= simTime;\n  if (spawnTime &lt;= 0) {\n    if (spawnExtra &gt; 0) {\n      spawnExtra--;\n      spawnTime = spawnExtraDelay;\n    } else {\n      spawnTime = getSpawnDelay();\n    }\n    const target = getTarget();\n    const spawnRadius = Math.min(centerX * 0.8, maxSpawnX);\n    target.x = Math.random() * spawnRadius * 2 - spawnRadius;\n    target.y = centerY + targetHitRadius * 2;\n    target.z = Math.random() * targetRadius * 2 - targetRadius;\n    target.xD = Math.random() * (target.x * -2 / 120);\n    target.yD = -20;\n    targets.push(target);\n  }\n\n  // Animate targets and remove when offscreen\n  const leftBound = -centerX + targetRadius;\n  const rightBound = centerX - targetRadius;\n  const ceiling = -centerY - 120;\n  const boundDamping = 0.4;\n\n  targetLoop:\n  for (let i = targets.length - 1; i &gt;= 0; i--) {\n    const target = targets[i];\n    target.x += target.xD * simSpeed;\n    target.y += target.yD * simSpeed;\n\n    if (target.y &lt; ceiling) {\n      target.y = ceiling;\n      target.yD = 0;\n    }\n\n    if (target.x &lt; leftBound) {\n      target.x = leftBound;\n      target.xD *= -boundDamping;\n    } else if (target.x &gt; rightBound) {\n      target.x = rightBound;\n      target.xD *= -boundDamping;\n    }\n\n    if (target.z &lt; backboardZ) {\n      target.z = backboardZ;\n      target.zD *= -boundDamping;\n    }\n\n    target.yD += gravity * simSpeed;\n    target.rotateX += target.rotateXD * simSpeed;\n    target.rotateY += target.rotateYD * simSpeed;\n    target.rotateZ += target.rotateZD * simSpeed;\n    target.transform();\n    target.project();\n\n    // Remove if offscreen\n    if (target.y &gt; centerY + targetHitRadius * 2) {\n      targets.splice(i, 1);\n      returnTarget(target);\n      if (isInGame()) {\n        if (isCasualGame()) {\n          incrementScore(-25);\n        } else {\n          endGame();\n        }\n      }\n      continue;\n    }\n\n\n    // If pointer is moving really fast, we want to hittest multiple points along the path.\n    // We can&#39;t use scaled pointer speed to determine this, since we care about actual screen\n    // distance covered.\n    const hitTestCount = Math.ceil(pointerSpeed / targetRadius * 2);\n    // Start loop at `1` and use `&lt;=` check, so we skip 0% and end up at 100%.\n    // This omits the previous point position, and includes the most recent.\n    for (let ii = 1; ii &lt;= hitTestCount; ii++) {\n      const percent = 1 - ii / hitTestCount;\n      const hitX = pointerScene.x - pointerDelta.x * percent;\n      const hitY = pointerScene.y - pointerDelta.y * percent;\n      const distance = Math.hypot(\n      hitX - target.projected.x,\n      hitY - target.projected.y);\n\n\n      if (distance &lt;= targetHitRadius) {\n        // Hit! (though we don&#39;t want to allow hits on multiple sequential frames)\n        if (!target.hit) {\n          target.hit = true;\n\n          target.xD += pointerDeltaScaled.x * hitDampening;\n          target.yD += pointerDeltaScaled.y * hitDampening;\n          target.rotateXD += pointerDeltaScaled.y * 0.001;\n          target.rotateYD += pointerDeltaScaled.x * 0.001;\n\n          const sparkSpeed = 7 + pointerSpeedScaled * 0.125;\n\n          if (pointerSpeedScaled &gt; minPointerSpeed) {\n            target.health--;\n            incrementScore(10);\n\n            if (target.health &lt;= 0) {\n              incrementCubeCount(1);\n              createBurst(target, forceMultiplier);\n              sparkBurst(hitX, hitY, 8, sparkSpeed);\n              if (target.wireframe) {\n                slowmoRemaining = slowmoDuration;\n                spawnTime = 0;\n                spawnExtra = 2;\n              }\n              targets.splice(i, 1);\n              returnTarget(target);\n            } else {\n              sparkBurst(hitX, hitY, 8, sparkSpeed);\n              glueShedSparks(target);\n              updateTargetHealth(target, 0);\n            }\n          } else {\n            incrementScore(5);\n            sparkBurst(hitX, hitY, 3, sparkSpeed);\n          }\n        }\n        // Break the current loop and continue the outer loop.\n        // This skips to processing the next target.\n        continue targetLoop;\n      }\n    }\n\n    // This code will only run if target hasn&#39;t been &quot;hit&quot;.\n    target.hit = false;\n  }\n\n  // Animate fragments and remove when offscreen.\n  const fragBackboardZ = backboardZ + fragRadius;\n  // Allow fragments to move off-screen to sides for a while, since shadows are still visible.\n  const fragLeftBound = -width;\n  const fragRightBound = width;\n\n  for (let i = frags.length - 1; i &gt;= 0; i--) {\n    const frag = frags[i];\n    frag.x += frag.xD * simSpeed;\n    frag.y += frag.yD * simSpeed;\n    frag.z += frag.zD * simSpeed;\n\n    frag.xD *= simAirDrag;\n    frag.yD *= simAirDrag;\n    frag.zD *= simAirDrag;\n\n    if (frag.y &lt; ceiling) {\n      frag.y = ceiling;\n      frag.yD = 0;\n    }\n\n    if (frag.z &lt; fragBackboardZ) {\n      frag.z = fragBackboardZ;\n      frag.zD *= -boundDamping;\n    }\n\n    frag.yD += gravity * simSpeed;\n    frag.rotateX += frag.rotateXD * simSpeed;\n    frag.rotateY += frag.rotateYD * simSpeed;\n    frag.rotateZ += frag.rotateZD * simSpeed;\n    frag.transform();\n    frag.project();\n\n    // Removal conditions\n    if (\n    // Bottom of screen\n    frag.projected.y &gt; centerY + targetHitRadius ||\n    // Sides of screen\n    frag.projected.x &lt; fragLeftBound ||\n    frag.projected.x &gt; fragRightBound ||\n    // Too close to camera\n    frag.z &gt; cameraFadeEndZ)\n    {\n      frags.splice(i, 1);\n      returnFrag(frag);\n      continue;\n    }\n  }\n\n  // 2D sparks\n  for (let i = sparks.length - 1; i &gt;= 0; i--) {\n    const spark = sparks[i];\n    spark.life -= simTime;\n    if (spark.life &lt;= 0) {\n      sparks.splice(i, 1);\n      returnSpark(spark);\n      continue;\n    }\n    spark.x += spark.xD * simSpeed;\n    spark.y += spark.yD * simSpeed;\n    spark.xD *= simAirDragSpark;\n    spark.yD *= simAirDragSpark;\n    spark.yD += gravity * simSpeed;\n  }\n\n  PERF_END(&#39;entities&#39;);\n\n  // 3D transforms\n  // -------------------\n\n  PERF_START(&#39;3D&#39;);\n\n  // Aggregate all scene vertices/polys\n  allVertices.length = 0;\n  allPolys.length = 0;\n  allShadowVertices.length = 0;\n  allShadowPolys.length = 0;\n  targets.forEach(entity =&gt; {\n    allVertices.push(...entity.vertices);\n    allPolys.push(...entity.polys);\n    allShadowVertices.push(...entity.shadowVertices);\n    allShadowPolys.push(...entity.shadowPolys);\n  });\n\n  frags.forEach(entity =&gt; {\n    allVertices.push(...entity.vertices);\n    allPolys.push(...entity.polys);\n    allShadowVertices.push(...entity.shadowVertices);\n    allShadowPolys.push(...entity.shadowPolys);\n  });\n\n  // Scene calculations/transformations\n  allPolys.forEach(p =&gt; computePolyNormal(p, &#39;normalWorld&#39;));\n  allPolys.forEach(computePolyDepth);\n  allPolys.sort((a, b) =&gt; b.depth - a.depth);\n\n  // Perspective projection\n  allVertices.forEach(projectVertex);\n\n  allPolys.forEach(p =&gt; computePolyNormal(p, &#39;normalCamera&#39;));\n\n  PERF_END(&#39;3D&#39;);\n\n  PERF_START(&#39;shadows&#39;);\n\n  // Rotate shadow vertices to light source perspective\n  transformVertices(\n  allShadowVertices,\n  allShadowVertices,\n  0, 0, 0,\n  TAU / 8, 0, 0,\n  1, 1, 1);\n\n\n  allShadowPolys.forEach(p =&gt; computePolyNormal(p, &#39;normalWorld&#39;));\n\n  const shadowDistanceMult = Math.hypot(1, 1);\n  const shadowVerticesLength = allShadowVertices.length;\n  for (let i = 0; i &lt; shadowVerticesLength; i++) {\n    const distance = allVertices[i].z - backboardZ;\n    allShadowVertices[i].z -= shadowDistanceMult * distance;\n  }\n  transformVertices(\n  allShadowVertices,\n  allShadowVertices,\n  0, 0, 0,\n  -TAU / 8, 0, 0,\n  1, 1, 1);\n\n  allShadowVertices.forEach(projectVertex);\n\n  PERF_END(&#39;shadows&#39;);\n\n  PERF_END(&#39;tick&#39;);\n}\n\n\n\n\n\n// draw.js\n// ============================================================================\n// ============================================================================\n\nfunction draw(ctx, width, height, viewScale) {\n  PERF_START(&#39;draw&#39;);\n\n  const halfW = width / 2;\n  const halfH = height / 2;\n\n\n  // 3D Polys\n  // ---------------\n  ctx.lineJoin = &#39;bevel&#39;;\n\n  PERF_START(&#39;drawShadows&#39;);\n  ctx.fillStyle = shadowColor;\n  ctx.strokeStyle = shadowColor;\n  allShadowPolys.forEach(p =&gt; {\n    if (p.wireframe) {\n      ctx.lineWidth = 2;\n      ctx.beginPath();\n      const { vertices } = p;\n      const vCount = vertices.length;\n      const firstV = vertices[0];\n      ctx.moveTo(firstV.x, firstV.y);\n      for (let i = 1; i &lt; vCount; i++) {\n        const v = vertices[i];\n        ctx.lineTo(v.x, v.y);\n      }\n      ctx.closePath();\n      ctx.stroke();\n    } else {\n      ctx.beginPath();\n      const { vertices } = p;\n      const vCount = vertices.length;\n      const firstV = vertices[0];\n      ctx.moveTo(firstV.x, firstV.y);\n      for (let i = 1; i &lt; vCount; i++) {\n        const v = vertices[i];\n        ctx.lineTo(v.x, v.y);\n      }\n      ctx.closePath();\n      ctx.fill();\n    }\n  });\n  PERF_END(&#39;drawShadows&#39;);\n\n  PERF_START(&#39;drawPolys&#39;);\n\n  allPolys.forEach(p =&gt; {\n    if (!p.wireframe &amp;&amp; p.normalCamera.z &lt; 0) return;\n\n    if (p.strokeWidth !== 0) {\n      ctx.lineWidth = p.normalCamera.z &lt; 0 ? p.strokeWidth * 0.5 : p.strokeWidth;\n      ctx.strokeStyle = p.normalCamera.z &lt; 0 ? p.strokeColorDark : p.strokeColor;\n    }\n\n    const { vertices } = p;\n    const lastV = vertices[vertices.length - 1];\n    const fadeOut = p.middle.z &gt; cameraFadeStartZ;\n\n    if (!p.wireframe) {\n      const normalLight = p.normalWorld.y * 0.5 + p.normalWorld.z * -0.5;\n      const lightness = normalLight &gt; 0 ?\n      0.1 :\n      (normalLight ** 32 - normalLight) / 2 * 0.9 + 0.1;\n      ctx.fillStyle = shadeColor(p.color, lightness);\n    }\n\n    // Fade out polys close to camera. `globalAlpha` must be reset later.\n    if (fadeOut) {\n      // If polygon gets really close to camera (outside `cameraFadeRange`) the alpha\n      // can go negative, which has the appearance of alpha = 1. So, we&#39;ll clamp it at 0.\n      ctx.globalAlpha = Math.max(0, 1 - (p.middle.z - cameraFadeStartZ) / cameraFadeRange);\n    }\n\n    ctx.beginPath();\n    ctx.moveTo(lastV.x, lastV.y);\n    for (let v of vertices) {\n      ctx.lineTo(v.x, v.y);\n    }\n\n    if (!p.wireframe) {\n      ctx.fill();\n    }\n    if (p.strokeWidth !== 0) {\n      ctx.stroke();\n    }\n\n    if (fadeOut) {\n      ctx.globalAlpha = 1;\n    }\n  });\n  PERF_END(&#39;drawPolys&#39;);\n\n\n  PERF_START(&#39;draw2D&#39;);\n\n  // 2D Sparks\n  // ---------------\n  ctx.strokeStyle = sparkColor;\n  ctx.lineWidth = sparkThickness;\n  ctx.beginPath();\n  sparks.forEach(spark =&gt; {\n    ctx.moveTo(spark.x, spark.y);\n    // Shrink sparks to zero length as they die.\n    // Speed up shrinking as life approaches 0 (root curve).\n    // Note that sparks already get smaller over time as their speed slows\n    // down from damping. So this is like a double scale down. To counter this\n    // a bit and keep the sparks larger for longer, we&#39;ll also increase the scale\n    // a bit after applying the root curve.\n    const scale = (spark.life / spark.maxLife) ** 0.5 * 1.5;\n    ctx.lineTo(spark.x - spark.xD * scale, spark.y - spark.yD * scale);\n\n  });\n  ctx.stroke();\n\n\n  // Touch Strokes\n  // ---------------\n\n  ctx.strokeStyle = touchTrailColor;\n  const touchPointCount = touchPoints.length;\n  for (let i = 1; i &lt; touchPointCount; i++) {\n    const current = touchPoints[i];\n    const prev = touchPoints[i - 1];\n    if (current.touchBreak || prev.touchBreak) {\n      continue;\n    }\n    const scale = current.life / touchPointLife;\n    ctx.lineWidth = scale * touchTrailThickness;\n    ctx.beginPath();\n    ctx.moveTo(prev.x, prev.y);\n    ctx.lineTo(current.x, current.y);\n    ctx.stroke();\n  }\n\n  PERF_END(&#39;draw2D&#39;);\n\n  PERF_END(&#39;draw&#39;);\n  PERF_END(&#39;frame&#39;);\n\n  // Display performance updates.\n  PERF_UPDATE();\n}\n\n\n\n\n\n// canvas.js\n// ============================================================================\n// ============================================================================\n\nfunction setupCanvases() {\n  const ctx = canvas.getContext(&#39;2d&#39;);\n  // devicePixelRatio alias\n  const dpr = window.devicePixelRatio || 1;\n  // View will be scaled so objects appear sized similarly on all screen sizes.\n  let viewScale;\n  // Dimensions (taking viewScale into account!)\n  let width, height;\n\n  function handleResize() {\n    const w = window.innerWidth;\n    const h = window.innerHeight;\n    viewScale = h / 1000;\n    width = w / viewScale;\n    height = h / viewScale;\n    canvas.width = w * dpr;\n    canvas.height = h * dpr;\n    canvas.style.width = w + &#39;px&#39;;\n    canvas.style.height = h + &#39;px&#39;;\n  }\n\n  // Set initial size\n  handleResize();\n  // resize fullscreen canvas\n  window.addEventListener(&#39;resize&#39;, handleResize);\n\n\n  // Run game loop\n  let lastTimestamp = 0;\n  function frameHandler(timestamp) {\n    let frameTime = timestamp - lastTimestamp;\n    lastTimestamp = timestamp;\n\n    // always queue another frame\n    raf();\n\n    // If game is paused, we&#39;ll still track frameTime (above) but all other\n    // game logic and drawing can be avoided.\n    if (isPaused()) return;\n\n    // make sure negative time isn&#39;t reported (first frame can be whacky)\n    if (frameTime &lt; 0) {\n      frameTime = 17;\n    }\n    // - cap minimum framerate to 15fps[~68ms] (assuming 60fps[~17ms] as &#39;normal&#39;)\n    else if (frameTime &gt; 68) {\n        frameTime = 68;\n      }\n\n    const halfW = width / 2;\n    const halfH = height / 2;\n\n    // Convert pointer position from screen to scene coords.\n    pointerScene.x = pointerScreen.x / viewScale - halfW;\n    pointerScene.y = pointerScreen.y / viewScale - halfH;\n\n    const lag = frameTime / 16.6667;\n    const simTime = gameSpeed * frameTime;\n    const simSpeed = gameSpeed * lag;\n    tick(width, height, simTime, simSpeed, lag);\n\n    // Auto clear canvas\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    // Auto scale drawing for high res displays, and incorporate `viewScale`.\n    // Also shift canvas so (0, 0) is the middle of the screen.\n    // This just works with 3D perspective projection.\n    const drawScale = dpr * viewScale;\n    ctx.scale(drawScale, drawScale);\n    ctx.translate(halfW, halfH);\n    draw(ctx, width, height, viewScale);\n    ctx.setTransform(1, 0, 0, 1, 0, 0);\n  }\n  const raf = () =&gt; requestAnimationFrame(frameHandler);\n  // Start loop\n  raf();\n}\n\n\n\n\n\n// interaction.js\n// ============================================================================\n// ============================================================================\n\n// Interaction\n// -----------------------------\n\nfunction handleCanvasPointerDown(x, y) {\n  if (!pointerIsDown) {\n    pointerIsDown = true;\n    pointerScreen.x = x;\n    pointerScreen.y = y;\n    // On when menus are open, point down/up toggles an interactive mode.\n    // We just need to rerender the menu system for it to respond.\n    if (isMenuVisible()) renderMenus();\n  }\n}\n\nfunction handleCanvasPointerUp() {\n  if (pointerIsDown) {\n    pointerIsDown = false;\n    touchPoints.push({\n      touchBreak: true,\n      life: touchPointLife });\n\n    // On when menus are open, point down/up toggles an interactive mode.\n    // We just need to rerender the menu system for it to respond.\n    if (isMenuVisible()) renderMenus();\n  }\n}\n\nfunction handleCanvasPointerMove(x, y) {\n  if (pointerIsDown) {\n    pointerScreen.x = x;\n    pointerScreen.y = y;\n  }\n}\n\n\n// Use pointer events if available, otherwise fallback to touch events (for iOS).\nif (&#39;PointerEvent&#39; in window) {\n  canvas.addEventListener(&#39;pointerdown&#39;, event =&gt; {\n    event.isPrimary &amp;&amp; handleCanvasPointerDown(event.clientX, event.clientY);\n  });\n\n  canvas.addEventListener(&#39;pointerup&#39;, event =&gt; {\n    event.isPrimary &amp;&amp; handleCanvasPointerUp();\n  });\n\n  canvas.addEventListener(&#39;pointermove&#39;, event =&gt; {\n    event.isPrimary &amp;&amp; handleCanvasPointerMove(event.clientX, event.clientY);\n  });\n\n  // We also need to know if the mouse leaves the page. For this game, it&#39;s best if that\n  // cancels a swipe, so essentially acts as a &quot;mouseup&quot; event.\n  document.body.addEventListener(&#39;mouseleave&#39;, handleCanvasPointerUp);\n} else {\n  let activeTouchId = null;\n  canvas.addEventListener(&#39;touchstart&#39;, event =&gt; {\n    if (!pointerIsDown) {\n      const touch = event.changedTouches[0];\n      activeTouchId = touch.identifier;\n      handleCanvasPointerDown(touch.clientX, touch.clientY);\n    }\n  });\n  canvas.addEventListener(&#39;touchend&#39;, event =&gt; {\n    for (let touch of event.changedTouches) {\n      if (touch.identifier === activeTouchId) {\n        handleCanvasPointerUp();\n        break;\n      }\n    }\n  });\n  canvas.addEventListener(&#39;touchmove&#39;, event =&gt; {\n    for (let touch of event.changedTouches) {\n      if (touch.identifier === activeTouchId) {\n        handleCanvasPointerMove(touch.clientX, touch.clientY);\n        event.preventDefault();\n        break;\n      }\n    }\n  }, { passive: false });\n}\n\n\n\n\n\n// index.js\n// ============================================================================\n// ============================================================================\n\nsetupCanvases();"};
    __preprocessorNames = {
      "html": "HTML",
      "css": "CSS",
      "js": "JS"
    };
    __pageType = "embed";
    __editable = false;
    __embed_prefill = false;
    __env = "production";
  </script>
<script src="./embed-74056a7aa6eaff0b2edbead837ec13362b0601c0efa24e00ede7f8b9b205b7fa.js.download"></script>


</body></html>